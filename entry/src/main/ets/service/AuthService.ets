import { HttpUtil } from '../common/utils/HttpUtil';
import { PreferencesUtil } from '../common/utils/PreferencesUtil';
import { WebSocketService } from './WebSocketService';
import { SendCodeDTO, UserLoginDTO, UserLoginVO, UserInfoVO } from '../model/entity/LoginModel';

/**
 * è®¤è¯ä¸šåŠ¡
 */
export class AuthService {
  // ğŸ”— æ¥å£åœ°å€å¸¸é‡ (Cç«¯æ¥å£)
  private static readonly SEND_CODE_URL = '/client/user/code';
  private static readonly LOGIN_URL = '/client/user/login';
  private static readonly USER_INFO_URL = '/client/user/info';
  private static readonly LOGOUT_URL = '/client/user/logout';

  /**
   * ğŸ“¨ å‘é€éªŒè¯ç 
   */
  static async sendVerifyCode(phone: string): Promise<string | null> {
    try {
      const dto = new SendCodeDTO(phone);
      const code = await HttpUtil.post<string>(AuthService.SEND_CODE_URL, dto);
      console.info(`åç«¯è¿”å›çš„éªŒè¯ç æ˜¯: ${code}`);
      return code;
    } catch (err) {
      console.error('å‘é€éªŒè¯ç å¤±è´¥');
      return null;
    }
  }

  /**
   * ğŸ” ç”¨æˆ·ç™»å½•
   */
  static async login(dto: UserLoginDTO): Promise<boolean> {
    try {
      const data = await HttpUtil.post<UserLoginVO>(AuthService.LOGIN_URL, dto);

      if (data && data.token) {
        // âœ… 1. æŒä¹…åŒ–ä¿å­˜ Token å’Œ UserID
        await PreferencesUtil.saveToken(data.token);
        await PreferencesUtil.saveUserId(data.id);

        // âœ… 2. æ›´æ–°å†…å­˜ Token
        AppStorage.setOrCreate('token', data.token);
        AppStorage.setOrCreate('userId', data.id);

        // âœ… 3. è¿æ¥ WebSocket
        WebSocketService.getInstance().connect(data.id, '192.168.0.210:8080');

        return true;
      }
      return false;
    } catch (err) {
      return false;
    }
  }

  /**
   * ğŸ‘¤ è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
   */
  static async getUserInfo(): Promise<UserInfoVO | null> {
    try {
      return await HttpUtil.get<UserInfoVO>(AuthService.USER_INFO_URL);
    } catch (err) {
      console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥å–µ', err);
      return null;
    }
  }

  /**
   * ğŸšª é€€å‡ºç™»å½•
   */
  static async logout() {
    try {
      // 1. é€šçŸ¥åç«¯é”€æ¯ Token
      // âœ¨ ä¿®æ­£ï¼šä½¿ç”¨ Record ç±»å‹æ˜ç¡®ç©ºå¯¹è±¡çš„ç±»å‹ï¼Œç»•è¿‡ ArkTS æ£€æŸ¥
      const emptyBody: Record<string, string> = {};
      await HttpUtil.post<string>(AuthService.LOGOUT_URL, emptyBody);
      console.info('å–µï¼åç«¯ Session å·²é”€æ¯');
    } catch (err) {
      console.warn('å–µï¼åç«¯é€€å‡ºé€šçŸ¥å¤±è´¥ï¼Œå¯èƒ½ Token å·²è¿‡æœŸï¼Œç»§ç»­æ¸…ç†æœ¬åœ°æ•°æ®', err);
    } finally {
      // 2. æ¸…ç†æœ¬åœ°æŒä¹…åŒ–æ•°æ®
      await PreferencesUtil.deleteToken();
      // 3. æ¸…ç†å†…å­˜çŠ¶æ€
      AppStorage.delete('token');
      AppStorage.delete('userId');
      // 4. æ–­å¼€ WebSocket
      WebSocketService.getInstance().close();
      console.info('å–µï¼æœ¬åœ°ç™»å½•æ•°æ®å·²æ¸…ç†ï¼ŒWS å·²æ–­å¼€');
    }
  }
}