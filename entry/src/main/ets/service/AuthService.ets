import { HttpUtil } from '../common/utils/HttpUtil';
import { PreferencesUtil } from '../common/utils/PreferencesUtil';
import { SendCodeDTO, UserLoginDTO, UserLoginVO } from '../model/entity/LoginModel';

/**
 * è®¤è¯ä¸šåŠ¡
 */
export class AuthService {
  // ğŸ”— æ¥å£åœ°å€å¸¸é‡ (Cç«¯æ¥å£)
  private static readonly SEND_CODE_URL = '/client/user/code';
  private static readonly LOGIN_URL = '/client/user/login';

  /**
   * ğŸ“¨ å‘é€éªŒè¯ç  (å¹¶è·å–åç«¯è¿”å›çš„ Code ç”¨äºæ¨¡æ‹Ÿ)
   * @param phone æ‰‹æœºå·
   * @returns string | null å¦‚æœæˆåŠŸè¿”å›éªŒè¯ç ï¼Œå¤±è´¥è¿”å› null
   */
  static async sendVerifyCode(phone: string): Promise<string | null> {
    try {
      // å‡è®¾æ¥å£åªéœ€è¦ä¼  phone å‚æ•° (åç«¯å¯èƒ½ç”¨ @RequestParam æˆ– @RequestBody)
      // å¦‚æœåç«¯éœ€è¦å¯¹è±¡: { phone: phone }
      // è¿™é‡Œæ³›å‹ <string> è¡¨ç¤ºåç«¯ data ç›´æ¥è¿”å›äº†éªŒè¯ç å­—ç¬¦ä¸²
      const dto = new SendCodeDTO(phone);
      const code = await HttpUtil.post<string>(AuthService.SEND_CODE_URL, dto);

      console.info(`åç«¯è¿”å›çš„éªŒè¯ç æ˜¯: ${code}`);
      return code;
    } catch (err) {
      console.error('å‘é€éªŒè¯ç å¤±è´¥');
      return null;
    }
  }

  /**
   * ğŸ” ç”¨æˆ·ç™»å½•
   */
  static async login(dto: UserLoginDTO): Promise<boolean> {
    try {
      // å‘é€ç™»å½•è¯·æ±‚
      const data = await HttpUtil.post<UserLoginVO>(AuthService.LOGIN_URL, dto);

      if (data && data.token) {
        // âœ… 1. æŒä¹…åŒ–ä¿å­˜ Token
        await PreferencesUtil.saveToken(data.token);

        // âœ… 2. æ›´æ–°å†…å­˜ Token (æ‹¦æˆªå™¨ç”¨)
        AppStorage.setOrCreate('token', data.token);

        // âœ… 3. ä¿å­˜ç”¨æˆ· ID (å¯é€‰ï¼Œåç»­ä¸šåŠ¡å¯èƒ½ç”¨)
        AppStorage.setOrCreate('userId', data.id);

        return true;
      }
      return false;
    } catch (err) {
      return false; // é”™è¯¯ä¿¡æ¯ HttpUtil å·²ç»å¼¹è¿‡äº†
    }
  }
}