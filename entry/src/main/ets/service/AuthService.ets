import { HttpUtil } from '../common/utils/HttpUtil';
import { PreferencesUtil } from '../common/utils/PreferencesUtil';
import { WebSocketService } from './WebSocketService';
import { SendCodeDTO, UserLoginDTO, UserLoginVO } from '../model/entity/LoginModel';

/**
 * è®¤è¯ä¸šåŠ¡
 */
export class AuthService {
  // ğŸ”— æ¥å£åœ°å€å¸¸é‡ (Cç«¯æ¥å£)
  private static readonly SEND_CODE_URL = '/client/user/code';
  private static readonly LOGIN_URL = '/client/user/login';

  /**
   * ğŸ“¨ å‘é€éªŒè¯ç 
   */
  static async sendVerifyCode(phone: string): Promise<string | null> {
    try {
      const dto = new SendCodeDTO(phone);
      const code = await HttpUtil.post<string>(AuthService.SEND_CODE_URL, dto);
      console.info(`åç«¯è¿”å›çš„éªŒè¯ç æ˜¯: ${code}`);
      return code;
    } catch (err) {
      console.error('å‘é€éªŒè¯ç å¤±è´¥');
      return null;
    }
  }

  /**
   * ğŸ” ç”¨æˆ·ç™»å½•
   */
  static async login(dto: UserLoginDTO): Promise<boolean> {
    try {
      const data = await HttpUtil.post<UserLoginVO>(AuthService.LOGIN_URL, dto);

      if (data && data.token) {
        // âœ… 1. æŒä¹…åŒ–ä¿å­˜ Token å’Œ UserID
        await PreferencesUtil.saveToken(data.token);
        await PreferencesUtil.saveUserId(data.id);

        // âœ… 2. æ›´æ–°å†…å­˜ Token
        AppStorage.setOrCreate('token', data.token);
        AppStorage.setOrCreate('userId', data.id);

        // âœ… 3. è¿æ¥ WebSocket (ä½¿ç”¨å®¿ä¸»æœºIP)
        WebSocketService.getInstance().connect(data.id, '10.0.2.2:8080');

        return true;
      }
      return false;
    } catch (err) {
      return false;
    }
  }
}
