/**
 * å•†åº—ä¸šåŠ¡
 */
import { HttpUtil } from '../common/utils/HttpUtil';
// å¤ç”¨æˆ‘ä»¬ä¹‹å‰å®šä¹‰çš„èšåˆç±»
import { CategoryWithDishes } from '../model/entity/MockData';
import { CategoryVO, DishVO } from '../model/entity/ShopModel';

export class ShopService {
  // ğŸ”— æ¥å£åœ°å€
  private static readonly CAT_URL = '/client/category';
  private static readonly DISH_URL = '/client/dish';
  private static readonly SHOP_STATUS_URL = '/client/shop/status';

  /**
   * 0ï¸âƒ£ è·å–åº—é“ºè¥ä¸šçŠ¶æ€
   */
  static async getShopStatus(): Promise<number> {
    try {
      const status = await HttpUtil.get<number>(ShopService.SHOP_STATUS_URL);
      return status;
    } catch (e) {
      console.error('è·å–åº—é“ºçŠ¶æ€å¤±è´¥å–µ', JSON.stringify(e));
      return 0; // é»˜è®¤è¿”å›ä¼‘æ¯ä¸­
    }
  }

  /**
   * 1ï¸âƒ£ è·å–åˆ†ç±»åˆ—è¡¨
   */
  static async getCategoryList(): Promise<CategoryVO[]> {
    try {
      const url = `${ ShopService.CAT_URL }/1`;
      // type=1 è¡¨ç¤ºèœå“åˆ†ç±» (type=2æ˜¯å¥—é¤ï¼Œæš‚æ—¶åªçœ‹èœå“)
      const list = await HttpUtil.get<CategoryVO[]>(url);
      return list || [];
    } catch ( err ) {
      console.error('è·å–åˆ†ç±»å¤±è´¥');
      return [];
    }
  }

  /**
   * 2ï¸âƒ£ è·å–æŸåˆ†ç±»ä¸‹çš„èœå“
   */
  static async getDishList(categoryId: number): Promise<DishVO[]> {
    try {
      const url = `${ ShopService.DISH_URL }/${ categoryId }`;
      const list = await HttpUtil.get<DishVO[]>(url);
      return list || [];
    } catch ( err ) {
      console.error(`è·å–åˆ†ç±» ${ categoryId } çš„èœå“å¤±è´¥å–µ`);
      return []; // å¤±è´¥è¿”å›ç©ºæ•°ç»„ï¼Œä¸å½±å“å…¶ä»–åˆ†ç±»æ˜¾ç¤º
    }
  }

  /**
   * ğŸš€ 3ï¸âƒ£ ã€æ ¸å¿ƒå¤§æ‹›ã€‘è·å–å…¨åº—æ•°æ® (åˆ†ç±» + èœå“) å¹¶ç»„è£…
   * ä¾› UI å±‚ç›´æ¥è°ƒç”¨ï¼Œæ‹¿åˆ°å°±æ˜¯èƒ½ç”¨çš„ç»“æ„ï¼
   */
  static async getShopData(): Promise<CategoryWithDishes[]> {
    // A. å…ˆæ‹¿æ‰€æœ‰åˆ†ç±»
    const categories = await ShopService.getCategoryList();
    if ( categories.length === 0 ) {
      return [];
    }

    // B. å¹¶å‘è¯·æ±‚ï¼šåŒæ—¶å»æ‹¿æ¯ä¸€ä¸ªåˆ†ç±»ä¸‹çš„èœå“ (æ•ˆç‡æœ€é«˜ï¼)
    // map ç”Ÿæˆä¸€ä¸ª Promise æ•°ç»„
    const tasks = categories.map(async(cat) => {
      const dishes = await ShopService.getDishList(cat.id);
      // ç»„è£…æˆæˆ‘ä»¬è¦çš„ç»“æ„
      return new CategoryWithDishes(cat, dishes);
    });

    // C. ç­‰å¾…æ‰€æœ‰è¯·æ±‚å®Œæˆ
    const result = await Promise.all(tasks);

    // è¿‡æ»¤æ‰æ²¡æœ‰èœå“çš„åˆ†ç±» (å¯é€‰ï¼Œé˜²æ­¢æ˜¾ç¤ºç©ºæ ‡é¢˜)
    // return result.filter(item => item.dishes.length > 0);
    return result;
  }
}