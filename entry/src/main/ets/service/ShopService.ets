/**
 * å•†åº—ä¸šåŠ¡
 */
import { HttpUtil } from '../common/utils/HttpUtil';
// å¤ç”¨æˆ‘ä»¬ä¹‹å‰å®šä¹‰çš„èšåˆç±»
import { CategoryWithItems } from '../model/entity/MockData';
import { CategoryVO, DishVO, SetMealVO, ShopVO } from '../model/entity/ShopModel';
import { FollowItem, FollowRdb } from '../common/utils/FollowRdb'; // âœ¨ å¼•å…¥ FollowItem

export class ShopService {
  // ğŸ”— æ¥å£åœ°å€
  private static readonly CAT_URL = '/client/category';
  private static readonly DISH_URL = '/client/dish';
  private static readonly SETMEAL_URL = '/client/setmeal';
  private static readonly SHOP_STATUS_URL = '/client/shop/status';
  private static readonly SHOP_LIST_URL = '/client/shop/list'; 
  private static readonly SHOP_DETAIL_URL = '/client/shop'; 

  /**
   * â¤ï¸ å…³æ³¨åº—é“º (æœ¬åœ° RDB)
   */
  static async followShop(shop: ShopVO): Promise<boolean> {
    return await FollowRdb.getInstance().followShop(shop);
  }

  /**
   * ğŸ’” å–æ¶ˆå…³æ³¨ (æœ¬åœ° RDB)
   */
  static async unfollowShop(shopId: number): Promise<boolean> {
    return await FollowRdb.getInstance().unfollowShop(shopId);
  }

  /**
   * ğŸ” æ£€æŸ¥æ˜¯å¦å·²å…³æ³¨ (æœ¬åœ° RDB)
   */
  static async isShopFollowed(shopId: number): Promise<boolean> {
    return await FollowRdb.getInstance().isFollowed(shopId);
  }

  /**
   * ğŸ“œ è·å–å…³æ³¨åˆ—è¡¨ (æœ¬åœ° RDB)
   */
  static async getFollowList(): Promise<FollowItem[]> {
    return await FollowRdb.getInstance().getFollowList();
  }

  /**
   * 0ï¸âƒ£ è·å–åº—é“ºè¥ä¸šçŠ¶æ€ (å…¨å±€)
   */
  static async getShopStatus(): Promise<number> {
    try {
      const status = await HttpUtil.get<number>(ShopService.SHOP_STATUS_URL);
      return status;
    } catch ( e ) {
      console.error('è·å–åº—é“ºçŠ¶æ€å¤±è´¥å–µ', JSON.stringify(e));
      return 0; 
    }
  }

  /**
   * ğŸŒŸ 0.1ï¸âƒ£ è·å–å•†å®¶åˆ—è¡¨ (API 1.2)
   */
  static async getShopList(typeId: number, longitude?: number, latitude?: number, page: number = 1): Promise<ShopVO[]> {
    let url = `${ ShopService.SHOP_LIST_URL }/${ typeId }?page=${ page }`;
    if ( longitude !== undefined && latitude !== undefined ) {
      url += `&longitude=${ longitude }&latitude=${ latitude }`;
    }
    try {
      const list = await HttpUtil.get<ShopVO[]>(url);
      return list || [];
    } catch ( e ) {
      console.error('è·å–å•†å®¶åˆ—è¡¨å¤±è´¥å–µ', e);
      return [];
    }
  }

  /**
   * ğŸŒŸ 0.2ï¸âƒ£ è·å–å•†å®¶è¯¦æƒ… (API 1.3)
   */
  static async getShopDetail(id: number): Promise<ShopVO | null> {
    try {
      return await HttpUtil.get<ShopVO>(`${ ShopService.SHOP_DETAIL_URL }/${ id }`);
    } catch ( e ) {
      console.error(`è·å–å•†å®¶ ${ id } è¯¦æƒ…å¤±è´¥å–µ`, e);
      return null;
    }
  }

  /**
   * ğŸŒŸ 1ï¸âƒ£ è·å–æŒ‡å®šåº—é“ºçš„åˆ†ç±»åˆ—è¡¨ (API 4.1 å‡çº§ç‰ˆ âœ¨)
   */
  static async getCategoryList(shopId: number): Promise<CategoryVO[]> {
    try {
      // ç°åœ¨çš„æ¥å£éœ€è¦å¸¦ä¸Š shopId å–µ
      const url = `${ ShopService.CAT_URL }/all/${ shopId }`;
      const list = await HttpUtil.get<CategoryVO[]>(url);
      return list || [];
    } catch ( err ) {
      console.error(`è·å–å•†å®¶ ${ shopId } çš„åˆ†ç±»å¤±è´¥å–µ`);
      return [];
    }
  }

  /**
   * 2ï¸âƒ£ è·å–æŸåˆ†ç±»ä¸‹çš„èœå“
   */
  static async getDishList(categoryId: number): Promise<DishVO[]> {
    try {
      const url = `${ ShopService.DISH_URL }/${ categoryId }`;
      const list = await HttpUtil.get<DishVO[]>(url);
      return list || [];
    } catch ( err ) {
      console.error(`è·å–åˆ†ç±» ${ categoryId } çš„èœå“å¤±è´¥å–µ`);
      return []; 
    }
  }

  /**
   * 2.5ï¸âƒ£ è·å–æŸåˆ†ç±»ä¸‹çš„å¥—é¤
   */
  static async getSetmealList(categoryId: number): Promise<SetMealVO[]> {
    try {
      const url = `${ ShopService.SETMEAL_URL }/${ categoryId }`;
      const list = await HttpUtil.get<SetMealVO[]>(url);
      return list || [];
    } catch ( err ) {
      console.error(`è·å–åˆ†ç±» ${ categoryId } çš„å¥—é¤å¤±è´¥å–µ`);
      return [];
    }
  }


  /**
   * ğŸš€ 3ï¸âƒ£ ã€æ ¸å¿ƒå¤§æ‹›ã€‘è·å–å…¨åº—æ•°æ® (åˆ†ç±» + èœå“/å¥—é¤) å¹¶ç»„è£…
   * ç°åœ¨å¿…é¡»ä¼ å…¥ shopId å–µï¼
   */
  static async getShopData(shopId: number): Promise<CategoryWithItems[]> {
    // A. å…ˆæ‹¿æŒ‡å®šå•†åº—çš„æ‰€æœ‰åˆ†ç±»
    const categories = await ShopService.getCategoryList(shopId);
    if ( categories.length === 0 ) {
      return [];
    }

    // B. å¹¶å‘è¯·æ±‚å†…å®¹
    const tasks = categories.map(async(cat) => {
      let items: DishVO[] = [];
      if ( cat.type === 1 ) {
        items = await ShopService.getDishList(cat.id);
      } else {
        const setmeals = await ShopService.getSetmealList(cat.id);
        items = setmeals.map(s => new DishVO(
          s.id,
          s.name,
          s.categoryId,
          s.price,
          s.image,
          s.description,
          s.status,
          cat.name, 
          []
        ));
      }
      return new CategoryWithItems(cat, items);
    });

    const result = await Promise.all(tasks);
    return result;
  }
}