import { common } from '@kit.AbilityKit';
import { MessageEntity, MessageRdb, SessionModel } from '../common/utils/MessageRdb';
import { WebSocketMessage, WebSocketService } from '../service/WebSocketService';

/**
 * æ¶ˆæ¯ç®¡ç†å™¨
 * è´Ÿè´£åè°ƒ WebSocket æ¥æ”¶æ¶ˆæ¯ã€RDB å­˜å‚¨ä»¥åŠ UI é€šçŸ¥
 */
export class MessageManager {
  private static instance: MessageManager;
  private userId: number = 0;

  private constructor() {
  }

  public static getInstance(): MessageManager {
    if (!MessageManager.instance ) {
      MessageManager.instance = new MessageManager();
    }
    return MessageManager.instance;
  }

  /**
   * åˆå§‹åŒ–ç®¡ç†å™¨
   * @param context åº”ç”¨ä¸Šä¸‹æ–‡ (ç”¨äº RDB åˆå§‹åŒ–)
   * @param userId å½“å‰ç”¨æˆ·ID
   */
  public async init(context: common.UIAbilityContext, userId: number) {
    this.userId = userId;

    // 1. åˆå§‹åŒ–æ•°æ®åº“
    await MessageRdb.init(context);

    // 2. æ³¨å†Œ WebSocket ç›‘å¬å™¨
    const ws = WebSocketService.getInstance();

    // ç›‘å¬ç³»ç»Ÿé€šçŸ¥ (Type 1)
    ws.onMessage(1, (msg): Promise<void> => this.handleIncomingMessage(msg));

    // ç›‘å¬è®¢å•çŠ¶æ€ (Type 2)
    ws.onMessage(2, (msg): Promise<void> => this.handleIncomingMessage(msg));

    // ç›‘å¬ç§èŠæ¶ˆæ¯ (Type 3)
    ws.onMessage(3, (msg): Promise<void> => this.handleIncomingMessage(msg));

    console.info('å–µï¼MessageManager åˆå§‹åŒ–å®Œæˆï¼Œå¼€å§‹ç›‘å¬æ¶ˆæ¯ ğŸ“¡');
  }

  /**
   * å¤„ç†æ”¶åˆ°çš„ WebSocket æ¶ˆæ¯
   */
  private async handleIncomingMessage(msg: WebSocketMessage) {
    console.info(`å–µï¼æ”¶åˆ°æ–°æ¶ˆæ¯: ${ msg.content }`);

    // 1. æ„å»ºä¼šè¯ ID
    // è§„åˆ™ï¼š
    // - ç³»ç»Ÿæ¶ˆæ¯: "system_notify"
    // - ç§èŠæ¶ˆæ¯: "user_{otherId}" (å¦‚æœæ˜¯å•†å®¶å‘ç»™ç”¨æˆ·ï¼ŒotherIdå°±æ˜¯å•†å®¶ID)
    let sessionId = "";
    let title = "";
    let avatar = "";

        if (msg.type === 1 || msg.type === 2) {

          sessionId = "system_notify";

          title = "Meowå¤–å–"; // âœ¨ æ”¹ä¸º Meowå¤–å–

          // ä½¿ç”¨é»˜è®¤ç³»ç»Ÿå¤´åƒæˆ–ä»æ¶ˆæ¯ä¸­è·å–

          avatar = msg.senderAvatar || "app.media.logo"; // è¿™é‡Œæš‚æ—¶ç”¨æœ¬åœ°èµ„æºå ä½ï¼Œå®é™…éœ€å¤„ç†ç½‘ç»œå›¾ç‰‡

        } else if (msg.type === 3) {
      // å‡è®¾å½“å‰æ˜¯ç”¨æˆ·ç«¯ï¼Œæ”¶åˆ°çš„è‚¯å®šæ˜¯å•†å®¶æˆ–éª‘æ‰‹å‘çš„
      sessionId = `shop_${ msg.senderId }`;
      title = msg.senderName || `å•†å®¶ ${ msg.senderId }`;
      avatar = msg.senderAvatar;
    }

    if (!sessionId ) {
      return;
    }

    // 2. ä¿å­˜æ¶ˆæ¯æ˜ç»†åˆ° RDB
    const messageEntity: MessageEntity = {
      sessionId: sessionId,
      msgId: msg.msgId,
      senderId: msg.senderId,
      role: 1, // 1 è¡¨ç¤ºå¯¹æ–¹å‘çš„ (æ¥æ”¶)
      content: msg.content,
      type: msg.type,
      createTime: msg.timestamp,
      orderId: msg.orderId // âœ¨ å­˜å…¥ orderId
    };
    await MessageRdb.saveMessage(messageEntity);

    // 3. æ›´æ–°ä¼šè¯åˆ—è¡¨åˆ° RDB
    const sessionModel: SessionModel = {
      sessionId: sessionId,
      title: title,
      avatar: avatar,
      lastMsg: msg.content,
      lastTime: msg.timestamp,
      unreadCount: 1 // æ–°æ¶ˆæ¯å¢åŠ  1 ä¸ªæœªè¯»
    };
    await MessageRdb.saveSession(sessionModel);

    // 4. é€šçŸ¥ UI æ›´æ–°
    // ä½¿ç”¨ AppStorage å‘å¸ƒäº‹ä»¶ï¼ŒMessagePage å¯ä»¥ç›‘å¬è¿™ä¸ªå˜é‡çš„å˜åŒ–æ¥åˆ·æ–°åˆ—è¡¨
    AppStorage.setOrCreate('NewMessageSignal', Date.now());

    // å…¨å±€æœªè¯»æ•°é€šçŸ¥ (å¯é€‰)
    // AppStorage.setOrCreate('GlobalUnreadCount', ...);
  }

    /**

     * å‘é€æ¶ˆæ¯ (ä¸Šè¡Œ)

     * @param content å†…å®¹

     * @param receiverId æ¥æ”¶è€…ID

     * @param receiverRole æ¥æ”¶è€…è§’è‰²

     * @param receiverName æ¥æ”¶è€…åç§° (ç”¨äºæœ¬åœ°ä¼šè¯æ˜¾ç¤º)

     * @param receiverAvatar æ¥æ”¶è€…å¤´åƒ (ç”¨äºæœ¬åœ°ä¼šè¯æ˜¾ç¤º)

     */

    public async sendMessage(content: string, receiverId: number, receiverRole: number, receiverName?: string, receiverAvatar?: string): Promise<void> {

      const ws = WebSocketService.getInstance();

      

      // 1. æ„é€  WS æ¶ˆæ¯ä½“

      const msg: Partial<WebSocketMessage> = {

        type: 3, // ç§èŠ

        content: content,

        receiverId: receiverId,

        receiverRole: receiverRole

        // å…¶ä»–å­—æ®µç”±åç«¯å¡«å……

      };

      

      // 2. å‘é€

      ws.send(msg);

  

      // 3. æœ¬åœ°å­˜å‚¨ (è‡ªå·±å‘çš„æ¶ˆæ¯ä¹Ÿè¦å­˜)

      const sessionId = `shop_${receiverId}`; // å‡è®¾æ˜¯å‘ç»™å•†å®¶

      const now = Date.now();

  

      const messageEntity: MessageEntity = {

        sessionId: sessionId,

        msgId: `local_${now}`, // æœ¬åœ°ä¸´æ—¶ID

        senderId: this.userId,

        role: 0, // 0 è¡¨ç¤ºæˆ‘è‡ªå·±å‘çš„

        content: content,

        type: 3,

        createTime: now

      };

      await MessageRdb.saveMessage(messageEntity);

  

      // 4. æ›´æ–°ä¼šè¯ (è‡ªå·±å‘çš„æ¶ˆæ¯ä¸å¢åŠ æœªè¯»æ•°)

      // âœ¨ ä½¿ç”¨ä¼ å…¥çš„åç§°å’Œå¤´åƒï¼Œå¦‚æœæ²¡ä¼ åˆ™å›é€€åˆ°é»˜è®¤

      const sessionModel: SessionModel = {

        sessionId: sessionId,

        title: receiverName || `å•†å®¶ ${receiverId}`, 

        avatar: receiverAvatar || '', 

        lastMsg: content,

        lastTime: now,

        unreadCount: 0 

      };

      await MessageRdb.saveSession(sessionModel);

      

      // é€šçŸ¥ UI

      AppStorage.setOrCreate('NewMessageSignal', now);

    }
}
