import { common } from '@kit.AbilityKit';
import { MessageEntity, MessageRdb } from '../common/MessageRdb';
import { SessionModel, MessageConstant } from '../model/MessageModel';
import { WebSocketMessage, WebSocketService } from '../service/WebSocketService';

/**
 * æ¶ˆæ¯ç®¡ç†å™¨ (å•†å®¶ç«¯)
 * è´Ÿè´£åè°ƒ WebSocket æ¥æ”¶æ¶ˆæ¯ã€RDB å­˜å‚¨ä»¥åŠ UI é€šçŸ¥
 */
export class MessageManager {
  private static instance: MessageManager;
  private shopId: number = 0;
  
  // ğŸ¾ å½“å‰æ­£åœ¨èŠå¤©çš„ä¼šè¯ID (æš‚æœªå®ç°èŠå¤©é¡µï¼Œé¢„ç•™)
  private currentChatSessionId: string | null = null;

  private constructor() {}

  public static getInstance(): MessageManager {
    if (!MessageManager.instance) {
      MessageManager.instance = new MessageManager();
    }
    return MessageManager.instance;
  }

  /**
   * åˆå§‹åŒ–ç®¡ç†å™¨
   * @param context åº”ç”¨ä¸Šä¸‹æ–‡ (ç”¨äº RDB åˆå§‹åŒ–)
   * @param shopId å½“å‰åº—é“ºID
   */
  public async init(context: common.UIAbilityContext, shopId: number) {
    this.shopId = shopId;

    // 1. åˆå§‹åŒ–æ•°æ®åº“
    await MessageRdb.init(context);
    
    // 2. æ³¨å†Œ WebSocket ç›‘å¬å™¨
    const ws = WebSocketService.getInstance();
    
    // å…ˆè¿æ¥
    ws.connect(shopId);

    // ç›‘å¬ç³»ç»Ÿé€šçŸ¥ (Type 1)
    ws.onMessage(1, (msg): Promise<void> => this.handleIncomingMessage(msg));

    // ç›‘å¬è®¢å•çŠ¶æ€ (Type 2)
    ws.onMessage(2, (msg): Promise<void> => this.handleIncomingMessage(msg));

    // ç›‘å¬ç§èŠæ¶ˆæ¯ (Type 3)
    ws.onMessage(3, (msg): Promise<void> => this.handleIncomingMessage(msg));

    console.info('å–µï¼MessageManager åˆå§‹åŒ–å®Œæˆï¼Œå¼€å§‹ç›‘å¬æ¶ˆæ¯ ğŸ“¡');
  }

  /**
   * è¿›å…¥èŠå¤©ä¼šè¯ (ç¦æ­¢å¼¹è¯¥ä¼šè¯çš„é€šçŸ¥)
   */
  public enterChat(sessionId: string) {
    this.currentChatSessionId = sessionId;
  }

  /**
   * ç¦»å¼€èŠå¤©ä¼šè¯ (æ¢å¤å¼¹é€šçŸ¥)
   */
  public leaveChat() {
    this.currentChatSessionId = null;
  }

  /**
   * å¤„ç†æ”¶åˆ°çš„ WebSocket æ¶ˆæ¯
   */
  private async handleIncomingMessage(msg: WebSocketMessage) {
    console.info(`å–µï¼æ”¶åˆ°æ–°æ¶ˆæ¯: ${msg.content}`);

    // 1. æ„å»ºä¼šè¯ ID
    let sessionId = "";
    let title = "";
    let avatar = "";

    // å•†å®¶ç«¯çš„é€»è¾‘ï¼š
    // ç³»ç»Ÿ/è®¢å•é€šçŸ¥ -> system_notify
    // ç§èŠ -> user_{senderId}
    if (msg.type === MessageConstant.SYSTEM_NOTIFICATION || msg.type === MessageConstant.ORDER_NOTIFICATION) {
      sessionId = "system_notify";
      title = "ç³»ç»Ÿé€šçŸ¥";
      // å¦‚æœæ²¡æœ‰å¤´åƒï¼Œä½¿ç”¨é»˜è®¤logo (UIå±‚å¤„ç†)
      avatar = msg.senderAvatar || ""; 
    } else if (msg.type === MessageConstant.PRIVATE_MESSAGE) {
      sessionId = `user_${msg.senderId}`; // å•†å®¶ç«¯æ”¶åˆ°çš„ç§èŠæ˜¯æ¥è‡ªç”¨æˆ·çš„
      title = msg.senderName || `ç”¨æˆ· ${msg.senderId}`;
      avatar = msg.senderAvatar || "";
    }

    if (!sessionId) {
      return;
    }

    // 2. ä¿å­˜æ¶ˆæ¯æ˜ç»†åˆ° RDB
    const messageEntity: MessageEntity = {
      sessionId: sessionId,
      msgId: msg.msgId,
      senderId: msg.senderId,
      role: 1, // 1 è¡¨ç¤ºå¯¹æ–¹å‘çš„ (æ¥æ”¶)
      content: msg.content,
      type: msg.type,
      createTime: msg.timestamp,
      orderId: msg.orderId
    };
    await MessageRdb.saveMessage(messageEntity);

    // 3. æ›´æ–°ä¼šè¯åˆ—è¡¨åˆ° RDB
    const isChatting = (this.currentChatSessionId === sessionId);
    
    // æ„é€  SessionModel (æ³¨æ„ï¼šSessionModel çš„æ„é€ å‡½æ•°å‚æ•°é¡ºåº)
    // constructor(sessionId: string, title: string, avatar: string | Resource, lastMsg: string, lastTime: number, unreadCount: number)
    const sessionModel = new SessionModel(
      sessionId,
      title,
      avatar,
      msg.content,
      msg.timestamp,
      isChatting ? 0 : 1 // æ–°æ¶ˆæ¯å¢åŠ  1 ä¸ªæœªè¯»
    );
    await MessageRdb.saveSession(sessionModel);

    // 4. é€šçŸ¥ UI æ›´æ–°æ¶ˆæ¯åˆ—è¡¨
    AppStorage.setOrCreate('NewMessageSignal', Date.now());

    // 5. ç‰¹æ®Šå¤„ç†ï¼šè®¢å•é€šçŸ¥ -> è§¦å‘å…¨å±€å¼¹çª—
    if (msg.type === MessageConstant.ORDER_NOTIFICATION) {
        console.info('å–µï¼æ£€æµ‹åˆ°æ–°è®¢å•æ¶ˆæ¯ï¼Œå‡†å¤‡å¼¹çª—ï¼');
        AppStorage.setOrCreate('NewOrderMessage', msg);
    }
  }

  /**
   * å‘é€æ¶ˆæ¯ (ä¸Šè¡Œ)
   */
  public async sendMessage(content: string, receiverId: number, receiverRole: number, receiverName?: string, receiverAvatar?: string): Promise<void> {
    const ws = WebSocketService.getInstance();
    
    // 1. æ„é€  WS æ¶ˆæ¯ä½“
    const msg: Partial<WebSocketMessage> = {
      type: 3, // ç§èŠ
      content: content,
      receiverId: receiverId,
      receiverRole: receiverRole
    };
    
    // 2. å‘é€
    ws.send(msg);

    // 3. æœ¬åœ°å­˜å‚¨ (è‡ªå·±å‘çš„æ¶ˆæ¯ä¹Ÿè¦å­˜)
    const sessionId = `user_${receiverId}`; // å‘ç»™ç”¨æˆ·
    const now = Date.now();

    const messageEntity: MessageEntity = {
      sessionId: sessionId,
      msgId: `local_${now}`, 
      senderId: this.shopId, // å‘é€è€…æ˜¯è‡ªå·± (åº—é“ºID)
      role: 0, // 0 è¡¨ç¤ºæˆ‘è‡ªå·±å‘çš„
      content: content,
      type: 3,
      createTime: now
    };
    await MessageRdb.saveMessage(messageEntity);

    // 4. æ›´æ–°ä¼šè¯
    const sessionModel = new SessionModel(
      sessionId,
      receiverName || `ç”¨æˆ· ${receiverId}`, 
      receiverAvatar || '', 
      content,
      now,
      0 // è‡ªå·±å‘çš„ä¸ç”¨æœªè¯»æ•°
    );
    await MessageRdb.saveSession(sessionModel);
    
    // é€šçŸ¥ UI
    AppStorage.setOrCreate('NewMessageSignal', now);
  }
  
  /**
   * æ–­å¼€è¿æ¥
   */
  public disconnect() {
    WebSocketService.getInstance().close();
  }
}
