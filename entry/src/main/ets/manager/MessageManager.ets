import { common } from '@kit.AbilityKit';
import { MessageEntity, MessageRdb, SessionModel } from '../common/utils/MessageRdb';
import { WebSocketMessage, WebSocketService } from '../service/WebSocketService';
import { NotificationUtil } from '../common/utils/NotificationUtil';

/**
 * æ¶ˆæ¯ç®¡ç†å™¨
 * è´Ÿè´£åè°ƒ WebSocket æ¥æ”¶æ¶ˆæ¯ã€RDB å­˜å‚¨ä»¥åŠ UI é€šçŸ¥
 */
export class MessageManager {
  private static instance: MessageManager;
  private userId: number = 0;
  
  // ğŸ¾ å½“å‰æ­£åœ¨èŠå¤©çš„ä¼šè¯ID (å¦‚æœåœ¨èŠå¤©é¡µï¼Œå°±ä¸å¼¹é€šçŸ¥äº†)
  private currentChatSessionId: string | null = null;

  private constructor() {
  }

  public static getInstance(): MessageManager {
    if (!MessageManager.instance ) {
      MessageManager.instance = new MessageManager();
    }
    return MessageManager.instance;
  }

  /**
   * åˆå§‹åŒ–ç®¡ç†å™¨
   * @param context åº”ç”¨ä¸Šä¸‹æ–‡ (ç”¨äº RDB åˆå§‹åŒ–)
   * @param userId å½“å‰ç”¨æˆ·ID
   */
  public async init(context: common.UIAbilityContext, userId: number) {
    this.userId = userId;

    // 1. åˆå§‹åŒ–æ•°æ®åº“
    await MessageRdb.init(context);
    
    // 2. ç”³è¯·é€šçŸ¥æƒé™
    await NotificationUtil.requestNotificationPermission(context);

    // 3. æ³¨å†Œ WebSocket ç›‘å¬å™¨
    const ws = WebSocketService.getInstance();

    // ç›‘å¬ç³»ç»Ÿé€šçŸ¥ (Type 1)
    ws.onMessage(1, (msg): Promise<void> => this.handleIncomingMessage(msg));

    // ç›‘å¬è®¢å•çŠ¶æ€ (Type 2)
    ws.onMessage(2, (msg): Promise<void> => this.handleIncomingMessage(msg));

    // ç›‘å¬ç§èŠæ¶ˆæ¯ (Type 3)
    ws.onMessage(3, (msg): Promise<void> => this.handleIncomingMessage(msg));

    console.info('å–µï¼MessageManager åˆå§‹åŒ–å®Œæˆï¼Œå¼€å§‹ç›‘å¬æ¶ˆæ¯ ğŸ“¡');
  }

  /**
   * è¿›å…¥èŠå¤©ä¼šè¯ (ç¦æ­¢å¼¹è¯¥ä¼šè¯çš„é€šçŸ¥)
   */
  public enterChat(sessionId: string) {
    this.currentChatSessionId = sessionId;
  }

  /**
   * ç¦»å¼€èŠå¤©ä¼šè¯ (æ¢å¤å¼¹é€šçŸ¥)
   */
  public leaveChat() {
    this.currentChatSessionId = null;
  }

  /**
   * å¤„ç†æ”¶åˆ°çš„ WebSocket æ¶ˆæ¯
   */
  private async handleIncomingMessage(msg: WebSocketMessage) {
    console.info(`å–µï¼æ”¶åˆ°æ–°æ¶ˆæ¯: ${ msg.content }`);

    // 1. æ„å»ºä¼šè¯ ID
    let sessionId = "";
    let title = "";
    let avatar = "";

    if (msg.type === 1 || msg.type === 2) {
      sessionId = "system_notify";
      title = "Meowå¤–å–";
      avatar = msg.senderAvatar || "app.media.logo"; 
    } else if (msg.type === 3) {
      sessionId = `shop_${ msg.senderId }`;
      title = msg.senderName || `å•†å®¶ ${ msg.senderId }`;
      avatar = msg.senderAvatar;
    }

    if (!sessionId ) {
      return;
    }

    // 2. ä¿å­˜æ¶ˆæ¯æ˜ç»†åˆ° RDB
    const messageEntity: MessageEntity = {
      sessionId: sessionId,
      msgId: msg.msgId,
      senderId: msg.senderId,
      role: 1, // 1 è¡¨ç¤ºå¯¹æ–¹å‘çš„ (æ¥æ”¶)
      content: msg.content,
      type: msg.type,
      createTime: msg.timestamp,
      orderId: msg.orderId
    };
    await MessageRdb.saveMessage(messageEntity);

    // 3. æ›´æ–°ä¼šè¯åˆ—è¡¨åˆ° RDB
    // å¦‚æœå½“å‰æ­£å¤„äºè¯¥ä¼šè¯ä¸­ï¼Œæœªè¯»æ•°ä¸å¢åŠ 
    const isChatting = (this.currentChatSessionId === sessionId);
    
    const sessionModel: SessionModel = {
      sessionId: sessionId,
      title: title,
      avatar: avatar,
      lastMsg: msg.content,
      lastTime: msg.timestamp,
      unreadCount: isChatting ? 0 : 1 // æ–°æ¶ˆæ¯å¢åŠ  1 ä¸ªæœªè¯»
    };
    await MessageRdb.saveSession(sessionModel);

    // 4. é€šçŸ¥ UI æ›´æ–°
    AppStorage.setOrCreate('NewMessageSignal', Date.now());

    // 5. ğŸ”” å‘é€ç³»ç»Ÿé€šçŸ¥ (å¦‚æœä¸åœ¨å½“å‰ä¼šè¯ä¸­)
    if (!isChatting) {
      // ç®€å•å¤„ç†ï¼šä½¿ç”¨æ—¶é—´æˆ³å4ä½ä½œä¸ºé€šçŸ¥IDï¼Œé¿å…è¦†ç›–
      const notificationId = Math.floor(Date.now() % 10000);
      await NotificationUtil.publishBasicNotification(title, msg.content, notificationId);
    }
  }

  /**
   * å‘é€æ¶ˆæ¯ (ä¸Šè¡Œ)
   */
  public async sendMessage(content: string, receiverId: number, receiverRole: number, receiverName?: string, receiverAvatar?: string): Promise<void> {
    const ws = WebSocketService.getInstance();
    
    // 1. æ„é€  WS æ¶ˆæ¯ä½“
    const msg: Partial<WebSocketMessage> = {
      type: 3, // ç§èŠ
      content: content,
      receiverId: receiverId,
      receiverRole: receiverRole
    };
    
    // 2. å‘é€
    ws.send(msg);

    // 3. æœ¬åœ°å­˜å‚¨ (è‡ªå·±å‘çš„æ¶ˆæ¯ä¹Ÿè¦å­˜)
    const sessionId = `shop_${receiverId}`; 
    const now = Date.now();

    const messageEntity: MessageEntity = {
      sessionId: sessionId,
      msgId: `local_${now}`, 
      senderId: this.userId,
      role: 0, // 0 è¡¨ç¤ºæˆ‘è‡ªå·±å‘çš„
      content: content,
      type: 3,
      createTime: now
    };
    await MessageRdb.saveMessage(messageEntity);

    // 4. æ›´æ–°ä¼šè¯ (è‡ªå·±å‘çš„æ¶ˆæ¯ä¸å¢åŠ æœªè¯»æ•°)
    const sessionModel: SessionModel = {
      sessionId: sessionId,
      title: receiverName || `å•†å®¶ ${receiverId}`, 
      avatar: receiverAvatar || '', 
      lastMsg: content,
      lastTime: now,
      unreadCount: 0 
    };
    await MessageRdb.saveSession(sessionModel);
    
    // é€šçŸ¥ UI
    AppStorage.setOrCreate('NewMessageSignal', now);
  }
}