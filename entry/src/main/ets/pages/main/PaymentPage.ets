import { promptAction } from '@kit.ArkUI';
import { OrderPaymentDTO } from '../../model/api/OrderModel';
import { OrderService } from '../../service/OrderService';
import { PaySuccessPageParams } from './PaySuccessPage';

/**
 * æ”¯ä»˜é¡µé¢å‚æ•°
 */
export interface PaymentPageParams {
  orderNumber: string;
  payMethod: number; // 1å¾®ä¿¡ 2æ”¯ä»˜å®
  totalAmount: number;
}

@Component
export struct PaymentPage {
  @Consume('pageStack') pageStack: NavPathStack;
  @State qrCodeContent: string = ''; // äºŒç»´ç å†…å®¹
  @State orderNumber: string = '';
  @State payMethod: number = 1;
  @State totalAmount: number = 0;
  @State isLoading: boolean = true;
  @State timeLeft: number = 15 * 60; // å€’è®¡æ—¶ 15åˆ†é’Ÿ
  private timer: number = -1;
  // ç›‘å¬æ”¯ä»˜æˆåŠŸä¿¡å·
  @StorageProp('PaySuccessSignal') @Watch('onPaySuccess') paySuccessOrderId: number = 0;

  build() {
    NavDestination() {
      Column() {
        // æ ‡é¢˜
        Text('è®¢å•æ”¯ä»˜')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .margin({ top: 20, bottom: 10 })

        // å€’è®¡æ—¶
        Text(`æ”¯ä»˜å‰©ä½™æ—¶é—´ ${ this.formatTime(this.timeLeft) }`)
          .fontSize(14)
          .fontColor('#666')
          .margin({ bottom: 30 })

        // é‡‘é¢
        Row() {
          Text('Â¥').fontSize(18).fontWeight(FontWeight.Bold).margin({ top: 4 })
          Text(this.totalAmount.toFixed(2)).fontSize(36).fontWeight(FontWeight.Bold)
        }.margin({ bottom: 40 })

        // äºŒç»´ç åŒºåŸŸ
        if ( this.isLoading ) {
          LoadingProgress().width(50).height(50).color('#FFCC00')
          Text('æ­£åœ¨ç”ŸæˆäºŒç»´ç ...').fontSize(12).fontColor('#999').margin({ top: 10 })
        } else if ( this.qrCodeContent ) {
          Column() {
            QRCode(this.qrCodeContent)
              .width(200)
              .height(200)
              .color(Color.Black)
              .backgroundColor(Color.White)

            Text(this.payMethod === 1 ? 'è¯·ä½¿ç”¨å¾®ä¿¡æ‰«ç ' : 'è¯·ä½¿ç”¨æ”¯ä»˜å®æ‰«ç ')
              .fontSize(14)
              .fontColor('#666')
              .margin({ top: 15 })
          }
          .padding(20)
          .backgroundColor(Color.White)
          .borderRadius(12)
          .shadow({ radius: 10, color: '#1a000000', offsetY: 5 })
        } else {
          Text('äºŒç»´ç ç”Ÿæˆå¤±è´¥å–µðŸ˜¿').fontSize(14).fontColor(Color.Red)
          Button('é‡è¯•').margin({ top: 10 }).onClick(() => this.loadQrCode())
        }

        Blank()

        // åº•éƒ¨æŒ‰é’®ï¼ˆå…œåº•ç”¨ï¼Œé˜²æ­¢ WS æ²¡æ”¶åˆ°ï¼‰
        Button('æˆ‘å·²å®Œæˆæ”¯ä»˜')
          .width('90%')
          .height(45)
          .backgroundColor('#FFCC00')
          .fontColor('#333')
          .margin({ bottom: 30 })
          .onClick(() => {
            this.onPaySuccess();
          })

      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F9F9F9')
    }
    .hideTitleBar(true)
    .onReady((context: NavDestinationContext) => {
      this.pageStack = context.pathStack;
      const params = context.pathInfo.param as PaymentPageParams;
      if ( params ) {
        this.orderNumber = params.orderNumber;
        this.payMethod = params.payMethod;
        this.totalAmount = params.totalAmount;
        this.loadQrCode();
        this.startTimer();
      }
    })
    .onDisAppear(() => {
      if ( this.timer !== -1 ) {
        clearInterval(this.timer);
      }
    })
  }

  async loadQrCode() {
    this.isLoading = true;
    try {
      const dto: OrderPaymentDTO = {
        orderNumber: this.orderNumber,
        payMethod: this.payMethod
      };
      const result = await OrderService.payment(dto);
      this.qrCodeContent = result.qrCode;
    } catch ( e ) {
      console.error('å–µï¼èŽ·å–æ”¯ä»˜äºŒç»´ç å¤±è´¥:', e);
      promptAction.showToast({ message: 'èŽ·å–äºŒç»´ç å¤±è´¥ï¼Œè¯·é‡è¯•' });
    } finally {
      this.isLoading = false;
    }
  }

  startTimer() {
    this.timer = setInterval(() => {
      if ( this.timeLeft > 0 ) {
        this.timeLeft--;
      } else {
        clearInterval(this.timer);
      }
    }, 1000);
  }

  formatTime(seconds: number): string {
    const m = Math.floor(seconds / 60).toString().padStart(2, '0');
    const s = (seconds % 60).toString().padStart(2, '0');
    return `${ m }:${ s }`;
  }

  onPaySuccess() {
    // åªè¦è§¦å‘äº†è¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬å°±è®¤ä¸ºæ”¯ä»˜æˆåŠŸäº†
    // ä¼˜å…ˆä½¿ç”¨å½“å‰é¡µé¢æŒæœ‰çš„ orderNumber (é•¿ä¸²)ï¼Œå¦‚æžœæ²¡æœ‰ï¼ˆæžå°‘è§ï¼‰å†ç”¨ WS æŽ¨é€çš„ orderId
    if ( this.orderNumber || this.paySuccessOrderId > 0 ) {
      const successParams: PaySuccessPageParams = {
        orderNumber: this.orderNumber || this.paySuccessOrderId.toString(),
        amount: this.totalAmount
      };

      this.pageStack.replacePath({ name: 'PaySuccessPage', param: successParams });
    }
  }
}
