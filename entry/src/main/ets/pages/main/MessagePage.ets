import { MessageRdb, SessionModel } from '../../common/utils/MessageRdb';
import { ChatPageParam } from '../message/ChatPage'; // âœ¨ å¼•å…¥æ–°çš„å‚æ•°ç±»

/**
 * æ¶ˆæ¯é¡µ (ä¼šè¯åˆ—è¡¨)
 */
@Component
export struct MessagePage {
  // æ¶ˆè´¹ä¸Šä¸€çº§æä¾›çš„ Navigation Stack
  @Consume('pageStack') pageStack: NavPathStack; 
  @State sessionList: SessionModel[] = [];
  @StorageLink('NewMessageSignal') @Watch('onMessageSignal') signal: number = 0;

  async aboutToAppear() {
    this.refreshList();
  }

  async onMessageSignal() {
    console.info('å–µï¼æ”¶åˆ°æ–°æ¶ˆæ¯ä¿¡å·ï¼Œåˆ·æ–°åˆ—è¡¨ ğŸ”„');
    this.refreshList();
  }

  async refreshList() {
    this.sessionList = await MessageRdb.getSessionList();
  }

  // æ ¼å¼åŒ–æ—¶é—´æˆ³
  formatTime(timestamp: number): string {
    const date = new Date(timestamp);
    const now = new Date();
    // ç®€å•å¤„ç†ï¼šå¦‚æœæ˜¯ä»Šå¤©æ˜¾ç¤º HH:mmï¼Œå¦åˆ™æ˜¾ç¤º MM-dd
    if (date.getDate() === now.getDate() && date.getMonth() === now.getMonth()) {
      return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
    }
    return `${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
  }

  @Builder itemEnd(sessionId: string) {
    Row() {
      Button("åˆ é™¤")
        .type(ButtonType.Normal)
        .backgroundColor(Color.Red)
        .fontColor(Color.White)
        .height('100%')
        .width(80)
        .onClick(async () => {
          await MessageRdb.deleteSession(sessionId);
          this.refreshList();
        })
    }
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('æ¶ˆæ¯ä¸­å¿ƒ')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
      }
      .width('100%')
      .padding({ left: 16, top: 16, bottom: 16 })
      .backgroundColor(Color.White)

      // åˆ—è¡¨
      if (this.sessionList.length === 0) {
        Column() {
          // ä½¿ç”¨ç³»ç»Ÿå›¾æ ‡ envelope_open_fill å–µ
          SymbolGlyph($r('sys.symbol.envelope_open_fill'))
            .fontSize(80)
            .fontColor(['#BDC3C7'])
          Text('æš‚æ— æ¶ˆæ¯å–µ~')
            .fontSize(16)
            .fontColor(Color.Gray)
            .margin({ top: 15 })
        }
        .width('100%').layoutWeight(1).justifyContent(FlexAlign.Center)
      } else {
        List() {
          ForEach(this.sessionList, (item: SessionModel) => {
            ListItem() {
              Row() {
                // å¤´åƒ
                Image(item.sessionId === 'system_notify' ? $r('app.media.logo') : (item.avatar ? item.avatar : $r('app.media.logo'))) // ä¼˜å…ˆä½¿ç”¨ item.avatar
                  .width(50).height(50)
                  .borderRadius(25)
                  .margin({ right: 12 })
                  .objectFit(ImageFit.Cover)
                
                // å†…å®¹åŒºåŸŸ
                Column() {
                  Row() {
                    // æ ‡é¢˜ç‰¹æ®Šå¤„ç†ï¼šç³»ç»Ÿé€šçŸ¥ -> Meowå¤–å–
                    Text(item.sessionId === 'system_notify' ? 'Meowå¤–å–' : item.title)
                      .fontSize(16)
                      .fontWeight(FontWeight.Medium)
                      .layoutWeight(1)
                    Text(this.formatTime(item.lastTime))
                      .fontSize(12)
                      .fontColor('#999999')
                  }
                  .width('100%')
                  
                  Row() {
                    Text(item.lastMsg)
                      .fontSize(14)
                      .fontColor('#666666')
                      .maxLines(1)
                      .textOverflow({ overflow: TextOverflow.Ellipsis })
                      .layoutWeight(1)
                      .margin({ top: 4 })
                    
                    // æœªè¯»çº¢ç‚¹
                    if (item.unreadCount > 0) {
                      Text(item.unreadCount > 99 ? '99+' : item.unreadCount.toString())
                        .fontSize(10)
                        .fontColor(Color.White)
                        .backgroundColor(Color.Red)
                        .borderRadius(10)
                        .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                        .margin({ left: 8 })
                    }
                  }
                  .width('100%')
                }
                .layoutWeight(1)
              }
              .width('100%')
              .padding({ left: 16, right: 16, top: 12, bottom: 12 })
              .backgroundColor(Color.White)
              .onClick(() => {
                // å–µï¼è¿™é‡Œè¿›è¡Œåˆ†æµè·³è½¬
                if (item.sessionId === 'system_notify') {
                  this.pageStack.pushPath({ name: 'SystemNotifyPage' });
                } else {
                  // ç§èŠè·³è½¬
                  // âœ¨ ä¼ é€’ item.avatar ç»™ ChatPage
                  const params = new ChatPageParam(item.sessionId, item.title, item.avatar);
                  this.pageStack.pushPath({ name: 'ChatPage', param: params });
                }
              })
            }
            .swipeAction({ end: this.itemEnd(item.sessionId) }) // ä¾§æ»‘åˆ é™¤
          })
        }
        .width('100%')
        .layoutWeight(1)
        .divider({ strokeWidth: 0.5, color: '#EEEEEE', startMargin: 78, endMargin: 0 }) // åˆ†å‰²çº¿
      }
    }
    .width('100%').height('100%')
    .backgroundColor('#F5F5F5')
  }
}