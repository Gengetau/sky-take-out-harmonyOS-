import { promptAction } from '@kit.ArkUI';
import { OrderDetailVO, OrderVO } from '../../model/api/OrderModel';
import { OrderService } from '../../service/OrderService';

/**
 * ğŸ“œ è®¢å•å†å²é¡µé¢
 */
@Component
export struct OrderHistoryPage {
  @Consume('pageStack') pageStack: NavPathStack;
  @State orders: OrderVO[] = [];
  @State currentPage: number = 1;
  @State pageSize: number = 10;
  @State total: number = 0;
  @State isLoading: boolean = false;
  @State selectedStatus: number | undefined = undefined; // é»˜è®¤æŸ¥å…¨éƒ¨
  // çŠ¶æ€æ˜ å°„å–µ
  private statusMap: Record<number, string> = {
    1: 'å¾…ä»˜æ¬¾',
    2: 'å¾…æ¥å•',
    3: 'å·²æ¥å•',
    4: 'æ´¾é€ä¸­',
    5: 'å·²å®Œæˆ',
    6: 'å·²å–æ¶ˆ'
  };
  private statusColors: Record<number, string> = {
    1: '#FF3B30', // çº¢è‰²
    2: '#FFCC00', // é»„è‰²
    3: '#007AFF', // è“è‰²
    4: '#5856D6', // ç´«è‰²
    5: '#4CD964', // ç»¿è‰²
    6: '#999999'  // ç°è‰²
  };

  async aboutToAppear() {
    // ğŸ” å°è¯•è·å–è·¯ç”±ä¼ é€’è¿‡æ¥çš„å‚æ•°
    const params = this.pageStack.getParamByName("OrderHistoryPage") as number[];
    if ( params && params.length > 0 ) {
      // è¿™é‡Œçš„ params å®é™…ä¸Šæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå–ç¬¬ä¸€ä¸ªä½œä¸º status
      // ArkUI è·¯ç”±å‚æ•°ä¼ é€’æœ‰æ—¶å€™ä¼šåŒ…è£…åœ¨æ•°ç»„é‡Œï¼Œæˆ‘ä»¬é˜²å¾¡æ€§å–å€¼å–µ
      const status = params[0];
      if ( typeof status === 'number' ) {
        this.selectedStatus = status;
      }
    }

    this.loadOrders(true);
  }

  /**
   * åŠ è½½è®¢å•æ•°æ®å–µ
   * @param isRefresh æ˜¯å¦é‡ç½®åˆ·æ–°
   */
  async loadOrders(isRefresh: boolean = false) {
    if ( this.isLoading ) {
      return;
    }
    this.isLoading = true;

    if ( isRefresh ) {
      this.currentPage = 1;
      this.orders = [];
    }

    try {
      const result = await OrderService.getHistoryOrders(this.currentPage, this.pageSize, this.selectedStatus);
      if ( result && result.records ) {
        this.orders = this.orders.concat(result.records);
        this.total = result.total;
      }
    } catch ( e ) {
      // Error handling
    } finally {
      this.isLoading = false;
    }
  }

  build() {
    NavDestination() {
      Column() {
        // 1. é¡¶éƒ¨çŠ¶æ€ç­›é€‰å–µ
        Row() {
          this.TabItem('å…¨éƒ¨', undefined)
          this.TabItem('å¾…ä»˜æ¬¾', 1)
          this.TabItem('æ´¾é€ä¸­', 4)
          this.TabItem('å·²å®Œæˆ', 5)
          this.TabItem('å·²å–æ¶ˆ', 6) // æ–°å¢"å·²å–æ¶ˆ"æ ‡ç­¾æ–¹ä¾¿æŸ¥çœ‹é€€æ¬¾/å”®å
        }
        .width('100%')
        .height(44)
        .backgroundColor(Color.White)
        .justifyContent(FlexAlign.SpaceAround)

        // 2. è®¢å•åˆ—è¡¨å–µ
        if ( this.orders.length > 0 ) {
          List({ space: 12 }) {
            ForEach(this.orders, (order: OrderVO) => {
              ListItem() {
                this.OrderCard(order)
              }
            })

            // åŠ è½½æ›´å¤šå–µ
            if ( this.orders.length < this.total ) {
              ListItem() {
                Row() {
                  LoadingProgress().width(20).height(20).margin({ right: 10 })
                  Text('æ­£åœ¨åŠ è½½æ›´å¤šç¾å‘³...').fontSize(14).fontColor('#999')
                }
                .width('100%')
                .justifyContent(FlexAlign.Center)
                .padding(10)
              }
              .onAppear(() => {
                this.currentPage++;
                this.loadOrders();
              })
            }
          }
          .width('100%')
          .layoutWeight(1)
          .padding({
            left: 16,
            right: 16,
            top: 12,
            bottom: 20
          })
          .backgroundColor('#F7F8FA')
          .edgeEffect(EdgeEffect.Spring)
        } else if (!this.isLoading ) {
          // ç©ºçŠ¶æ€å–µ
          Column({ space: 10 }) {
            SymbolGlyph($r('sys.symbol.doc_plaintext'))
              .fontSize(60)
              .fontColor([ '#DDD' ])
            Text('æš‚æ—¶è¿˜æ²¡æœ‰è®¢å•è®°å½•å–µ~')
              .fontSize(14)
              .fontColor('#999')
            Button('å»é€›é€›ç¾å‘³')
              .margin({ top: 10 })
              .backgroundColor('#FFCC00')
              .fontColor('#333')
              .onClick(() => this.pageStack.pop())
          }
          .width('100%')
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)
          .backgroundColor('#F7F8FA')
        } else {
          // åŠ è½½ä¸­å–µ
          Column() {
            LoadingProgress().width(50).height(50)
          }
          .width('100%')
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)
        }
      }
      .width('100%')
      .height('100%')
    }
    .title('æˆ‘çš„è®¢å•')
    .hideTitleBar(false)
  }

  @Builder
  TabItem(label: string, status: number | undefined) {
    Column() {
      Text(label)
        .fontSize(14)
        .fontColor(this.selectedStatus === status ? '#333' : '#666')
        .fontWeight(this.selectedStatus === status ? FontWeight.Bold : FontWeight.Normal)

      if ( this.selectedStatus === status ) {
        Rect()
          .width(20)
          .height(3)
          .fill('#FFCC00')
          .margin({ top: 4 })
          .borderRadius(1.5)
      }
    }
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .onClick(() => {
      this.selectedStatus = status;
      this.loadOrders(true);
    })
  }

  @Builder
  OrderCard(order: OrderVO) {
    Column() {
      // å¡ç‰‡å¤´éƒ¨ï¼šåº—é“ºåç§°ä¸çŠ¶æ€
      Row() {
        Image($r('app.media.shop_logo')) // å‡è®¾æœ‰ä¸ªåº—é“ºlogoå ä½ï¼Œæˆ–è€…ç›´æ¥ç”¨å›¾æ ‡
          .width(20).height(20)
          .objectFit(ImageFit.Contain)
          .margin({ right: 5 })
          .visibility(Visibility.None) // æš‚æ—¶éšè—ï¼Œå¦‚æœæ²¡æœ‰åˆé€‚çš„å›¾æ ‡

        Row() {
          Text(order.shopName || 'è‹ç©¹å¤–å–å•†å®¶') // ğŸ¢ å±•ç¤ºåº—é“ºåç§°å–µ
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333')
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .layoutWeight(1)

          SymbolGlyph($r('sys.symbol.chevron_right')) // âœ¨ åŠ ä¸ªå°ç®­å¤´æé†’è·³è½¬å–µï¼
            .fontSize(16)
            .fontColor(['#999'])
            .margin({ left: 2, right: 10 })
        }
        .layoutWeight(1)
        .hitTestBehavior(HitTestMode.Block) // âœ¨ ä½¿ç”¨ HitTestMode.Block é˜»æ­¢äº‹ä»¶ç©¿é€å–µï¼
        .onClick(() => {
           if (order.shopId) {
             this.pageStack.pushPath({ name: 'ShopPage', param: order.shopId });
           } else {
             promptAction.showToast({ message: 'æ— æ³•è·³è½¬ï¼Œåº—é“ºIDä¸¢å¤±å–µğŸ˜¿' });
           }
        })
          
        // çŠ¶æ€æ˜¾ç¤º
        Row() {
          Text(this.statusMap[order.status] || 'æœªçŸ¥çŠ¶æ€')
            .fontSize(14)
            .fontColor(this.statusColors[order.status] || '#333')
            .fontWeight(FontWeight.Medium)
          
          if ( order.status === 4 ) { // æ´¾é€ä¸­æ˜¾ç¤ºä¸ªå°å›¾æ ‡
             SymbolGlyph($r('sys.symbol.paperplane'))
               .fontSize(14)
               .fontColor([ this.statusColors[order.status] ])
               .margin({ left: 2 })
          }
        }
      }
      .width('100%')
      .alignItems(VerticalAlign.Center)
      .margin({ bottom: 4 })

      // è®¢å•å· (ç¨å¾®å°ä¸€ç‚¹æ˜¾ç¤ºåœ¨åº—é“ºåä¸‹é¢)
      Text(`è®¢å•å·: ${ order.number }`)
        .fontSize(12)
        .fontColor('#999')
        .margin({ bottom: 12 })

      // å¡ç‰‡å†…å®¹ï¼šå•†å“é¢„è§ˆ
      Column({ space: 8 }) {
        ForEach(order.orderDetailList.slice(0, 3), (detail: OrderDetailVO) => {
          Row() {
            Text(detail.name).fontSize(15).fontColor('#333').layoutWeight(1)
            Text(`x${ detail.number }`).fontSize(14).fontColor('#666')
          }.width('100%')
        })

        if ( order.orderDetailList.length > 3 ) {
          Text(`æŸ¥çœ‹å…¨éƒ¨ ${ order.orderDetailList.length } ä»¶å•†å“...`)
            .fontSize(12)
            .fontColor('#999')
            .margin({ top: 2 })
        }
      }
      .width('100%')

      Divider().margin({ top: 12, bottom: 12 }).color('#F2F2F2')

      // å¡ç‰‡åº•éƒ¨ï¼šæ—¶é—´ä¸åˆè®¡
      Row() {
        Text(order.orderTime).fontSize(12).fontColor('#999').layoutWeight(1)

        Row() {
          Text('åˆè®¡:').fontSize(12).fontColor('#666')
          Text(`ï¿¥${ order.amount ? order.amount.toFixed(2) : '0.00' }`)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333')
            .margin({ left: 4 })
        }
      }
      .width('100%')
    }
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .onClick(() => {
      // âœ¨ è·³è½¬åˆ°è®¢å•è¯¦æƒ…é¡µï¼Œå¹¶ä¼ é€’æ•´ä¸ª OrderVO å¯¹è±¡
      this.pageStack.pushPath({ name: 'OrderDetailPage', param: [order] });
    })
  }
}

@Builder
export function OrderHistoryPageBuilder() {
  OrderHistoryPage()
}
