import { promptAction } from '@kit.ArkUI';
import { OrderDetailVO, OrderVO, OrderCancelDTO } from '../../model/api/OrderModel';
import { OrderService } from '../../service/OrderService';
import { PaymentPageParams } from './PaymentPage'; // âœ¨ å¼•å…¥ PaymentPageParams

/**
 * ğŸ“œ è®¢å•å†å²é¡µé¢
 */
@Component
export struct OrderHistoryPage {
  @Consume('pageStack') pageStack: NavPathStack;
  @State orders: OrderVO[] = [];
  @State currentPage: number = 1;
  @State pageSize: number = 10;
  @State total: number = 0;
  @State isLoading: boolean = false;
  @State selectedStatus: number | undefined = undefined; // é»˜è®¤æŸ¥å…¨éƒ¨
  
  private statusMap: Record<number, string> = {
    1: 'å¾…ä»˜æ¬¾',
    2: 'å¾…æ¥å•',
    3: 'å·²æ¥å•',
    4: 'æ´¾é€ä¸­',
    5: 'å·²å®Œæˆ',
    6: 'å·²å–æ¶ˆ'
  };
  private statusColors: Record<number, string> = {
    1: '#FF3B30',
    2: '#FFCC00',
    3: '#007AFF',
    4: '#5856D6',
    5: '#4CD964',
    6: '#999999'
  };

  async aboutToAppear() {
    const params = this.pageStack.getParamByName("OrderHistoryPage") as number[];
    if ( params && params.length > 0 ) {
      const status = params[0];
      if ( typeof status === 'number' ) {
        this.selectedStatus = status;
      }
    }
    this.loadOrders(true);
  }

  async loadOrders(isRefresh: boolean = false) {
    if ( this.isLoading ) return;
    this.isLoading = true;
    if ( isRefresh ) {
      this.currentPage = 1;
      this.orders = [];
    }
    try {
      const result = await OrderService.getHistoryOrders(this.currentPage, this.pageSize, this.selectedStatus);
      if ( result && result.records ) {
        this.orders = this.orders.concat(result.records);
        this.total = result.total;
      }
    } catch ( e ) {
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * âŒ å–æ¶ˆè®¢å•
   */
  async handleCancelOrder(orderId: number, status: number) {
    promptAction.showDialog({
      title: 'ç¡®è®¤å–æ¶ˆè®¢å•å—ï¼Ÿ',
      message: status === 2 ? 'è®¢å•å·²æ”¯ä»˜ï¼Œå–æ¶ˆåå°†åŸè·¯é€€æ¬¾å–µã€‚' : 'å–æ¶ˆåè®¢å•å°†å¤±æ•ˆå–µã€‚',
      buttons: [
        { text: 'å†æƒ³æƒ³', color: '#666666' },
        { text: 'ç¡®è®¤å–æ¶ˆ', color: '#FF3B30' }
      ]
    }).then(async (data) => {
      if (data.index === 1) {
        this.showReasonSheet(orderId);
      }
    });
  }

  showReasonSheet(orderId: number) {
    const reasons = [
      'ä¸æƒ³è¦äº†/æ‹é”™å•',
      'åœ°å€/ç”µè¯ä¿¡æ¯å¡«å†™é”™è¯¯',
      'å¿˜è®°ä½¿ç”¨ä¼˜æƒ åˆ¸',
      'é€è¾¾æ—¶é—´å¤ªé•¿',
      'å…¶ä»–åŸå› '
    ];

    promptAction.showActionMenu({
      title: 'è¯·é€‰æ‹©å–æ¶ˆåŸå› ',
      // âœ¨ ç›´æ¥ä½¿ç”¨å­—é¢é‡æ•°ç»„
      buttons: [
        { text: reasons[0], color: '#333333' },
        { text: reasons[1], color: '#333333' },
        { text: reasons[2], color: '#333333' },
        { text: reasons[3], color: '#333333' },
        { text: reasons[4], color: '#333333' }
      ]
    }).then(async (data) => {
      const selectedReason = reasons[data.index];
      this.executeCancel(orderId, selectedReason);
    }).catch(() => {
      console.info('ç”¨æˆ·å–æ¶ˆäº†åŸå› é€‰æ‹©');
    });
  }

  async executeCancel(orderId: number, reason: string) {
    try {
      const dto = new OrderCancelDTO(orderId, reason);
      await OrderService.cancelOrder(dto);
      promptAction.showToast({ message: 'è®¢å•å·²å–æ¶ˆå–µ' });
      this.loadOrders(true); // åˆ·æ–°åˆ—è¡¨
    } catch (e) {
      console.error('å–æ¶ˆè®¢å•å¤±è´¥:', e);
      promptAction.showToast({ message: 'æ“ä½œå¤±è´¥å–µ' });
    }
  }

  build() {
    NavDestination() {
      Column() {
        Row() {
          this.TabItem('å…¨éƒ¨', undefined)
          this.TabItem('å¾…ä»˜æ¬¾', 1)
          this.TabItem('æ´¾é€ä¸­', 4)
          this.TabItem('å·²å®Œæˆ', 5)
          this.TabItem('å·²å–æ¶ˆ', 6)
        }
        .width('100%')
        .height(44)
        .backgroundColor(Color.White)
        .justifyContent(FlexAlign.SpaceAround)

        if ( this.orders.length > 0 ) {
          List({ space: 12 }) {
            ForEach(this.orders, (order: OrderVO) => {
              ListItem() {
                this.OrderCard(order)
              }
            })
            if ( this.orders.length < this.total ) {
              ListItem() {
                Row() {
                  LoadingProgress().width(20).height(20).margin({ right: 10 })
                  Text('æ­£åœ¨åŠ è½½æ›´å¤šç¾å‘³...').fontSize(14).fontColor('#999')
                }
                .width('100%')
                .justifyContent(FlexAlign.Center)
                .padding(10)
              }
              .onAppear(() => {
                this.currentPage++;
                this.loadOrders();
              })
            }
          }
          .width('100%')
          .layoutWeight(1)
          .padding({ left: 16, right: 16, top: 12, bottom: 20 })
          .backgroundColor('#F7F8FA')
          .edgeEffect(EdgeEffect.Spring)
        } else if (!this.isLoading ) {
          Column({ space: 10 }) {
            SymbolGlyph($r('sys.symbol.doc_plaintext'))
              .fontSize(60)
              .fontColor([ '#DDD' ])
            Text('æš‚æ—¶è¿˜æ²¡æœ‰è®¢å•è®°å½•å–µ~')
              .fontSize(14)
              .fontColor('#999')
            Button('å»é€›é€›ç¾å‘³')
              .margin({ top: 10 })
              .backgroundColor('#FFCC00')
              .fontColor('#333')
              .onClick(() => this.pageStack.pop())
          }
          .width('100%')
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)
          .backgroundColor('#F7F8FA')
        } else {
          Column() {
            LoadingProgress().width(50).height(50)
          }
          .width('100%')
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)
        }
      }
      .width('100%')
      .height('100%')
    }
    .title('æˆ‘çš„è®¢å•')
    .hideTitleBar(false)
  }

  @Builder
  TabItem(label: string, status: number | undefined) {
    Column() {
      Text(label)
        .fontSize(14)
        .fontColor(this.selectedStatus === status ? '#333' : '#666')
        .fontWeight(this.selectedStatus === status ? FontWeight.Bold : FontWeight.Normal)
      if ( this.selectedStatus === status ) {
        Rect()
          .width(20)
          .height(3)
          .fill('#FFCC00')
          .margin({ top: 4 })
          .borderRadius(1.5)
      }
    }
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .onClick(() => {
      this.selectedStatus = status;
      this.loadOrders(true);
    })
  }

  @Builder
  OrderCard(order: OrderVO) {
    Column() {
      Row() {
        Row() {
          Text(order.shopName || 'è‹ç©¹å¤–å–å•†å®¶')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333')
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .layoutWeight(1)
          SymbolGlyph($r('sys.symbol.chevron_right'))
            .fontSize(16)
            .fontColor([ '#999' ])
            .margin({ left: 2, right: 10 })
        }
        .layoutWeight(1)
        .onClick(() => {
          if ( order.shopId ) {
            this.pageStack.pushPath({ name: 'ShopPage', param: order.shopId });
          }
        })
        Row() {
          Text(this.statusMap[order.status] || 'æœªçŸ¥çŠ¶æ€')
            .fontSize(14)
            .fontColor(this.statusColors[order.status] || '#333')
            .fontWeight(FontWeight.Medium)
          if ( order.status === 4 ) {
            SymbolGlyph($r('sys.symbol.paperplane'))
              .fontSize(14)
              .fontColor([ this.statusColors[order.status] ])
              .margin({ left: 2 })
          }
        }
      }
      .width('100%')
      .alignItems(VerticalAlign.Center)
      .margin({ bottom: 4 })

      Text(`è®¢å•å·: ${ order.number }`)
        .fontSize(12)
        .fontColor('#999')
        .margin({ bottom: 12 })

      Column({ space: 8 }) {
        ForEach(order.orderDetailList.slice(0, 3), (detail: OrderDetailVO) => {
          Row() {
            Text(detail.name).fontSize(15).fontColor('#333').layoutWeight(1)
            Text(`x${ detail.number }`).fontSize(14).fontColor('#666')
          }.width('100%')
        })
        if ( order.orderDetailList.length > 3 ) {
          Text(`æŸ¥çœ‹å…¨éƒ¨ ${ order.orderDetailList.length } ä»¶å•†å“...`)
            .fontSize(12)
            .fontColor('#999')
            .margin({ top: 2 })
        }
      }
      .width('100%')

      Divider().margin({ top: 12, bottom: 12 }).color('#F2F2F2')

      Row() {
        Text(order.orderTime).fontSize(12).fontColor('#999').layoutWeight(1)
        Row() {
          Text('åˆè®¡:').fontSize(12).fontColor('#666')
          Text(`ï¿¥${ order.amount ? order.amount.toFixed(2) : '0.00' }`)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333')
            .margin({ left: 4 })
        }
      }
      .width('100%')

      // âœ¨ æ“ä½œæŒ‰é’®åŒºåŸŸ
      if (order.status === 1 || order.status === 2) {
        Row({ space: 10 }) {
          Blank()
          Button('å–æ¶ˆè®¢å•')
            .height(28)
            .fontSize(12)
            .backgroundColor(Color.White)
            .fontColor('#666')
            .border({ width: 0.5, color: '#ccc' })
            .onClick((e) => {
              // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°å¡ç‰‡ç‚¹å‡»
              this.handleCancelOrder(order.id, order.status);
            })
          
          if (order.status === 1) {
            Button('å»æ”¯ä»˜')
              .height(28)
              .fontSize(12)
              .backgroundColor('#FFCC00')
              .fontColor('#333')
              .onClick(() => {
                const params: PaymentPageParams = {
                  orderId: order.id,
                  orderNumber: order.number,
                  payMethod: 2,
                  totalAmount: order.amount
                };
                this.pageStack.pushPath({ name: 'PaymentPage', param: params });
              })
          }
        }
        .width('100%')
        .margin({ top: 12 })
      }
    }
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .onClick(() => {
      this.pageStack.pushPath({ name: 'OrderDetailPage', param: [ order ] });
    })
  }
}

@Builder
export function OrderHistoryPageBuilder() {
  OrderHistoryPage()
}