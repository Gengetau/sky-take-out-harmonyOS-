/**
 * é¦–é¡µ
 */
import { promptAction } from '@kit.ArkUI';
import { ShopTypeVO } from '../../model/entity/ShopTypeModel';
import { HomeService } from '../../service/HomeService';

// ğŸ’¡ é¢„è§ˆæ¨¡å¼ï¼šåŠ ä¸Šè¿™ä¸ªï¼
@Component
export struct HomePageContent {
  @Consume('pageStack') pageStack: NavPathStack;
  // 1. è½®æ’­å›¾æ•°æ®
  private bannerList: Resource[] = [
    $r('app.media.banner1'),
    $r('app.media.banner2'),
    $r('app.media.banner3'),
    $r('app.media.banner4')
  ];
  // åŸå§‹æ•°æ® (å‡è®¾æœ‰ 15 ä¸ª)
  @State rawGridItems: ShopTypeVO[] = [];
  // âœ‚ï¸ åˆ‡åˆ†åçš„äºŒç»´æ•°ç»„ (Swiper çš„æ•°æ®æº)
  @State pagedGridItems: ShopTypeVO[][] = [];

  async aboutToAppear() {
    this.queryShopTypes();
  }

  async queryShopTypes() {
    // ğŸ‘‡ è¿™é‡Œå°±æ˜¯æŠ¥é”™çš„åœ°æ–¹ (Line 154)
    // ä»¥å‰å¯èƒ½å†™äº† throw new Error('Function not implemented') æˆ–è€…è°ƒäº†ç©ºçš„ HttpUtil.get

    // âœ… ç°åœ¨æ”¹æˆè°ƒç”¨ Service
    const data = await HomeService.getShopTypes();

    if ( data.length > 0 ) {
      this.rawGridItems = data;
      // åˆ‡å‰²æ•°æ®ï¼(æŒ‰æ¯é¡µ 10 ä¸ªåˆ‡åˆ†ï¼š2è¡Œ x 5åˆ—)
      this.pagedGridItems = chunkArray(this.rawGridItems, 10);
    } else {
      // å¦‚æœæ²¡æ‹¿åˆ°æ•°æ®ï¼Œå¯ä»¥å¡ç‚¹å‡æ•°æ®å…œåº•ï¼Œé˜²æ­¢é¡µé¢ç©ºç©ºçš„
      // this.entryList = [ ... mock data ... ]
    }
  }

  build() {
    Column() {
      // --- 1. é¡¶éƒ¨æœç´¢æ  (å›ºå®šåœ¨é¡¶éƒ¨) ---
      this.TopSearchBar()

      // --- 2. å¯æ»šåŠ¨åŒºåŸŸ ---
      Scroll() {
        Column({ space: 15 }) {

          // (1) è½®æ’­å›¾ Banner
          Swiper() {
            ForEach(this.bannerList, (img: Resource) => {
              Image(img)
                .width('100%')
                .height(160)
                .objectFit(ImageFit.Cover)
                .borderRadius(12)
                .onClick(() => {
                  this.pageStack.pushPath({ name: 'ShopPage' }, true)
                })
            })
          }
          .autoPlay(true)
          .interval(3000)
          .indicator(true) // æ˜¾ç¤ºæŒ‡ç¤ºç‚¹
          .width('100%')
          .margin({ top: 10 })

          // è½®æ’­ç¿»é¡µå®¹å™¨
          Swiper() {
            // ç¬¬ä¸€å±‚å¾ªç¯ï¼šéå†â€œé¡µâ€
            ForEach(this.pagedGridItems, (pageItems: ShopTypeVO[]) => {

              // æ¯ä¸€é¡µæ˜¯ä¸€ä¸ª Grid
              Grid() {
                // ç¬¬äºŒå±‚å¾ªç¯ï¼šéå†â€œé¡µå†…çš„å›¾æ ‡â€
                ForEach(pageItems, (item: ShopTypeVO) => {
                  GridItem() {
                    Column({ space: 6 }) {
                      Image(item.icon)
                        .width(40).height(40)
                        .objectFit(ImageFit.Contain)
                      Text(item.name)
                        .fontSize(12)
                        .fontColor('#333333')
                    }
                  }
                }, (item: ShopTypeVO) => item.id.toString())
              }
              .columnsTemplate('1fr 1fr 1fr 1fr 1fr') // 5åˆ—
              .rowsTemplate('1fr 1fr') // 2è¡Œ
              .rowsGap(1)
              .width('100%')
              .height('80%') // å æ»¡ Swiper ç»™çš„é«˜åº¦

            })
          }
          .height(220) // Swiper çš„æ€»é«˜åº¦ (è¦å®¹çº³ Grid + æŒ‡ç¤ºç‚¹)
          .autoPlay(false) // èœå•é€šå¸¸ä¸è‡ªåŠ¨è½®æ’­
          .loop(false) // èœå•é€šå¸¸ä¸å¾ªç¯ï¼Œæ»‘åˆ°å¤´å°±åœ
          .indicator( // è‡ªå®šä¹‰æŒ‡ç¤ºç‚¹æ ·å¼
            Indicator.dot()
              .itemWidth(8)
              .itemHeight(4)
              .selectedItemWidth(12)
              .selectedItemHeight(4)
              .color('#CCCCCC')
              .selectedColor('#0D9FFB') // é€‰ä¸­å˜è“
          )
          .width('100%')

          // (4) ç€‘å¸ƒæµ/åˆ—è¡¨ (å ä½)
          // è¿™é‡Œä»¥åå¯ä»¥æ”¾ List æˆ–è€… WaterFlow
          ForEach([ 1, 2, 3, 4, 5 ], (item: number) => {
            this.RecommendItem()
          })
        }
        .padding({ left: 12, right: 12, bottom: 20 }) // ç»™å†…å®¹åŠ ç‚¹è¾¹è·
      }
      .layoutWeight(1) // å æ®å‰©ä½™é«˜åº¦
      .scrollBar(BarState.Off) // éšè—æ»šåŠ¨æ¡
      .align(Alignment.Top)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F6F6F6') // æµ…ç°åº•è‰²ï¼Œæ›´æœ‰å±‚æ¬¡æ„Ÿ
  }

  // ğŸ¨ æŠ½å–ï¼šé¡¶éƒ¨æœç´¢æ ç»„ä»¶
  @Builder
  TopSearchBar() {
    Row({ space: 10 }) {
      // å®šä½
      Column() {
        Text('åŒ—äº¬')
          .fontSize(14).fontWeight(FontWeight.Bold)
        Text('æœé˜³åŒº...')
          .fontSize(10).fontColor('#666666')
      }

      // æœç´¢æ¡† (ä¼ªè£…æˆè¾“å…¥æ¡†çš„æŒ‰é’®)
      Row() {
        Image($r('sys.symbol.magnifyingglass')) // ç³»ç»Ÿæœç´¢å›¾æ ‡
          .width(16).height(16).fillColor('#999999')
          .margin({ left: 10, right: 5 })
        Text('æœç´¢ç¾é£Ÿã€å•†å®¶')
          .fontSize(12).fontColor('#999999')
      }
      .layoutWeight(1) // æ’‘æ»¡ä¸­é—´
      .height(36)
      .backgroundColor('#FFFFFF')
      .borderRadius(18)
      .onClick(() => {
        promptAction.showToast({ message: 'å»æœç´¢é¡µå–µï¼' })
      })

      // æ¶ˆæ¯å›¾æ ‡
      SymbolGlyph($r('sys.symbol.bell'))
        .fontSize(24)
        .fontColor([ '#333333' ])
    }
    .width('100%')
    .padding({
      left: 12,
      right: 12,
      top: 10,
      bottom: 10
    })
    .backgroundColor('#F6F6F6') // ä¸èƒŒæ™¯åŒè‰²ï¼Œæˆ–è€…ç™½è‰²
  }

  // ğŸ¨ æŠ½å–ï¼šæ¨èå•†å“å¡ç‰‡
  @Builder
  RecommendItem() {
    Row() {
      // è¿™é‡Œå¯ä»¥æ¨¡ä»¿ä¹‹å‰å†™çš„ IndexListItemUIï¼Œå·¦å›¾å³æ–‡
      Image($r('app.media.fig1'))
        .width(80).height(80).borderRadius(8)
        .margin({ right: 10 })
      Column() {
        Text('ç¾å‘³å¤§æ±‰å ¡').fontSize(16).fontWeight(FontWeight.Bold)
        Text('æœˆå”® 1000+').fontSize(12).fontColor('#999999').margin({ top: 5 })
        Text('Â¥ 19.9').fontSize(16).fontColor('#FF0000').margin({ top: 10 })
      }.alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .padding(10)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ bottom: 10 })
  }
}

/**
 * swiper æ•°æ®åˆ†ç»„
 * @param source æºæ•°ç»„
 * @param size æ¯é¡µå¤§å° (æ¯”å¦‚ 10)
 */
function chunkArray<T>(source: T[], size: number): T[][] {
  const result: T[][] = [];
  for ( let i = 0; i < source.length; i += size ) {
    result.push(source.slice(i, i + size));
  }
  return result;
}
