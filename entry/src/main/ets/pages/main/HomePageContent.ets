import { common } from '@kit.AbilityKit';
import { promptAction } from '@kit.ArkUI';
import { GeoPoint, LocationUtil } from '../../common/utils/LocationUtil';
import { LocationInfo } from '../../model/entity/LocationInfo';
import { ShopVO } from '../../model/entity/ShopModel';
import { ShopTypeVO } from '../../model/entity/ShopTypeModel';
import { HomeService } from '../../service/HomeService';
import { ShopService } from '../../service/ShopService';

/**
 * é¦–é¡µ - å¤šå•†åº—å¹³å°é‡æž„ç‰ˆ âœ¨
 */
@Component
export struct HomePageContent {
  @Consume('pageStack') pageStack: NavPathStack;
  // 1. è½®æ’­å›¾æ•°æ®
  private bannerList: Resource[] = [
    $r('app.media.banner1'),
    $r('app.media.banner2'),
    $r('app.media.banner3'),
    $r('app.media.banner4')
  ];
  // 2. çŠ¶æ€ç®¡ç†
  @State rawGridItems: ShopTypeVO[] = [];
  @State pagedGridItems: ShopTypeVO[][] = [];
  @State shops: ShopVO[] = [];
  @State isLoadingShops: boolean = false;
  @State currentTypeId: number = 1;
  // ðŸ“ åæ ‡ä¿¡æ¯
  @State longitude: number = 116.397428;
  @State latitude: number = 39.90923;
  @State locationName: string = 'æ­£åœ¨å®šä½...';
  // ðŸ”— ç›‘å¬å…¨å±€é€‰ä¸­çš„ä½ç½®
  @StorageLink('SelectedLocation') @Watch('onManualLocationChange') selectedLocation: LocationInfo | null = null;
  // ðŸŽ¨ è‡ªå®šä¹‰ä½ç½®é€‰æ‹©å¼¹çª—æŽ§åˆ¶å™¨
  dialogController: CustomDialogController = new CustomDialogController({
    builder: LocationPickerDialog({
      onSelectGPS: () => {
        this.handleGetLocation()
      },
      onSelectMap: () => {
        this.pageStack.pushPath({ name: 'AddressMapPage' })
      }
    }),
    alignment: DialogAlignment.Bottom,
    customStyle: true,
    autoCancel: true,
    maskColor: '#80000000'
  })

  async aboutToAppear() {
    await this.queryShopTypes();
    if (!this.selectedLocation ) {
      this.handleGetLocation();
    } else {
      this.onManualLocationChange();
    }
  }

  onManualLocationChange() {
    if ( this.selectedLocation ) {
      this.latitude = this.selectedLocation.latitude;
      this.longitude = this.selectedLocation.longitude;
      this.locationName = this.selectedLocation.name;
      this.fetchShops(this.currentTypeId);
    }
  }

  async handleGetLocation() {
    const context = getContext(this) as common.UIAbilityContext;
    this.locationName = 'æ­£åœ¨å®šä½...';
    try {
      const point: GeoPoint | null = await LocationUtil.getCurrentLocation(context);

      if ( point ) {
        this.latitude = point.latitude;
        this.longitude = point.longitude;

        const address = await LocationUtil.getAddressFromLocation(this.latitude, this.longitude);
        this.locationName = address;

        this.fetchShops(this.currentTypeId);
      } else {
        this.locationName = 'å®šä½å¤±è´¥';
        promptAction.showToast({ message: 'å®šä½æƒé™æœªå¼€å¯å–µ' });
      }
    } catch ( e ) {
      this.locationName = 'å®šä½å¤±è´¥å–µ';
    }
  }

  async queryShopTypes() {
    const data = await HomeService.getShopTypes();
    if ( data.length > 0 ) {
      this.rawGridItems = data;
      this.pagedGridItems = chunkArray(this.rawGridItems, 10);

      this.currentTypeId = data[0].id;
      this.fetchShops(this.currentTypeId);
    }
  }

  async fetchShops(typeId: number) {
    this.isLoadingShops = true;
    this.currentTypeId = typeId;
    try {
      const shopList = await ShopService.getShopList(typeId, this.longitude, this.latitude);
      this.shops = shopList;
    } catch ( e ) {
      console.error('èŽ·å–å•†å®¶åˆ—è¡¨å¤±è´¥å–µ', e);
    } finally {
      this.isLoadingShops = false;
    }
  }

  build() {
    Column() {
      // --- 1. é¡¶éƒ¨å…¨æ–°å¸ƒå±€ (åœ°å€ç‹¬å ä¸€è¡Œå–µ) ---
      this.TopHeader()

      // --- 2. å¯æ»šåŠ¨åŒºåŸŸ ---
      Scroll() {
        Column() {
          // (1) è½®æ’­å›¾ Banner
          Swiper() {
            ForEach(this.bannerList, (img: Resource) => {
              Image(img)
                .width('100%')
                .height(160)
                .objectFit(ImageFit.Cover)
                .borderRadius(12)
            })
          }
          .autoPlay(true)
          .interval(3000)
          .indicator(true)
          .width('100%')
          .margin({ top: 10 })

          // (2) é‡‘åˆšåŒºåˆ†ç±»èœå•
          Swiper() {
            ForEach(this.pagedGridItems, (pageItems: ShopTypeVO[]) => {
              Grid() {
                ForEach(pageItems, (item: ShopTypeVO) => {
                  GridItem() {
                    Column({ space: 6 }) {
                      Image(item.icon)
                        .width(40).height(40)
                        .objectFit(ImageFit.Contain)
                      Text(item.name)
                        .fontSize(12)
                        .fontColor(this.currentTypeId === item.id ? '#0D9FFB' : '#333')
                        .fontWeight(this.currentTypeId === item.id ? FontWeight.Bold : FontWeight.Normal)
                    }
                    .onClick(() => this.fetchShops(item.id))
                  }
                }, (item: ShopTypeVO) => item.id.toString())
              }
              .columnsTemplate('1fr 1fr 1fr 1fr 1fr')
              .rowsTemplate('1fr 1fr')
              .rowsGap(10)
              .width('100%')
              .height(160)
            })
          }
          .height(200)
          .autoPlay(false)
          .loop(false)
          .indicator(
            Indicator.dot()
              .itemWidth(8)
              .itemHeight(4)
              .selectedItemWidth(12)
              .selectedItemHeight(4)
              .color('#CCCCCC')
              .selectedColor('#0D9FFB')
          )
          .margin({ top: 15 })

          // (3) é™„è¿‘çš„å•†å®¶æ ‡é¢˜
          Row() {
            Text('é™„è¿‘çš„å•†å®¶')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333')
            Blank()
            Text('ç»¼åˆæŽ’åº')
              .fontSize(12)
              .fontColor('#666')
            SymbolGlyph($r('sys.symbol.chevron_down')).fontSize(12).fontColor([ '#666' ])
          }
          .width('100%')
          .margin({ top: 20, bottom: 10 })

          // (4) å•†å®¶åˆ—è¡¨å–µ
          if ( this.isLoadingShops ) {
            Column() {
              LoadingProgress().width(40).height(40).color('#0D9FFB')
            }.width('100%').margin({ top: 20 })
          } else if ( this.shops.length > 0 ) {
            Column() {
              ForEach(this.shops, (shop: ShopVO) => {
                this.ShopItem(shop)
              })
            }
            .width('100%')
          } else {
            Column({ space: 10 }) {
              Image($r('app.media.miniLogo')).width(60).opacity(0.3)
              Text('é™„è¿‘æš‚æ—¶æ²¡æœ‰è¯¥ç±»å•†å®¶å–µ~').fontSize(14).fontColor('#999')
            }
            .width('100%')
            .margin({ top: 40 })
          }
        }
        .padding({ left: 12, right: 12, bottom: 30 })
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
      .align(Alignment.Top)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F6F6F6')
  }

  // ðŸŽ¨ å…¨æ–°é¡¶éƒ¨ç»„ä»¶å–µ
  @Builder
  TopHeader() {
    Column() {
      // ç¬¬ä¸€è¡Œï¼šåœ°å€å®šä½å–µ
      Row() {
        SymbolGlyph($r('sys.symbol.local_fill'))
          .fontSize(18)
          .fontColor([ '#333' ])
          .margin({ right: 6 })

        Text(this.locationName)
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .layoutWeight(1)

        SymbolGlyph($r('sys.symbol.chevron_right'))
          .fontSize(14)
          .fontColor([ '#666' ])
      }
      .width('100%')
      .padding({
        left: 12,
        right: 12,
        top: 12,
        bottom: 8
      })
      .onClick(() => {
        // æ‰“å¼€ç¾ŽåŒ–åŽçš„è‡ªå®šä¹‰å¼¹çª—
        this.dialogController.open()
      })

      // ç¬¬äºŒè¡Œï¼šæœç´¢æ¡†ä¸Žæ¶ˆæ¯å–µ
      Row({ space: 12 }) {
        Row() {
          Image($r('sys.symbol.magnifyingglass'))
            .width(16).height(16).fillColor('#999999')
            .margin({ left: 10, right: 5 })
          Text('æœç´¢ç¾Žé£Ÿã€å•†å®¶')
            .fontSize(12).fontColor('#999999')
        }
        .layoutWeight(1)
        .height(36)
        .backgroundColor('#FFFFFF')
        .borderRadius(18)

        SymbolGlyph($r('sys.symbol.bell'))
          .fontSize(24)
          .fontColor([ '#333333' ])
      }
      .width('100%')
      .padding({
        left: 12,
        right: 12,
        top: 4,
        bottom: 12
      })
    }
    .backgroundColor('#F6F6F6')
  }

  // ðŸŽ¨ å•†å®¶å¡ç‰‡
  @Builder
  ShopItem(shop: ShopVO) {
    Row() {
      Image(shop.avatar || $r('app.media.shop_logo'))
        .width(100)
        .height(100)
        .borderRadius(8)
        .margin({ right: 12 })
        .objectFit(ImageFit.Cover)

      Column({ space: 5 }) {
        Text(shop.name)
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        Row({ space: 8 }) {
          Row({ space: 2 }) {
            SymbolGlyph($r('sys.symbol.star_fill')).fontSize(12).fontColor([ '#FFCC00' ])
            Text(shop.score.toFixed(1)).fontSize(12).fontColor('#FFCC00').fontWeight(FontWeight.Bold)
          }

          Text(`æœˆå”® ${ shop.monthlySales }`).fontSize(12).fontColor('#666')
        }

        Row() {
          Text(`èµ·é€ ï¿¥${ shop.deliveryPrice }`).fontSize(11).fontColor('#666')
          Divider().vertical(true).height(10).margin({ left: 6, right: 6 }).color('#DDD')
          Text(`é…é€ ï¿¥${ shop.shippingFee }`).fontSize(11).fontColor('#666')
        }

        Row() {
          if ( shop.distance ) {
            Text(shop.distance).fontSize(11).fontColor('#0D9FFB')
            Divider().vertical(true).height(10).margin({ left: 6, right: 6 }).color('#DDD')
          }
          Text(`${ shop.averageDeliveryTime } åˆ†é’Ÿ`).fontSize(11).fontColor('#666')
        }
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
    }
    .width('100%')
    .padding(12)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ bottom: 12 })
    .onClick(() => {
      this.pageStack.pushPath({ name: 'ShopPage', param: shop.id }, true)
    })
  }
}

/**
 * âœ¨ ç¾ŽåŒ–åŽçš„è‡ªå®šä¹‰ä½ç½®é€‰æ‹©å¼¹çª—
 */
@CustomDialog
struct LocationPickerDialog {
  controller: CustomDialogController
  onSelectGPS: () => void = () => {
  }
  onSelectMap: () => void = () => {
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('é€‰æ‹©é€è´§ä½ç½®')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')

        Blank()

        // å…³é—­æŒ‰é’®
        SymbolGlyph($r('sys.symbol.xmark'))
          .fontSize(20)
          .fontColor([ '#999' ])
          .onClick(() => {
            this.controller.close()
          })
      }
      .width('100%')
      .padding({
        top: 20,
        bottom: 20,
        left: 20,
        right: 20
      })

      // é€‰é¡¹åˆ—è¡¨
      Column({ space: 12 }) {
        // é€‰é¡¹ 1: è‡ªåŠ¨å®šä½
        this.OptionItem({
          icon: $r('sys.symbol.position'),
          title: 'é‡æ–°å®šä½å½“å‰ä½ç½®',
          subtitle: 'åŸºäºŽGPSè‡ªåŠ¨èŽ·å–',
          color: '#0D9FFB',
          onClick: () => {
            this.onSelectGPS()
            this.controller.close()
          }
        })

        // é€‰é¡¹ 2: åœ°å›¾é€‰ç‚¹
        this.OptionItem({
          icon: $r('sys.symbol.map'),
          title: 'åœ¨åœ°å›¾ä¸Šé€‰æ‹©ä½ç½®',
          subtitle: 'æ‰‹åŠ¨æ‹–åŠ¨åœ°å›¾å®šä½',
          color: '#FFCC00',
          onClick: () => {
            this.onSelectMap()
            this.controller.close()
          }
        })
      }
      .padding({ left: 16, right: 16, bottom: 30 })
    }
    .width('100%')
    .backgroundColor(Color.White)
    .borderRadius({ topLeft: 24, topRight: 24 })
  }

  @Builder
  OptionItem(params: OptionItemParams) {
    Row() {
      // å›¾æ ‡å®¹å™¨
      Stack({ alignContent: Alignment.Center }) {
        Circle({ width: 44, height: 44 })
          .fill(params.color)
          .opacity(0.1)
        SymbolGlyph(params.icon)
          .fontSize(24)
          .fontColor([ params.color ])
      }
      .margin({ right: 16 })

      // æ–‡å­—ä¿¡æ¯
      Column({ space: 4 }) {
        Text(params.title)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333')
        Text(params.subtitle)
          .fontSize(12)
          .fontColor('#999')
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      // ç®­å¤´
      SymbolGlyph($r('sys.symbol.chevron_right'))
        .fontSize(16)
        .fontColor([ '#CCC' ])
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#F9F9F9')
    .borderRadius(16)
    .onClick(() => {
      params.onClick()
    })
  }
}

interface OptionItemParams {
  icon: Resource;
  title: string;
  subtitle: string;
  color: string;
  onClick: () => void;
}

function chunkArray<T>(source: T[], size: number): T[][] {
  const result: T[][] = [];
  for ( let i = 0; i < source.length; i += size ) {
    result.push(source.slice(i, i + size));
  }
  return result;
}
