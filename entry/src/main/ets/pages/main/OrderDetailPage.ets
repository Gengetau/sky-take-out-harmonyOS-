import { promptAction } from '@kit.ArkUI';
import { OrderDetailVO, OrderVO, OrderCancelDTO } from '../../model/api/OrderModel';
import { OrderService } from '../../service/OrderService';
import { PaymentPageParams } from './PaymentPage';
import { ChatPageParam } from '../message/ChatPage'; // âœ¨ å¼•å…¥ ChatPageParam

@Component
export struct OrderDetailPage {
  @Consume('pageStack') pageStack: NavPathStack;
  @State order: OrderVO | null = null;
  @State isLoading: boolean = true;
  private statusMap: Record<number, string> = {
    1: 'å¾…ä»˜æ¬¾',
    2: 'å¾…æ¥å•',
    3: 'å·²æ¥å•',
    4: 'æ´¾é€ä¸­',
    5: 'å·²å®Œæˆ',
    6: 'å·²å–æ¶ˆ'
  };

  async aboutToAppear() {
    const params = this.pageStack.getParamByName("OrderDetailPage") as Array<object>;
    console.info('å–µï¼OrderDetailPage aboutToAppear, params:', JSON.stringify(params));

    let initialData: OrderVO | null = null;
    if ( params && params.length > 0 ) {
      const firstParam = params[0];
      if ( Array.isArray(firstParam) && firstParam.length > 0 ) {
        initialData = (firstParam as Array<OrderVO>)[0];
      } else {
        initialData = firstParam as OrderVO;
      }
    }

    if ( initialData ) {
      this.order = initialData;
      this.loadDetail(initialData.id);
    }
  }

  async loadDetail(id: number) {
    this.isLoading = true;
    try {
      this.order = await OrderService.getOrderDetail(id);
    } catch ( e ) {
      console.error('å–µï¼è·å–è®¢å•è¯¦æƒ…å¤±è´¥:', e);
      promptAction.showToast({ message: 'åŠ è½½è¯¦æƒ…å¤±è´¥å–µ' });
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * âŒ å¤„ç†å–æ¶ˆè®¢å•é€»è¾‘
   */
  async handleCancelOrder() {
    if (!this.order) return;

    // 1. å¼¹å‡ºç¡®è®¤æ¡† (æç¤ºé€€æ¬¾é£é™©)
    promptAction.showDialog({
      title: 'ç¡®è®¤å–æ¶ˆè®¢å•å—ï¼Ÿ',
      message: this.order.status === 2 ? 'è®¢å•å·²æ”¯ä»˜ï¼Œå–æ¶ˆåå°†åŸè·¯é€€æ¬¾å–µã€‚' : 'å–æ¶ˆåè®¢å•å°†å¤±æ•ˆå–µã€‚',
      buttons: [
        { text: 'å†æƒ³æƒ³', color: '#666666' },
        { text: 'ç¡®è®¤å–æ¶ˆ', color: '#FF3B30' }
      ]
    }).then(async (data) => {
      if (data.index === 1) {
        // 2. å¼¹å‡ºåŸå› é€‰æ‹©èœå•
        this.showReasonSheet();
      }
    });
  }

  showReasonSheet() {
    const reasons = [
      'ä¸æƒ³è¦äº†/æ‹é”™å•',
      'åœ°å€/ç”µè¯ä¿¡æ¯å¡«å†™é”™è¯¯',
      'å¿˜è®°ä½¿ç”¨ä¼˜æƒ åˆ¸',
      'é€è¾¾æ—¶é—´å¤ªé•¿',
      'å…¶ä»–åŸå› '
    ];

    promptAction.showActionMenu({
      title: 'è¯·é€‰æ‹©å–æ¶ˆåŸå› ',
      // âœ¨ ç›´æ¥ä½¿ç”¨å­—é¢é‡æ•°ç»„ï¼Œæ»¡è¶³ Tuple ç±»å‹è¦æ±‚
      buttons: [
        { text: reasons[0], color: '#333333' },
        { text: reasons[1], color: '#333333' },
        { text: reasons[2], color: '#333333' },
        { text: reasons[3], color: '#333333' },
        { text: reasons[4], color: '#333333' }
      ]
    }).then(async (data) => {
      // data.index å¯¹åº”æŒ‰é’®ç´¢å¼•
      const selectedReason = reasons[data.index];
      this.executeCancel(selectedReason);
    }).catch(() => {
      // ç”¨æˆ·å–æ¶ˆé€‰æ‹©
      console.info('ç”¨æˆ·å–æ¶ˆäº†åŸå› é€‰æ‹©');
    });
  }

  async executeCancel(reason: string) {
    try {
      const dto = new OrderCancelDTO(this.order!.id, reason);
      await OrderService.cancelOrder(dto);
      promptAction.showToast({ message: 'è®¢å•å·²å–æ¶ˆå–µ' });
      // é‡æ–°åŠ è½½è¯¦æƒ…ä»¥åˆ·æ–° UI
      this.loadDetail(this.order!.id);
    } catch (e) {
      console.error('å–æ¶ˆè®¢å•å¤±è´¥:', e);
      promptAction.showToast({ message: 'æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•å–µ' });
    }
  }

  build() {
    NavDestination() {
      if ( this.order ) {
        Column() {
          // 1. é¡¶éƒ¨çŠ¶æ€æ 
          this.StatusHeader()

          Scroll() {
            Column({ space: 12 }) {
              // 2. å•†å®¶ä¸å•†å“å¡ç‰‡
              this.GoodsSection()

              // 3. è®¢å•ä¿¡æ¯å¡ç‰‡
              this.OrderInfoSection()

              Blank().height(80)
            }
            .padding(12)
            .width('100%')
          }
          .layoutWeight(1)
          .backgroundColor('#F5F5F5')

          // 4. åº•éƒ¨æ“ä½œæ 
          this.BottomBar()
        }
        .width('100%')
        .height('100%')
        .backgroundColor('#F5F5F5')
      } else if ( this.isLoading ) {
        Column() {
          LoadingProgress().width(50).height(50).color('#FFCC00')
          Text('æ­£åœ¨åŠªåŠ›åŠ è½½è¯¦æƒ…å–µ...').fontSize(14).fontColor('#999').margin({ top: 10 })
        }.width('100%').height('100%').justifyContent(FlexAlign.Center)
      } else {
        Column() {
          Text('è®¢å•æ•°æ®ä¸¢å¤±å–µğŸ˜¿').fontColor('#999')
          Button('è¿”å›').margin({ top: 10 }).onClick(() => this.pageStack.pop())
        }.width('100%').height('100%').justifyContent(FlexAlign.Center)
      }
    }
    .title('è®¢å•è¯¦æƒ…')
    .hideTitleBar(false)
  }

  @Builder
  StatusHeader() {
    Row() {
      Text(this.statusMap[this.order!.status] || 'æœªçŸ¥çŠ¶æ€')
        .fontSize(22)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333')

      Blank()

      if ( this.order!.status === 4 ) {
        SymbolGlyph($r('sys.symbol.paperplane'))
          .fontSize(40)
          .fontColor([ '#333' ])
      } else if ( this.order!.status === 5 ) {
        SymbolGlyph($r('sys.symbol.checkmark_circle'))
          .fontSize(40)
          .fontColor([ '#333' ])
      }
    }
    .width('100%')
    .padding({
      left: 24,
      right: 24,
      top: 10,
      bottom: 20
    })
    .backgroundColor(Color.White)
  }

  @Builder
  GoodsSection() {
    Column() {
      Row() {
        Text(this.order!.shopName || 'å•†å®¶')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .layoutWeight(1)

        Row() {
          SymbolGlyph($r('sys.symbol.message'))
            .fontSize(16)
            .fontColor(['#007DFF'])
            .margin({ right: 4 })
          Text('è”ç³»').fontSize(12).fontColor('#007DFF')
        }
        .margin({ right: 16 })
        .onClick(() => {
          if (this.order!.shopId) {
            const sessionId = `shop_${this.order!.shopId}`;
            const title = this.order!.shopName || 'å•†å®¶';
            this.pageStack.pushPath({ name: 'ChatPage', param: new ChatPageParam(sessionId, title, '') });
          }
        })

        Row() {
          Text('è¿›åº—').fontSize(12).fontColor('#666')
          SymbolGlyph($r('sys.symbol.chevron_right'))
            .fontSize(14)
            .fontColor([ '#999' ])
        }
        .onClick(() => {
          if ( this.order!.shopId ) {
            this.pageStack.pushPath({ name: 'ShopPage', param: this.order!.shopId });
          }
        })
      }
      .width('100%')
      .padding({ bottom: 12 })
      .border({ width: { bottom: 0.5 }, color: '#F0F0F0' })

      ForEach(this.order!.orderDetailList, (detail: OrderDetailVO) => {
        Row() {
          Image(detail.image || $r('app.media.appstore'))
            .width(50)
            .height(50)
            .borderRadius(4)
            .backgroundColor('#f0f0f0')
            .margin({ right: 10 })
            .objectFit(ImageFit.Cover)

          Column() {
            Text(detail.name)
              .fontSize(14)
              .fontColor('#333')
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })

            Text(`x${ detail.number }`)
              .fontSize(12)
              .fontColor('#999')
              .margin({ top: 4 })
          }
          .layoutWeight(1)
          .alignItems(HorizontalAlign.Start)

          Text(`Â¥${ detail.amount ? detail.amount.toFixed(2) : '0.00' }`)
            .fontSize(14)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333')
        }
        .width('100%')
        .padding({ top: 12, bottom: 12 })
      })

      Divider().color('#F0F0F0')

      Row() {
        Text('å®ä»˜').fontSize(14).fontColor('#333')
        Blank()
        Text(`Â¥${ this.order!.amount ? this.order!.amount.toFixed(2) : '0.00' }`)
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FF3B30')
      }
      .width('100%')
      .padding({ top: 12 })
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
  }

  @Builder
  OrderInfoSection() {
    Column({ space: 12 }) {
      Text('è®¢å•ä¿¡æ¯').fontSize(14).fontWeight(FontWeight.Bold)
      Row() {
        Text('è®¢å•å·ç ').fontSize(12).fontColor('#999').width(70)
        Text(this.order!.number).fontSize(12).fontColor('#333').layoutWeight(1)
        Text('å¤åˆ¶')
          .fontSize(10)
          .fontColor('#007AFF')
          .padding({ left: 8, right: 8, top: 2, bottom: 2 })
          .border({ width: 0.5, color: '#007AFF', radius: 4 })
          .onClick(() => {
            promptAction.showToast({ message: 'å¤åˆ¶æˆåŠŸå–µ' });
          })
      }.width('100%')
      Row() {
        Text('ä¸‹å•æ—¶é—´').fontSize(12).fontColor('#999').width(70)
        Text(this.order!.orderTime).fontSize(12).fontColor('#333')
      }.width('100%')
      Row() {
        Text('æ”¯ä»˜æ–¹å¼').fontSize(12).fontColor('#999').width(70)
        Text('åœ¨çº¿æ”¯ä»˜').fontSize(12).fontColor('#333')
      }.width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  BottomBar() {
    Row({ space: 12 }) {
      Blank()
      
      // âœ¨ å¢åŠ å–æ¶ˆè®¢å•é€»è¾‘
      if ( this.order!.status === 1 || this.order!.status === 2 ) {
        Button('å–æ¶ˆè®¢å•')
          .height(36)
          .backgroundColor(Color.White)
          .fontColor('#666')
          .fontSize(14)
          .border({ width: 0.5, color: '#ccc' })
          .onClick(() => this.handleCancelOrder())
      }

      if ( this.order!.status === 1 ) { // å¾…ä»˜æ¬¾
        Button('å»æ”¯ä»˜')
          .height(36)
          .backgroundColor('#FFCC00')
          .fontColor('#333')
          .fontSize(14)
          .onClick(() => {
            const params: PaymentPageParams = {
              orderId: this.order!.id,
              orderNumber: this.order!.number,
              payMethod: 2,
              totalAmount: this.order!.amount
            };
            this.pageStack.pushPath({ name: 'PaymentPage', param: params });
          })
      } else {
        Button('å†æ¥ä¸€å•')
          .height(36)
          .backgroundColor(Color.White)
          .fontColor('#333')
          .fontSize(14)
          .border({ width: 0.5, color: '#ccc' })
          .onClick(() => {
            if ( this.order!.shopId ) {
              this.pageStack.pushPath({ name: 'ShopPage', param: this.order!.shopId });
            }
          })
      }
    }
    .width('100%')
    .height(60)
    .padding({ left: 16, right: 16 })
    .backgroundColor(Color.White)
    .shadow({ radius: 10, color: '#1a000000', offsetY: -2 })
  }
}