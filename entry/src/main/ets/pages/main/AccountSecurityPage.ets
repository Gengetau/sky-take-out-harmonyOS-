import { promptAction } from '@kit.ArkUI';
import { UserInfoVO } from '../../model/entity/LoginModel';
import { AuthService } from '../../service/AuthService';

@CustomDialog
struct ModifyPhoneDialog {
  controller: CustomDialogController;
  @State phoneNumber: string = '';
  @State code: string = '';
  @State countdown: number = 0;
  private timer: number = -1;
  // æ³¨å…¥ç”¨æˆ·ä¿¡æ¯ä»¥ä¾¿åˆ·æ–°å’Œå¯¹æ¯”
  @Link userInfo: UserInfoVO | null;

  // â±ï¸ å¤ç”¨ Login é¡µé¢çš„å€’è®¡æ—¶é€»è¾‘
  startCountdown() {
    this.countdown = 60;
    this.timer = setInterval(() => {
      if ( this.countdown > 0 ) {
        this.countdown--;
      } else {
        clearInterval(this.timer);
      }
    }, 1000);
  }

  // ğŸ“¨ è·å–éªŒè¯ç 
  async handleGetCode() {
    // 1. æ ¡éªŒæ‰‹æœºå·é•¿åº¦
    if ( this.phoneNumber.length !== 11 ) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥11ä½æ‰‹æœºå·å–µï¼ğŸ˜¿' });
      return;
    }

    // 2. æ‹¦æˆªç›¸åŒæ‰‹æœºå·
    if ( this.userInfo && this.phoneNumber === this.userInfo.phone ) {
      promptAction.showToast({ message: 'æ–°æ‰‹æœºå·ä¸èƒ½ä¸å½“å‰æ‰‹æœºå·ç›¸åŒå–µï¼ğŸ±' });
      return;
    }

    this.startCountdown();

    try {
      const serverCode = await AuthService.sendVerifyCode(this.phoneNumber);
      if ( serverCode ) {
        setTimeout(() => {
          promptAction.showDialog({
            title: 'ğŸ“¨ æ–°æ¶ˆæ¯',
            message: `ã€è‹ç©¹å¤–å–ã€‘æ‚¨çš„éªŒè¯ç æ˜¯ï¼š${ serverCode }ã€‚æ‚¨æ­£åœ¨ä¿®æ”¹æ‰‹æœºå·ï¼Œè‹¥éæœ¬äººæ“ä½œè¯·å¿½ç•¥ã€‚`,
            buttons: [
              { text: 'å…³é—­', color: '#999999' },
              { text: 'è‡ªåŠ¨å¡«å†™', color: '#0D9FFB' }
            ]
          }).then((res) => {
            if ( res.index === 1 ) {
              this.code = serverCode;
            }
          });
        }, 500);
      } else {
        this.countdown = 0;
        clearInterval(this.timer);
        promptAction.showToast({ message: 'éªŒè¯ç å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•å–µ' });
      }
    } catch ( err ) {
      promptAction.showToast({ message: 'å‘é€å¤±è´¥ï¼Œè¯·ç¨åå†è¯•å–µ~' });
      this.countdown = 0;
      clearInterval(this.timer);
    }
  }

  // âœ… ç¡®è®¤ä¿®æ”¹
  async handleConfirm() {
    // 1. æ ¡éªŒæ ¼å¼
    if ( this.phoneNumber.length !== 11 ) {
      promptAction.showToast({ message: 'æ‰‹æœºå·æ ¼å¼ä¸å¯¹å–µï¼' });
      return;
    }

    // 2. å†æ¬¡æ ¡éªŒç›¸åŒæ‰‹æœºå·
    if ( this.userInfo && this.phoneNumber === this.userInfo.phone ) {
      promptAction.showToast({ message: 'æ–°æ‰‹æœºå·ä¸èƒ½ä¸åŸæ‰‹æœºå·ç›¸åŒå–µï¼ğŸ±' });
      return;
    }

    // 3. æ ¡éªŒéªŒè¯ç 
    if (!this.code || this.code.length < 4 ) {
      promptAction.showToast({ message: 'éªŒè¯ç ä¸æ­£ç¡®å–µï¼' });
      return;
    }

    try {
      await AuthService.updateUserSingleInfo('phone', this.phoneNumber);

      if ( this.userInfo ) {
        const newUserInfo: UserInfoVO = {
          id: this.userInfo.id,
          openid: this.userInfo.openid,
          meowId: this.userInfo.meowId,
          name: this.userInfo.name,
          phone: this.phoneNumber,
          sex: this.userInfo.sex,
          avatar: this.userInfo.avatar,
          profile: this.userInfo.profile,
          createTime: this.userInfo.createTime,
          idNumber: this.userInfo.idNumber
        };
        this.userInfo = newUserInfo;
        AppStorage.setOrCreate('currentUserInfo', newUserInfo);
      }

      promptAction.showToast({ message: 'æ‰‹æœºå·ä¿®æ”¹æˆåŠŸå–µï¼âœ¨' });
      this.controller.close();
    } catch ( err ) {
      promptAction.showToast({ message: 'ä¿®æ”¹å¤±è´¥ï¼Œè¯·é‡è¯•å–µ~' });
    }
  }

  aboutToDisappear() {
    if ( this.timer !== -1 ) {
      clearInterval(this.timer);
    }
  }

  build() {
    Column({ space: 15 }) {
      Text('ä¿®æ”¹æ‰‹æœºå·ç ').fontSize(18).fontWeight(FontWeight.Bold).margin({ top: 10 })

      TextInput({ placeholder: 'è¯·è¾“å…¥æ–°æ‰‹æœºå·' })
        .width('100%')
        .height(50)
        .type(InputType.PhoneNumber)
        .maxLength(11)
        .onChange((val) => this.phoneNumber = val)

      Row({ space: 10 }) {
        TextInput({ placeholder: 'éªŒè¯ç ', text: this.code })
          .layoutWeight(1)
          .height(50)
          .type(InputType.Number)
          .maxLength(6)
          .onChange((val) => this.code = val)

        Button(this.countdown > 0 ? `${ this.countdown }s` : 'è·å–éªŒè¯ç ')
          .height(50)
          .backgroundColor(this.countdown > 0 ? '#F0F0F0' : '#FFCC00')
          .fontColor(this.countdown > 0 ? '#999' : '#333')
          .enabled(this.countdown === 0)
          .onClick(() => this.handleGetCode())
      }.width('100%')

      Row({ space: 20 }) {
        Button('å–æ¶ˆ').layoutWeight(1).backgroundColor('#F5F5F5').fontColor('#666')
          .onClick(() => this.controller.close())
        Button('ç¡®å®š').layoutWeight(1).backgroundColor('#FFCC00').fontColor('#333')
          .onClick(() => this.handleConfirm())
      }.width('100%').margin({ top: 10 })
    }
    .padding(20)
    .backgroundColor(Color.White)
    .borderRadius(16)
  }
}

@CustomDialog
struct RealNameAuthDialog {
  controller: CustomDialogController;
  @State realName: string = '';
  @State idNumber: string = '';
  @Link userInfo: UserInfoVO | null;

  // ğŸ†” ç®€å•çš„èº«ä»½è¯æ ¼å¼æ ¡éªŒ (18ä½)
  isValidIdNumber(id: string): boolean {
    const reg = /^\d{17}[\dXx]$/;
    return reg.test(id);
  }

  build() {
    Column({ space: 15 }) {
      Text('å®åè®¤è¯').fontSize(18).fontWeight(FontWeight.Bold).margin({ top: 10 })

      TextInput({ placeholder: 'çœŸå®å§“å' })
        .width('100%')
        .height(50)
        .onChange((val) => this.realName = val)

      TextInput({ placeholder: 'èº«ä»½è¯å·ç ' })
        .width('100%')
        .height(50)
        .maxLength(18)
        .onChange((val) => this.idNumber = val)

      Row({ space: 20 }) {
        Button('å–æ¶ˆ').layoutWeight(1).backgroundColor('#F5F5F5').fontColor('#666')
          .onClick(() => this.controller.close())
        Button('æäº¤è®¤è¯').layoutWeight(1).backgroundColor('#FFCC00').fontColor('#333')
          .onClick(async() => {
            // 1. å§“åæ ¡éªŒ
            if (!this.realName || this.realName.trim().length < 2 ) {
              promptAction.showToast({ message: 'è¯·è¾“å…¥çœŸå®çš„å§“åå–µï¼' });
              return;
            }

            // 2. èº«ä»½è¯æ ¼å¼æ ¡éªŒ
            if (!this.isValidIdNumber(this.idNumber) ) {
              promptAction.showToast({ message: 'èº«ä»½è¯å·æ ¼å¼ä¸å¯¹å–µï¼ğŸ˜¿' });
              return;
            }

            try {
              await AuthService.updateUserSingleInfo('idNumber', this.idNumber);

              if ( this.userInfo ) {
                const newUserInfo: UserInfoVO = {
                  id: this.userInfo.id,
                  openid: this.userInfo.openid,
                  meowId: this.userInfo.meowId,
                  name: this.userInfo.name,
                  phone: this.userInfo.phone,
                  sex: this.userInfo.sex,
                  avatar: this.userInfo.avatar,
                  profile: this.userInfo.profile,
                  createTime: this.userInfo.createTime,
                  idNumber: this.idNumber
                };
                this.userInfo = newUserInfo;
                AppStorage.setOrCreate('currentUserInfo', newUserInfo);
              }

              promptAction.showToast({ message: 'å®åè®¤è¯æˆåŠŸå–µï¼ğŸ“' });
              this.controller.close();
            } catch ( err ) {
              promptAction.showToast({ message: 'è®¤è¯æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•å–µ~' });
            }
          })
      }.width('100%').margin({ top: 10 })
    }
    .padding(20)
    .backgroundColor(Color.White)
    .borderRadius(16)
  }
}

@Component
export struct AccountSecurityPage {
  @Consume('pageStack') pageStack: NavPathStack;
  @StorageLink('currentUserInfo') userInfo: UserInfoVO | null = null;
  phoneDialogController: CustomDialogController = new CustomDialogController({
    builder: ModifyPhoneDialog({ userInfo: $userInfo }),
    alignment: DialogAlignment.Center
  });
  authDialogController: CustomDialogController = new CustomDialogController({
    builder: RealNameAuthDialog({ userInfo: $userInfo }),
    alignment: DialogAlignment.Center
  });

  // ğŸ›¡ï¸ æ‰‹æœºå·è„±æ•å¤„ç†
  maskPhone(phone: string): string {
    if (!phone || phone.length !== 11 ) {
      return 'æœªç»‘å®š';
    }
    return phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2');
  }

  // ğŸ†” èº«ä»½è¯è„±æ•å¤„ç†
  maskIdNumber(idNumber?: string): string {
    if (!idNumber ) {
      return 'æœªè®¤è¯';
    }
    return idNumber.replace(/^(.{2}).+(.{2})$/, '$1****************$2');
  }

  async aboutToAppear() {
    const info = await AuthService.getUserInfo();
    if ( info ) {
      this.userInfo = info;
      AppStorage.setOrCreate('currentUserInfo', info);
    }
  }

  /**
   * ğŸ—‘ï¸ å¤„ç†æ³¨é”€è´¦å· (æ¥å…¥çœŸå® API 9.5)
   */
  handleDeleteAccount() {
    AlertDialog.show({
      title: 'âš ï¸ å±é™©æ“ä½œ',
      message: 'æ³¨é”€è´¦å·å°†æ°¸ä¹…åˆ é™¤æ‰€æœ‰æ•°æ®ï¼Œä¸”æ— æ³•æ¢å¤ã€‚ç¡®å®šè¦ç»§ç»­å—å–µï¼ŸğŸ˜¿',
      primaryButton: {
        value: 'æˆ‘å†æƒ³æƒ³',
        action: () => {
        }
      },
      secondaryButton: {
        value: 'ç¡®è®¤æ³¨é”€',
        fontColor: Color.Red,
        action: async() => {
          try {
            promptAction.showToast({ message: 'æ­£åœ¨æ³¨é”€ï¼Œæ±Ÿæ¹–å†è§å–µ...' });

            // 1. è°ƒç”¨åç«¯æ³¨é”€æ¥å£ (API 9.5)
            await AuthService.cancelAccount();

            // 2. è°ƒç”¨æœ¬åœ°æ¸…ç†é€»è¾‘ (æ¸…ç† Token, WS ç­‰)
            await AuthService.logout();

            // 3. è·³è½¬ç™»å½•é¡µ
            this.pageStack.clear();
            this.pageStack.pushPath({ name: 'Login' });

            promptAction.showToast({ message: 'è´¦å·å·²æ³¨é”€ï¼Œåä¼šæœ‰æœŸå–µ ğŸ‘‹' });
          } catch ( err ) {
            promptAction.showToast({ message: 'æ³¨é”€å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•å–µ' });
          }
        }
      }
    });
  }

  build() {
    NavDestination() {
      Column() {
        // è‡ªå®šä¹‰æ ‡é¢˜æ 
        Row() {
          SymbolGlyph($r('sys.symbol.chevron_left'))
            .fontSize(24)
            .fontColor([ '#333' ])
            .onClick(() => this.pageStack.pop())

          Text('è´¦å·ä¸å®‰å…¨')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .layoutWeight(1)
            .textAlign(TextAlign.Center)
            .margin({ right: 24 })
        }
        .width('100%')
        .height(56)
        .padding({ left: 16, right: 16 })
        .backgroundColor(Color.White)

        List() {
          ListItemGroup() {
            // ğŸ“± ä¿®æ”¹æ‰‹æœºå·ç 
            ListItem() {
              Row() {
                Text('ä¿®æ”¹æ‰‹æœºå·ç ').fontSize(16).fontColor('#333')
                Blank()
                Text(this.maskPhone(this.userInfo?.phone || ''))
                  .fontSize(14)
                  .fontColor('#999')
                  .margin({ right: 8 })
                SymbolGlyph($r('sys.symbol.chevron_right'))
                  .fontSize(16)
                  .fontColor([ '#CCC' ])
              }
              .width('100%')
              .height(54)
              .padding({ left: 16, right: 16 })
              .onClick(() => this.phoneDialogController.open())
            }

            // ğŸ†” å®åè®¤è¯
            ListItem() {
              Row() {
                Text('å®åè®¤è¯').fontSize(16).fontColor('#333')
                Blank()
                Text(this.maskIdNumber(this.userInfo?.idNumber))
                  .fontSize(14)
                  .fontColor('#999')
                  .margin({ right: 8 })
                SymbolGlyph($r('sys.symbol.chevron_right'))
                  .fontSize(16)
                  .fontColor([ '#CCC' ])
              }
              .width('100%')
              .height(54)
              .padding({ left: 16, right: 16 })
              .onClick(() => {
                if ( this.userInfo?.idNumber ) {
                  promptAction.showToast({ message: 'ä¸»äººå·²ç»å®åè®¤è¯è¿‡å•¦å–µï¼âœ¨' });
                } else {
                  this.authDialogController.open();
                }
              })
            }
          }
          .backgroundColor(Color.White)
          .margin({ top: 12 })
          .divider({
            strokeWidth: 0.5,
            color: '#F0F0F0',
            startMargin: 16,
            endMargin: 16
          })

          // ğŸ—‘ï¸ æ³¨é”€è´¦å·
          ListItem() {
            Row() {
              Text('æ³¨é”€è´¦å·').fontSize(16).fontColor('#FF3B30').layoutWeight(1)
              SymbolGlyph($r('sys.symbol.chevron_right'))
                .fontSize(16)
                .fontColor([ '#CCC' ])
            }
            .width('100%')
            .height(54)
            .padding({ left: 16, right: 16 })
            .onClick(() => this.handleDeleteAccount())
          }
          .backgroundColor(Color.White)
          .margin({ top: 12 })
        }
        .width('100%')
        .layoutWeight(1)
        .backgroundColor('#F5F5F5')
      }
      .width('100%')
      .height('100%')
    }
    .hideTitleBar(true)
  }
}
