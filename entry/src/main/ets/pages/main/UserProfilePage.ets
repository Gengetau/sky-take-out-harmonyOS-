import { common } from '@kit.AbilityKit';
import { promptAction } from '@kit.ArkUI';
import { fileIo, picker } from '@kit.CoreFileKit';
import { UserInfoVO } from '../../model/entity/LoginModel';
import { AuthService } from '../../service/AuthService';

/**
 * ‚úèÔ∏è ‰øÆÊîπÊòµÁß∞ÁöÑÂºπÁ™ó
 */
@CustomDialog
struct EditNameDialog {
  controller: CustomDialogController;
  @Link name: string;
  onConfirm: () => void = () => {};

  build() {
    Column({ space: 15 }) {
      Text('‰øÆÊîπÊòµÁß∞').fontSize(18).fontWeight(FontWeight.Bold).margin({ top: 10 })
      TextInput({ text: this.name, placeholder: 'ËØ∑ËæìÂÖ•Êñ∞ÊòµÁß∞' })
        .width('100%')
        .height(50)
        .onChange((val) => this.name = val)
      
      Row({ space: 20 }) {
        Button('ÂèñÊ∂à').layoutWeight(1).backgroundColor('#F5F5F5').fontColor('#666')
          .onClick(() => this.controller.close())
        Button('Á°ÆÂÆö').layoutWeight(1).backgroundColor('#FFCC00').fontColor('#333')
          .onClick(() => {
            this.onConfirm();
            this.controller.close();
          })
      }.width('100%').margin({ top: 10 })
    }
    .padding(20)
    .backgroundColor(Color.White)
    .borderRadius(16)
  }
}

/**
 * üìù ‰øÆÊîπÁÆÄ‰ªãÁöÑÂºπÁ™ó
 */
@CustomDialog
struct EditProfileDialog {
  controller: CustomDialogController;
  @Link profile: string;
  onConfirm: () => void = () => {};

  build() {
    Column({ space: 15 }) {
      Text('‰∏™‰∫∫ÁÆÄ‰ªã').fontSize(18).fontWeight(FontWeight.Bold).margin({ top: 10 })
      TextArea({ text: this.profile, placeholder: '‰ªãÁªç‰∏Ä‰∏ãËá™Â∑±ÂêßÂñµ~' })
        .width('100%')
        .height(100)
        .onChange((val) => this.profile = val)
      
      Row({ space: 20 }) {
        Button('ÂèñÊ∂à').layoutWeight(1).backgroundColor('#F5F5F5').fontColor('#666')
          .onClick(() => this.controller.close())
        Button('Á°ÆÂÆö').layoutWeight(1).backgroundColor('#FFCC00').fontColor('#333')
          .onClick(() => {
            this.onConfirm();
            this.controller.close();
          })
      }.width('100%').margin({ top: 10 })
    }
    .padding(20)
    .backgroundColor(Color.White)
    .borderRadius(16)
  }
}

/**
 * üöª ÊÄßÂà´ÈÄâÊã©ÂºπÁ™ó
 */
@CustomDialog
struct SexSelectDialog {
  controller: CustomDialogController;
  onSelect: (sex: string) => void = () => {};

  build() {
    Column() {
      Text('ÈÄâÊã©ÊÄßÂà´')
        .fontSize(16)
        .fontColor('#999')
        .margin({ top: 15, bottom: 15 })
      
      Divider().color('#F0F0F0')

      Text('Áî∑')
        .width('100%')
        .height(56)
        .textAlign(TextAlign.Center)
        .fontSize(18)
        .fontColor('#333')
        .onClick(() => {
          this.onSelect('1');
          this.controller.close();
        })
      
      Divider().color('#F0F0F0')

      Text('Â•≥')
        .width('100%')
        .height(56)
        .textAlign(TextAlign.Center)
        .fontSize(18)
        .fontColor('#333')
        .onClick(() => {
          this.onSelect('0');
          this.controller.close();
        })

      Divider().height(8).color('#F7F8FA')

      Text('ÂèñÊ∂à')
        .width('100%')
        .height(56)
        .textAlign(TextAlign.Center)
        .fontSize(18)
        .fontColor('#333')
        .onClick(() => this.controller.close())
    }
    .width('100%')
    .backgroundColor(Color.White)
    .borderRadius({ topLeft: 16, topRight: 16 })
  }
}

/**
 * üë§ ‰∏™‰∫∫‰ø°ÊÅØÈ°µÈù¢
 */
@Component
export struct UserProfilePage {
  @Consume('pageStack') pageStack: NavPathStack;
  @StorageLink('currentUserInfo') userInfo: UserInfoVO | null = null;
  @State isLoading: boolean = false;

  // Êú¨Âú∞ State
  @State currentName: string = '';
  @State currentProfile: string = '';
  @State currentSex: string = '';
  @State currentAvatar: string = '';
  @State currentMeowId: string = '';
  @State currentCreateTime: string = '';

  @State tempName: string = '';
  @State tempProfile: string = '';

  // ÂºπÁ™óÊéßÂà∂Âô®
  nameEditController: CustomDialogController | null = new CustomDialogController({
    builder: EditNameDialog({
      name: $tempName,
      onConfirm: (): void => { this.saveField('name', this.tempName) }
    }),
    alignment: DialogAlignment.Center
  });

  profileEditController: CustomDialogController | null = new CustomDialogController({
    builder: EditProfileDialog({
      profile: $tempProfile,
      onConfirm: (): void => { this.saveField('profile', this.tempProfile) }
    }),
    alignment: DialogAlignment.Center
  });

  sexSelectController: CustomDialogController | null = new CustomDialogController({
    builder: SexSelectDialog({
      onSelect: (sex: string): void => { this.saveField('sex', sex) }
    }),
    alignment: DialogAlignment.Bottom,
    customStyle: true
  });

  async aboutToAppear() {
    if (this.userInfo) {
      this.syncToLocalState(this.userInfo);
    }
    this.loadUserInfo();
  }

  // üîÑ ÂêåÊ≠•Âà∞Êú¨Âú∞ State
  syncToLocalState(info: UserInfoVO) {
    this.currentName = info.name;
    this.currentProfile = info.profile || 'Êú™Â°´ÂÜô';
    this.currentSex = info.sex;
    this.currentAvatar = info.avatar;
    this.currentMeowId = info.meowId;
    this.currentCreateTime = info.createTime;
    
    this.tempName = info.name;
    this.tempProfile = info.profile || '';
  }

  async loadUserInfo() {
    if (!this.userInfo) this.isLoading = true;
    try {
      console.info(`ÂñµÔºÅ[loadUserInfo] ÂºÄÂßãÊãâÂèñ... t=${Date.now()}`);
      // Âä†Êó∂Èó¥Êà≥Èò≤ÁºìÂ≠ò
      const info = await AuthService.getUserInfo();
      if (info) {
        console.info(`ÂñµÔºÅ[loadUserInfo] ÊãâÂèñÊàêÂäü: name=${info.name}`);
        this.userInfo = info; 
        this.syncToLocalState(info);
      }
    } catch (err) {
      // Error
    } finally {
      this.isLoading = false;
    }
  }

  // üì∏ ‰∏ä‰º†Â§¥ÂÉè
  async handleUploadAvatar() {
    try {
      const photoSelectOptions = new picker.PhotoSelectOptions();
      photoSelectOptions.MIMEType = picker.PhotoViewMIMETypes.IMAGE_TYPE;
      photoSelectOptions.maxSelectNumber = 1;

      const photoViewPicker = new picker.PhotoViewPicker();
      const photoSelectResult = await photoViewPicker.select(photoSelectOptions);

      if ( photoSelectResult && photoSelectResult.photoUris.length > 0 ) {
        const uri = photoSelectResult.photoUris[0];
        this.isLoading = true;

        const context = getContext(this) as common.UIAbilityContext;
        const fileName = `avatar_${ Date.now() }.jpg`;
        const cachePath = `${ context.cacheDir }/${ fileName }`;

        const file = fileIo.openSync(uri, fileIo.OpenMode.READ_ONLY);
        const stat = fileIo.statSync(file.fd);
        if (stat.size > 2 * 1024 * 1024) {
          fileIo.closeSync(file);
          promptAction.showToast({ message: 'ÂõæÁâáÂ§™Â§ß‰∫ÜÂñµÔºåËØ∑ÈÄâÊã©Â∞è‰∫é2MBÁöÑÂõæÁâáÔºÅ' });
          this.isLoading = false;
          return;
        }
        fileIo.copyFileSync(file.fd, cachePath);
        fileIo.closeSync(file);

        // Upload
        const newAvatarUrl = await AuthService.uploadAvatar(cachePath);
        
        // Á´ãÂç≥Âà∑Êñ∞
        this.currentAvatar = newAvatarUrl;
        
        if (this.userInfo) {
           const newUserInfo: UserInfoVO = {
            id: this.userInfo.id,
            openid: this.userInfo.openid,
            meowId: this.userInfo.meowId,
            name: this.userInfo.name,
            phone: this.userInfo.phone,
            sex: this.userInfo.sex,
            avatar: newAvatarUrl, 
            profile: this.userInfo.profile,
            createTime: this.userInfo.createTime
          };
          this.userInfo = newUserInfo;
          AppStorage.setOrCreate('currentUserInfo', newUserInfo);
        }
        
        promptAction.showToast({ message: 'Â§¥ÂÉèÊõ¥Êñ∞ÊàêÂäüÂñµÔºÅ' });
        this.loadUserInfo();
      }
    } catch (err) {
      console.error('‰∏ä‰º†Â§¥ÂÉèÂ§±Ë¥•:', err);
    } finally {
      this.isLoading = false;
    }
  }

  // ‚úèÔ∏è ‰øÆÊîπÂ≠óÊÆµ
  async saveField(code: string, value: string) {
    if (!this.userInfo) return;
    this.isLoading = true;
    try {
      console.info(`ÂñµÔºÅ[saveField] ËØ∑Ê±Ç‰øÆÊîπ: ${code} -> ${value}`);
      await AuthService.updateUserSingleInfo(code, value);
      
      // ‚úÖ Âº∫Âà∂Êú¨Âú∞Á´ãÂç≥Âà∑Êñ∞
      if (code === 'name') this.currentName = value;
      if (code === 'profile') this.currentProfile = value;
      if (code === 'sex') this.currentSex = value;
      
      // ËøôÈáåÁöÑ log Áî®‰∫éÈ™åËØÅÊú¨Âú∞ State ÊòØÂê¶Âèò‰∫Ü
      console.info(`ÂñµÔºÅ[saveField] Êú¨Âú∞StateÂ∑≤Êõ¥Êñ∞: currentName=${this.currentName}`);

      // ÊûÑÈÄ†Êñ∞ÂØπË±°ÂêåÊ≠•ÂÖ®Â±Ä
      const newUserInfo: UserInfoVO = {
        id: this.userInfo.id,
        openid: this.userInfo.openid,
        meowId: this.userInfo.meowId,
        name: this.currentName, // ‰ΩøÁî®ÊúÄÊñ∞ÁöÑÊú¨Âú∞ÂÄº
        phone: this.userInfo.phone,
        sex: this.currentSex,
        avatar: this.userInfo.avatar,
        profile: this.currentProfile,
        createTime: this.userInfo.createTime
      };
      
      this.userInfo = newUserInfo;
      AppStorage.setOrCreate('currentUserInfo', newUserInfo);
      
      promptAction.showToast({ message: '‰øÆÊîπÊàêÂäüÂñµÔºÅ' });
      
      this.loadUserInfo();
    } catch (err) {
      // Error
    } finally {
      this.isLoading = false;
    }
  }

  handleEditSex() {
    this.sexSelectController?.open();
  }

  build() {
    NavDestination() {
      Column() {
        if (this.userInfo) {
          List() {
            // 0. Â§¥ÂÉè
            ListItem() {
              Column() {
                Stack({ alignContent: Alignment.BottomEnd }) {
                  Image(this.currentAvatar || $r('app.media.logo'))
                    .width(100)
                    .height(100)
                    .borderRadius(50)
                    .objectFit(ImageFit.Cover)
                    .shadow({ radius: 10, color: '#20000000', offsetY: 5 })
                  
                  Row() {
                    SymbolGlyph($r('sys.symbol.camera'))
                      .fontSize(16)
                      .fontColor([Color.White])
                  }
                  .width(30)
                  .height(30)
                  .backgroundColor('#99000000')
                  .borderRadius(15)
                  .justifyContent(FlexAlign.Center)
                  .border({ width: 2, color: Color.White })
                }
                .margin({ top: 30, bottom: 30 })
                .onClick(() => this.handleUploadAvatar())
              }
              .width('100%')
              .alignItems(HorizontalAlign.Center)
            }

            // 1. ÊòµÁß∞ (Áõ¥Êé•ÂÜÖËÅî UIÔºåÁ°Æ‰øùÂìçÂ∫îÂºè)
            ListItem() {
              Row() {
                Text('ÊòµÁß∞').fontSize(16).fontColor('#333')
                Blank()
                Text(this.currentName) // üî• Áõ¥Êé•ÁªëÂÆöÊú¨Âú∞ @State
                  .fontSize(16)
                  .fontColor('#666')
                  .margin({ right: 10 })
                  .maxLines(1)
                  .textOverflow({ overflow: TextOverflow.Ellipsis })
                  .constraintSize({ maxWidth: '60%' })
                
                SymbolGlyph($r('sys.symbol.chevron_right')).fontSize(16).fontColor(['#CCC'])
              }
              .width('100%')
              .height(56)
              .padding({ left: 16, right: 16 })
              .backgroundColor(Color.White)
              .onClick(() => {
                this.tempName = this.currentName;
                this.nameEditController?.open();
              })
            }

            // 2. MeowÂè∑
            ListItem() {
              Row() {
                Text('MeowÂè∑').fontSize(16).fontColor('#333')
                Blank()
                Text(this.currentMeowId || 'Êú™ËÆæÁΩÆ')
                  .fontSize(16)
                  .fontColor('#666')
                  .margin({ right: 10 })
                
                Blank().width(16) // Âç†‰Ωç
              }
              .width('100%')
              .height(56)
              .padding({ left: 16, right: 16 })
              .backgroundColor(Color.White)
            }

            // 3. ÊÄßÂà´
            ListItem() {
              Row() {
                Text('ÊÄßÂà´').fontSize(16).fontColor('#333')
                Blank()
                Text(this.currentSex === '1' ? 'Áî∑' : (this.currentSex === '0' ? 'Â•≥' : 'Êú™Áü•'))
                  .fontSize(16)
                  .fontColor('#666')
                  .margin({ right: 10 })
                
                SymbolGlyph($r('sys.symbol.chevron_right')).fontSize(16).fontColor(['#CCC'])
              }
              .width('100%')
              .height(56)
              .padding({ left: 16, right: 16 })
              .backgroundColor(Color.White)
              .onClick(() => this.handleEditSex())
            }

            // 4. ÁÆÄ‰ªã
            ListItem() {
              Row() {
                Text('‰∏™‰∫∫ÁÆÄ‰ªã').fontSize(16).fontColor('#333')
                Blank()
                Text(this.currentProfile)
                  .fontSize(16)
                  .fontColor('#666')
                  .margin({ right: 10 })
                  .maxLines(1)
                  .textOverflow({ overflow: TextOverflow.Ellipsis })
                  .constraintSize({ maxWidth: '60%' })
                
                SymbolGlyph($r('sys.symbol.chevron_right')).fontSize(16).fontColor(['#CCC'])
              }
              .width('100%')
              .height(56)
              .padding({ left: 16, right: 16 })
              .backgroundColor(Color.White)
              .onClick(() => {
                this.tempProfile = (this.currentProfile === 'Êú™Â°´ÂÜô') ? '' : this.currentProfile;
                this.profileEditController?.open();
              })
            }

            // 5. Ê≥®ÂÜåÊó∂Èó¥
            ListItem() {
              Row() {
                Text('Ê≥®ÂÜåÊó∂Èó¥').fontSize(16).fontColor('#333')
                Blank()
                Text(this.currentCreateTime)
                  .fontSize(16)
                  .fontColor('#666')
                  .margin({ right: 10 })
                
                Blank().width(16)
              }
              .width('100%')
              .height(56)
              .padding({ left: 16, right: 16 })
              .backgroundColor(Color.White)
            }
          }
          .width('100%')
          .height('100%')
          .divider({ strokeWidth: 0.5, color: '#F0F0F0', startMargin: 16, endMargin: 0 })
          .backgroundColor('#F7F8FA')
        } else if (this.isLoading) {
          Column() {
            LoadingProgress().width(50).height(50)
          }
          .width('100%')
          .margin({ top: 100 })
        }
      }
      .width('100%')
      .height('100%')
    }
    .title('‰∏™‰∫∫‰ø°ÊÅØ')
    .hideTitleBar(false)
  }
}

@Builder
export function UserProfilePageBuilder() {
  UserProfilePage()
}
