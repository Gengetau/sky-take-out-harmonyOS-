import { promptAction } from '@kit.ArkUI';
import { ShopService } from '../service/ShopService';
import { ShopInfoVO } from '../model/ShopModel';

export class EditFieldParam {
  title: string;
  field: string;
  oldValue: string;
  isNumber: boolean;

  constructor(title: string, field: string, oldValue: string, isNumber: boolean) {
    this.title = title;
    this.field = field;
    this.oldValue = oldValue;
    this.isNumber = isNumber;
  }
}

/**
 * é€šç”¨å­—æ®µç¼–è¾‘é¡µ (ä¸¥è°¨ç±»å‹ç‰ˆå–µï¼)
 */
@Component
export struct EditFieldPage {
  @Consume('pageStack') pageStack: NavPathStack;
  @State title: string = '';
  @State field: string = '';
  @State newValue: string = '';
  @State isNumber: boolean = false;
  @State isLoading: boolean = false;

  initParams(params: EditFieldParam) {
    this.title = params.title;
    this.field = params.field;
    this.newValue = params.oldValue;
    this.isNumber = params.isNumber;
  }

  async handleSave() {
    if (!this.newValue.trim()) {
      promptAction.showToast({ message: 'å†…å®¹ä¸èƒ½ä¸ºç©ºå–µï¼' });
      return;
    }

    this.isLoading = true;
    try {
      // ğŸ¾ æ˜¾å¼æ„é€ ç¬¦åˆ Partial<ShopInfoVO> æ¥å£çš„å¯¹è±¡å–µ
      const updateData: Partial<ShopInfoVO> = {};
      
      // æ ¹æ® field å­—æ®µåè¿›è¡Œæ˜¾å¼èµ‹å€¼å–µ
      if (this.field === 'name') {
        updateData.name = this.newValue;
      } else if (this.field === 'phone') {
        updateData.phone = this.newValue;
      } else if (this.field === 'address') {
        updateData.address = this.newValue;
      } else if (this.field === 'description') {
        updateData.description = this.newValue;
      } else if (this.field === 'deliveryPrice') {
        updateData.deliveryPrice = parseFloat(this.newValue);
      } else if (this.field === 'shippingFee') {
        updateData.shippingFee = parseFloat(this.newValue);
      }

      await ShopService.updateShopInfo(updateData);
      
      promptAction.showToast({ message: 'ä¿®æ”¹æˆåŠŸå–µï¼' });
      this.pageStack.pop(); 
    } catch (e) {
      // é”™è¯¯å·²åœ¨ HttpUtil ä¸­ Toast å–µ
    } finally {
      this.isLoading = false;
    }
  }

  build() {
    NavDestination() {
      Column() {
        TextInput({ text: this.newValue, placeholder: 'è¯·è¾“å…¥' + this.title })
          .type(this.isNumber ? InputType.Number : InputType.Normal)
          .height(50)
          .width('90%')
          .backgroundColor(Color.White)
          .borderRadius(8)
          .margin({ top: 30 })
          .onChange(val => this.newValue = val)

        Button(this.isLoading ? 'ä¿å­˜ä¸­...' : 'ä¿ å­˜')
          .width('90%')
          .height(45)
          .backgroundColor($r('app.color.theme_color'))
          .fontColor(Color.Black)
          .margin({ top: 30 })
          .onClick(() => this.handleSave())
      }
      .width('100%')
      .height('100%')
      .backgroundColor($r('app.color.page_background'))
    }
    .title('ä¿®æ”¹' + this.title)
    .onReady((ctx: NavDestinationContext) => {
      const params = ctx.pathInfo.param as EditFieldParam;
      if (params) {
        this.initParams(params);
      }
    })
  }
}
