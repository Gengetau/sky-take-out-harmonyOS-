import { SetmealService, SetmealDTO, SetmealDishDTO, SetmealVO } from '../../service/SetmealService';
import { CategoryService } from '../../service/CategoryService';
import { DishService } from '../../service/DishService';
import { CategoryVO } from '../../model/CategoryModel';
import { DishVO } from '../../model/DishModel';
import { FileUtil } from '../../common/FileUtil';
import { common } from '@kit.AbilityKit';
import { promptAction } from '@kit.ArkUI';

// âœ¨ åˆ†ç±»é€‰æ‹©å¼¹çª— (å¤ç”¨)
@CustomDialog
struct CategorySelectDialog {
  controller: CustomDialogController;
  categories: CategoryVO[] = [];
  onSelect: (category: CategoryVO) => void = () => {};

  build() {
    Column() {
      Row() {
        Text('é€‰æ‹©æ‰€å±åˆ†ç±»').fontSize(18).fontWeight(FontWeight.Bold).fontColor('#333333')
        Blank()
        Image($r('app.media.startIcon')).width(20).height(20).opacity(0.5).onClick(() => this.controller.close())
      }.width('100%').margin({ bottom: 20 })

      Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start }) {
        ForEach(this.categories, (item: CategoryVO) => {
          Text(item.name).fontSize(14).fontColor('#333333').padding({ left: 15, right: 15, top: 10, bottom: 10 })
            .backgroundColor('#F7F7F7').borderRadius(20).margin({ right: 10, bottom: 12 })
            .onClick(() => { this.onSelect(item); this.controller.close(); })
        }, (item: CategoryVO) => item.id.toString())
      }.width('100%')
    }.padding(20).backgroundColor(Color.White).borderRadius(16).width('90%')
  }
}

// âœ¨ å¦®å¨…ç‰¹è‰²çš„èœå“é€‰æ‹©å¼¹çª—å–µï¼ğŸ±
@CustomDialog
struct DishSelectDialog {
  controller: CustomDialogController;
  @State categories: CategoryVO[] = [];
  @State currentCatId: number = 0;
  @State dishList: DishVO[] = [];
  @State selectedMap: Map<number, SetmealDishDTO> = new Map(); // ç”¨ Map è®°å½•é€‰ä¸­çš„çŠ¶æ€å–µ
  onConfirm: (dishes: SetmealDishDTO[]) => void = () => {};

  aboutToAppear() {
    this.loadData();
  }

  async loadData() {
    try {
      this.categories = await CategoryService.getList(1);
      if (this.categories.length > 0) {
        this.currentCatId = this.categories[0].id;
        await this.loadDishes();
      }
    } catch (e) {}
  }

  async loadDishes() {
    this.dishList = await DishService.getList(this.currentCatId);
  }

  updateCount(dish: DishVO, delta: number) {
    let item = this.selectedMap.get(dish.id);
    if (!item) {
      if (delta < 0) return;
      item = new SetmealDishDTO(dish.id, 0);
      item.name = dish.name;
      item.price = dish.price;
    }
    item.copies += delta;
    if (item.copies <= 0) {
      this.selectedMap.delete(dish.id);
    } else {
      this.selectedMap.set(dish.id, item);
    }
    // å¼ºåˆ¶è§¦å‘ UI åˆ·æ–° (Map å†…éƒ¨å˜åŒ–ä¸å“åº”)å–µ
    const newMap = new Map<number, SetmealDishDTO>();
    this.selectedMap.forEach((v, k) => newMap.set(k, v));
    this.selectedMap = newMap;
  }

  build() {
    Column() {
      Text('é€‰æ‹©å¥—é¤åŒ…å«çš„èœå“').fontSize(18).fontWeight(FontWeight.Bold).margin({ bottom: 15 })
      
      Row() {
        // å·¦ä¾§åˆ†ç±»
        List() {
          ForEach(this.categories, (cat: CategoryVO) => {
            ListItem() {
              Text(cat.name).fontSize(12).fontColor(this.currentCatId === cat.id ? '#333333' : '#999999')
                .fontWeight(this.currentCatId === cat.id ? FontWeight.Bold : FontWeight.Normal)
                .padding(10).width('100%').textAlign(TextAlign.Center)
                .backgroundColor(this.currentCatId === cat.id ? Color.White : '#F5F5F5')
            }
            .onClick(() => {
              this.currentCatId = cat.id;
              this.loadDishes();
            })
          }, (cat: CategoryVO) => cat.id.toString())
        }.width(80).height(300).backgroundColor('#F5F5F5')

        // å³ä¾§èœå“
        List() {
          ForEach(this.dishList, (dish: DishVO) => {
            ListItem() {
              Row() {
                Column() {
                  Text(dish.name).fontSize(14).fontColor('#333333')
                  Text(`ï¿¥${dish.price}`).fontSize(12).fontColor(Color.Red).margin({ top: 4 })
                }.alignItems(HorizontalAlign.Start).layoutWeight(1)

                Row({ space: 8 }) {
                  if (this.selectedMap.has(dish.id)) {
                    Text('â€”').fontSize(18).fontColor($r('app.color.theme_color')).onClick(() => this.updateCount(dish, -1))
                    Text(`${this.selectedMap.get(dish.id)?.copies}`).fontSize(14).fontWeight(FontWeight.Bold)
                  }
                  Text('ï¼‹').fontSize(18).fontColor($r('app.color.theme_color')).onClick(() => this.updateCount(dish, 1))
                }
              }.width('100%').padding(10)
            }
          }, (dish: DishVO) => dish.id.toString())
        }.layoutWeight(1).height(300)
      }.width('100%').height(300).border({ width: 1, color: '#F0F0F0' })

      Row({ space: 15 }) {
        Button('å–æ¶ˆ').layoutWeight(1).backgroundColor('#F5F5F5').fontColor('#666666').onClick(() => this.controller.close())
        Button('ç¡®å®š').layoutWeight(1).backgroundColor($r('app.color.theme_color')).fontColor(Color.Black)
          .onClick(() => {
            const result: SetmealDishDTO[] = [];
            this.selectedMap.forEach(v => result.push(v));
            this.onConfirm(result);
            this.controller.close();
          })
      }.width('100%').margin({ top: 20 })
    }.padding(20).backgroundColor(Color.White).borderRadius(16).width('95%')
  }
}

@Component
struct FormItem {
  private label: string = '';
  @BuilderParam content: () => void;
  build() {
    Column() {
      Text(this.label).fontSize(14).fontColor('#666666').margin({ bottom: 8 })
      Column() { if (this.content) this.content(); }.width('100%').padding({ top: 5, bottom: 5 }).border({ width: { bottom: 1 }, color: '#F0F0F0' })
    }.alignItems(HorizontalAlign.Start).width('100%').margin({ bottom: 15 })
  }
}

@Component
export struct SetmealEditPage {
  @Consume('pageStack') pageStack: NavPathStack;
  @State setmeal: SetmealVO | null = null;
  @State categories: CategoryVO[] = [];
  @State name: string = '';
  @State price: string = '';
  @State categoryId: number = 0;
  @State categoryName: string = 'è¯·é€‰æ‹©åˆ†ç±»';
  @State image: string = '';
  @State description: string = '';
  @State selectedDishes: SetmealDishDTO[] = [];
  @State isUploading: boolean = false;
  @State isSaving: boolean = false;

  categoryDialog: CustomDialogController | null = new CustomDialogController({
    builder: CategorySelectDialog({
      categories: this.categories,
      onSelect: (cat: CategoryVO) => { this.categoryId = cat.id; this.categoryName = cat.name; }
    }),
    alignment: DialogAlignment.Center, autoCancel: true, customStyle: true
  });

  // âœ¨ èœå“é€‰æ‹©å¼¹çª—æ§åˆ¶å™¨
  dishSelectDialog: CustomDialogController | null = new CustomDialogController({
    builder: DishSelectDialog({
      onConfirm: (dishes: SetmealDishDTO[]) => { this.selectedDishes = dishes; }
    }),
    alignment: DialogAlignment.Bottom, autoCancel: true, customStyle: true
  });

  aboutToAppear() {
    const params = this.pageStack.getParamByName('SetmealEditPage') as SetmealVO[];
    if (params && params.length > 0) {
      const lastParam = params[params.length - 1];
      if (lastParam) { this.setmeal = lastParam; this.initForm(this.setmeal); }
    }
    this.loadCategories();
  }

  async initForm(vo: SetmealVO) {
    this.name = vo.name; this.price = vo.price.toString(); this.categoryId = vo.categoryId;
    this.categoryName = vo.categoryName || ''; this.image = vo.image; this.description = vo.description;
    try {
      const detail = await SetmealService.getById(vo.id);
      if (detail && detail.setmealDishes) { this.selectedDishes = JSON.parse(JSON.stringify(detail.setmealDishes)); }
    } catch (e) {}
  }

  async loadCategories() {
    try { this.categories = await CategoryService.getList(2); } catch (e) {}
  }

  async handleUpload() {
    const context = getContext(this) as common.UIAbilityContext;
    try {
      const localPath = await FileUtil.pickAndCacheImage(context);
      this.isUploading = true;
      const remoteUrl = await DishService.uploadImage(localPath);
      this.image = remoteUrl;
      promptAction.showToast({ message: 'ä¸Šä¼ æˆåŠŸå–µï¼' });
    } catch (e) {
      const error = e as Error;
      if (error.message !== 'æœªé€‰æ‹©å›¾ç‰‡å–µ') promptAction.showToast({ message: 'ä¸Šä¼ å¤±è´¥: ' + error.message });
    } finally { this.isUploading = false; }
  }

  async handleSave() {
    if (!this.name || !this.price || !this.categoryId || !this.image) {
      promptAction.showToast({ message: 'è¯·å¡«å†™åŸºæœ¬ä¿¡æ¯å–µï¼' }); return;
    }
    this.isSaving = true;
    try {
      const dto = new SetmealDTO(this.categoryId, this.name, parseFloat(this.price), this.image, this.description, this.selectedDishes, this.setmeal ? this.setmeal.id : undefined);
      if (this.setmeal) { await SetmealService.update(dto); promptAction.showToast({ message: 'ä¿®æ”¹æˆåŠŸå–µï¼' }); }
      else { await SetmealService.add(dto); promptAction.showToast({ message: 'æ–°å¢æˆåŠŸå–µï¼' }); }
      this.pageStack.pop();
    } catch (e) {} finally { this.isSaving = false; }
  }

  @Builder NameInput() { TextInput({ placeholder: 'è¯·è¾“å…¥å¥—é¤åç§°', text: this.name }).onChange(val => this.name = val).backgroundColor(Color.Transparent).width('100%') }
  @Builder PriceInput() { TextInput({ placeholder: 'è¯·è¾“å…¥å”®ä»·', text: this.price }).type(InputType.Number).onChange(val => this.price = val).backgroundColor(Color.Transparent).width('100%') }
  @Builder DescriptionInput() { TextArea({ placeholder: 'è¯·è¾“å…¥æè¿°', text: this.description }).onChange(val => this.description = val).backgroundColor(Color.Transparent).height(80).width('100%') }
  @Builder CategoryRow() {
    Row() {
      Text(this.categoryName).fontColor(this.categoryId ? '#333333' : '#999999').layoutWeight(1)
      Image($r('app.media.startIcon')).width(16).height(16).opacity(0.3)
    }.width('100%').onClick(() => this.categoryDialog?.open())
  }

  build() {
    NavDestination() {
      Column() {
        Scroll() {
          Column() {
            Column() {
              if (this.image) { Image(this.image).width('100%').height(180).objectFit(ImageFit.Cover).borderRadius(8).onClick(() => this.handleUpload()) }
              else {
                Column({ space: 10 }) {
                  Image($r('app.media.startIcon')).width(40).height(40).opacity(0.3)
                  Text(this.isUploading ? 'ä¸Šä¼ ä¸­...' : 'ä¸Šä¼ å¥—é¤å°é¢').fontColor('#999999')
                }
                .width('100%').height(180).backgroundColor('#F5F5F5').borderRadius(8).justifyContent(FlexAlign.Center).onClick(() => !this.isUploading && this.handleUpload())
              }
            }.width('100%').margin({ bottom: 20 })

            FormItem({ label: 'å¥—é¤åç§°', content: () => { this.NameInput() } })
            FormItem({ label: 'å¥—é¤åˆ†ç±»', content: () => { this.CategoryRow() } })
            FormItem({ label: 'å¥—é¤å”®ä»·', content: () => { this.PriceInput() } })

            // å¥—é¤èœå“ç®¡ç†
            Column() {
              Row() {
                Text('åŒ…å«èœå“').fontSize(14).fontColor('#666666')
                Blank()
                Text('+ é€‰æ‹©èœå“').fontSize(14).fontColor($r('app.color.theme_color'))
                  .onClick(() => this.dishSelectDialog?.open())
              }.width('100%').margin({ bottom: 10 })
              
              if (this.selectedDishes.length === 0) {
                Text('è¿˜æœªæ·»åŠ èœå“å–µ').fontSize(12).fontColor('#CCCCCC').margin({ top: 10, bottom: 15 })
              } else {
                ForEach(this.selectedDishes, (item: SetmealDishDTO, index: number) => {
                  Row() {
                    Text(item.name || `èœå“ID:${item.dishId}`).fontSize(14).fontColor('#333333')
                    Blank()
                    Text(`x${item.copies}`).fontSize(14).fontColor('#666666')
                  }.width('100%').margin({ bottom: 8 })
                }, (item: SetmealDishDTO, index: number) => index.toString() + (item.dishId?.toString() || ''))
              }
            }.alignItems(HorizontalAlign.Start).width('100%').margin({ bottom: 15 })

            FormItem({ label: 'å¥—é¤æè¿°', content: () => { this.DescriptionInput() } })
          }
          .padding(15)
        }.layoutWeight(1)
        Button(this.isSaving ? 'ä¿å­˜ä¸­...' : 'ä¿ å­˜').width('90%').height(45).backgroundColor($r('app.color.theme_color')).fontColor(Color.Black).margin({ bottom: 20 }).enabled(!this.isSaving).onClick(() => this.handleSave())
      }.width('100%').height('100%').backgroundColor(Color.White)
    }.title(this.setmeal ? 'ä¿®æ”¹å¥—é¤' : 'æ–°å¢å¥—é¤')
  }
}
