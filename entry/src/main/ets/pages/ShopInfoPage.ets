import { promptAction } from '@kit.ArkUI';
import { ShopInfoVO } from '../model/ShopModel';
import { ShopService } from '../service/ShopService';
import { EditFieldParam } from './EditFieldPage';
import { FileUtil } from '../common/FileUtil';
import { common } from '@kit.AbilityKit';
import { HttpUtil } from '../common/HttpUtil';

/**
 * ä¿¡æ¯é¡¹ç»„ä»¶
 */
@Component
struct InfoItemComponent {
  @Prop label: string = '';
  @Prop value: string = '';
  onItemClick: () => void = () => {}; 

  build() {
    ListItem() {
      Row() {
        Text(this.label).fontSize(16).fontColor($r('app.color.text_main'))
        Blank()
        Text(this.value)
          .fontSize(14).fontColor($r('app.color.text_secondary'))
          .maxLines(1).textOverflow({ overflow: TextOverflow.Ellipsis })
          .layoutWeight(1).textAlign(TextAlign.End).margin({ left: 20 })
        Image($r('app.media.startIcon')).width(16).height(16).opacity(0.3).margin({ left: 10 })
      }
      .width('100%').height(60).padding({ left: 15, right: 15 }).backgroundColor(Color.White)
      .onClick(() => {
        this.onItemClick();
      })
    }.margin({ bottom: 1 })
  }
}

@Component
export struct ShopInfoPage {
  @Consume('pageStack') pageStack: NavPathStack;
  @StorageLink('shopInfo') shopInfo: ShopInfoVO | null = null;
  @State isLoading: boolean = false;
  @State isUploadingLogo: boolean = false; // ğŸ¾ Logoä¸Šä¼ çŠ¶æ€

  async aboutToAppear() {
    this.loadShopInfo();
  }

  async loadShopInfo() {
    try {
      if (!this.shopInfo) this.isLoading = true;
      const res = await ShopService.getShopInfo();
      this.shopInfo = res;
      AppStorage.setOrCreate('shopInfo', res);
    } catch (e) {
    } finally {
      this.isLoading = false;
    }
  }

  async toggleStatus(isOn: boolean) {
    if (!this.shopInfo) return;
    const newStatus = isOn ? 1 : 0;
    try {
      await ShopService.setStatus(newStatus);
      this.shopInfo.status = newStatus;
      promptAction.showToast({ message: isOn ? 'å¼€é—¨å¤§å‰å–µï¼â˜€ï¸' : 'è¾›è‹¦äº†ï¼Œä¼‘æ¯æ—¶é—´å–µğŸŒ™' });
      AppStorage.setOrCreate('shopInfo', this.shopInfo);
    } catch (e) {
      this.loadShopInfo(); 
    }
  }

  /**
   * ä¿®æ”¹åº—é“º Logo çš„é­”æ³•é€»è¾‘å–µï¼ğŸ“¸
   */
  async handleLogoUpload() {
    const context = getContext(this) as common.UIAbilityContext;
    
    try {
      // 1. é€‰æ‹©å›¾ç‰‡
      const localPath = await FileUtil.pickAndCacheImage(context);
      
      this.isUploadingLogo = true;
      promptAction.showToast({ message: 'æ­£åœ¨ä¸Šä¼ å›¾ç‰‡å–µ...' });

      // 2. ä¸Šä¼ æ–‡ä»¶åˆ°åç«¯ (API 8.1)
      // æ³¨æ„ï¼šè¿™é‡Œçš„ URL æ˜¯ '/common/upload'
      const uploadedUrl = await HttpUtil.upload<string>('/common/upload', localPath);
      console.info('å–µï¼å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼Œè·å¾— URL:', uploadedUrl);

      // 3. å¼¹å‡ºç¡®è®¤æ¡†å–µ
      AlertDialog.show({
        title: 'æ›´æ¢åº—é“º Logo',
        message: 'å·²ç»ä¸ºæ‚¨å‡†å¤‡å¥½ç¾ç¾çš„å›¾ç‰‡äº†ï¼Œç¡®å®šè¦æ›´æ¢å—å–µï¼Ÿ',
        primaryButton: {
          value: 'å–æ¶ˆ',
          action: () => {
            this.isUploadingLogo = false;
          }
        },
        secondaryButton: {
          value: 'ç¡®å®šä¿®æ”¹',
          action: async () => {
            try {
              // 4. ä¿®æ”¹åº—é“ºä¿¡æ¯ (API 3.5)
              const updateData: Partial<ShopInfoVO> = { avatar: uploadedUrl };
              await ShopService.updateShopInfo(updateData);
              promptAction.showToast({ message: 'Logo ä¿®æ”¹æˆåŠŸå–µï¼âœ¨' });
              this.loadShopInfo(); // åˆ·æ–°æ˜¾ç¤º
            } catch (e) {
              promptAction.showToast({ message: 'ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•å–µ' });
            } finally {
              this.isUploadingLogo = false;
            }
          }
        },
        cancel: () => {
          this.isUploadingLogo = false;
        }
      });

    } catch (e) {
      console.error('å–µï¼Logo ä¸Šä¼ è¿‡ç¨‹å‡ºé”™:', e);
      this.isUploadingLogo = false;
      if (e.message !== 'æœªé€‰æ‹©å›¾ç‰‡å–µ') {
        promptAction.showToast({ message: 'å›¾ç‰‡å¤„ç†å¤±è´¥å–µ' });
      }
    }
  }

  build() {
    NavDestination() {
      Column() {
        if (this.isLoading) {
          LoadingProgress().width(50).height(50).color($r('app.color.theme_color'))
        } else if (this.shopInfo) {
          List() {
            // 1. Logo ç¼–è¾‘é¡¹
            ListItem() {
              Row() {
                Text('åº—é“º Logo').fontSize(16).fontColor($r('app.color.text_main'))
                Blank()
                
                Stack() {
                  Image(this.shopInfo.avatar || $r('app.media.startIcon'))
                    .width(60).height(60).borderRadius(30).objectFit(ImageFit.Cover).backgroundColor('#F0F0F0')
                  
                  if (this.isUploadingLogo) {
                    Column() {
                      LoadingProgress().width(24).height(24).color(Color.White)
                    }
                    .width(60).height(60).borderRadius(30)
                    .backgroundColor('#80000000').justifyContent(FlexAlign.Center)
                  }
                }
                
                Image($r('app.media.startIcon')).width(16).height(16).opacity(0.3).margin({ left: 10 })
              }
              .width('100%').height(80).padding({ left: 15, right: 15 }).backgroundColor(Color.White)
              .onClick(() => {
                if (!this.isUploadingLogo) {
                  this.handleLogoUpload();
                }
              })
            }.margin({ bottom: 1 })

            // 2. è¥ä¸šçŠ¶æ€
            ListItem() {
              Row() {
                Text('è¥ä¸šçŠ¶æ€').fontSize(16).fontColor($r('app.color.text_main'))
                Blank()
                Text(this.shopInfo.status === 1 ? 'æ­£åœ¨è¥ä¸š' : 'å·²æ‰“çƒŠ')
                  .fontSize(14).fontColor(this.shopInfo.status === 1 ? Color.Green : Color.Gray).margin({ right: 10 })
                Toggle({ type: ToggleType.Switch, isOn: this.shopInfo.status === 1 })
                  .selectedColor($r('app.color.theme_color'))
                  .onChange((isOn: boolean) => { this.toggleStatus(isOn); })
              }
              .width('100%').height(60).padding({ left: 15, right: 15 }).backgroundColor(Color.White)
            }.margin({ bottom: 10 })

            // 3. åŸºç¡€ä¿¡æ¯ç¼–è¾‘
            InfoItemComponent({ label: 'åº—é“ºåç§°', value: this.shopInfo.name, onItemClick: () => { this.openInputPrompt('åº—é“ºåç§°', 'name', this.shopInfo!.name) } })
            InfoItemComponent({ label: 'è”ç³»ç”µè¯', value: this.shopInfo.phone || 'æœªå¡«å†™', onItemClick: () => { this.openInputPrompt('è”ç³»ç”µè¯', 'phone', this.shopInfo!.phone) } })
            InfoItemComponent({ label: 'åº—é“ºåœ°å€', value: this.shopInfo.address, onItemClick: () => { this.openInputPrompt('åº—é“ºåœ°å€', 'address', this.shopInfo!.address) } })
            InfoItemComponent({ label: 'åº—é“ºç®€ä»‹', value: this.shopInfo.description || 'æš‚æ— ç®€ä»‹', onItemClick: () => { this.openInputPrompt('åº—é“ºç®€ä»‹', 'description', this.shopInfo!.description) } })

            ListItem() {
              Divider().color(Color.Transparent).height(10)
            }

            // 4. ä»·æ ¼è®¾ç½®
            InfoItemComponent({ 
              label: 'èµ·é€ä»·', 
              value: (this.shopInfo.deliveryPrice || 0).toString() + ' å…ƒ', 
              onItemClick: () => { this.openInputPrompt('èµ·é€ä»·', 'deliveryPrice', (this.shopInfo!.deliveryPrice || 0).toString(), true) } 
            })
            InfoItemComponent({ 
              label: 'é…é€è´¹', 
              value: (this.shopInfo.shippingFee || 0).toString() + ' å…ƒ', 
              onItemClick: () => { this.openInputPrompt('é…é€è´¹', 'shippingFee', (this.shopInfo!.shippingFee || 0).toString(), true) } 
            })

            // 5. è¯„åˆ† (åªè¯»)
            ListItem() {
              Row() {
                Text('åº—é“ºè¯„åˆ†').fontSize(16).fontColor($r('app.color.text_main'))
                Blank()
                Text(this.shopInfo.score.toFixed(1)).fontSize(16).fontWeight(FontWeight.Bold).fontColor('#FFB000')
                Text(' åˆ†').fontSize(12).fontColor('#999999')
              }
              .width('100%').height(60).padding({ left: 15, right: 15 }).backgroundColor(Color.White)
            }
          }
          .width('100%').layoutWeight(1)
        }
      }
      .width('100%').height('100%').backgroundColor($r('app.color.page_background'))
    }
    .title('åº—é“ºè®¾ç½®')
    .onShown(() => {
      this.loadShopInfo();
    })
  }

  openInputPrompt(title: string, field: string, oldVal: string, isNumber: boolean = false) {
    const params = new EditFieldParam(title, field, oldVal, isNumber);
    this.pageStack.pushPath({
      name: 'EditFieldPage',
      param: params
    })
  }
}
