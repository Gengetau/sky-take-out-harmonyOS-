import { promptAction } from '@kit.ArkUI';
import { ShopInfoVO } from '../model/ShopModel';
import { ShopService } from '../service/ShopService';

@Component
export struct ShopInfoPage {
  @Consume('pageStack') pageStack: NavPathStack;
  @State shopInfo: ShopInfoVO | null = null;
  @State isLoading: boolean = true;

  async aboutToAppear() {
    this.loadShopInfo();
  }

  async loadShopInfo() {
    try {
      this.isLoading = true;
      const res = await ShopService.getShopInfo();
      this.shopInfo = res;
      // åŒæ­¥æ›´æ–° AppStorage é‡Œçš„ä¿¡æ¯å–µ
      AppStorage.setOrCreate('shopInfo', res);
    } catch ( e ) {
      // é”™è¯¯å·²å¤„ç†
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * åˆ‡æ¢è¥ä¸šçŠ¶æ€å–µ
   */
  async toggleStatus(isOn: boolean) {
    if (!this.shopInfo ) {
      return;
    }
    const newStatus = isOn ? 1 : 0;
    try {
      await ShopService.setStatus(newStatus);
      this.shopInfo.status = newStatus;
      promptAction.showToast({ message: isOn ? 'å¼€é—¨å¤§å‰å–µï¼â˜€ï¸' : 'è¾›è‹¦äº†ï¼Œä¼‘æ¯æ—¶é—´å–µðŸŒ™' });
      // æ›´æ–°å…¨å±€çŠ¶æ€
      AppStorage.setOrCreate('shopInfo', this.shopInfo);
    } catch ( e ) {
      // å¤±è´¥äº†è¦å¼¹å›žæ¥å–µ
      this.loadShopInfo();
    }
  }

  build() {
    NavDestination() {
      Column() {
        if ( this.isLoading ) {
          LoadingProgress().width(50).height(50).color($r('app.color.theme_color'))
        } else if ( this.shopInfo ) {
          List() {
            // 1. åº—é“º Logo
            ListItem() {
              Row() {
                Text('åº—é“º Logo').fontSize(16).fontColor($r('app.color.text_main'))
                Blank()
                Image(this.shopInfo.avatar || $r('app.media.startIcon'))
                  .width(60)
                  .height(60)
                  .borderRadius(30)
                  .objectFit(ImageFit.Cover)
                  .backgroundColor('#F0F0F0')
                Image($r('app.media.startIcon')) // ç®­å¤´
                  .width(16).height(16).opacity(0.3).margin({ left: 10 })
              }
              .width('100%')
              .height(80)
              .padding({ left: 15, right: 15 })
              .backgroundColor(Color.White)
              .onClick(() => {
                promptAction.showToast({ message: 'ä¿®æ”¹å¤´åƒåŠŸèƒ½å»ºè®¾ä¸­å–µ~' });
              })
            }.margin({ bottom: 1 })

            // 2. åº—é“ºçŠ¶æ€
            ListItem() {
              Row() {
                Text('è¥ä¸šçŠ¶æ€').fontSize(16).fontColor($r('app.color.text_main'))
                Blank()
                Text(this.shopInfo.status === 1 ? 'æ­£åœ¨è¥ä¸š' : 'å·²æ‰“çƒŠ')
                  .fontSize(14)
                  .fontColor(this.shopInfo.status === 1 ? Color.Green : Color.Gray)
                  .margin({ right: 10 })
                Toggle({ type: ToggleType.Switch, isOn: this.shopInfo.status === 1 })
                  .selectedColor($r('app.color.theme_color'))
                  .onChange((isOn: boolean) => {
                    this.toggleStatus(isOn);
                  })
              }
              .width('100%')
              .height(60)
              .padding({ left: 15, right: 15 })
              .backgroundColor(Color.White)
            }.margin({ bottom: 10 })

            // 3. åŸºç¡€ä¿¡æ¯
            this.InfoItem('åº—é“ºåç§°', this.shopInfo.name)
            this.InfoItem('è”ç³»ç”µè¯', this.shopInfo.phone)
            this.InfoItem('åº—é“ºåœ°å€', this.shopInfo.address)
            this.InfoItem('åº—é“ºç®€ä»‹', this.shopInfo.description || 'æš‚æ— ç®€ä»‹å–µ~')

            // 4. åº—é“ºè¯„åˆ† (åªè¯»)
            ListItem() {
              Row() {
                Text('åº—é“ºè¯„åˆ†').fontSize(16).fontColor($r('app.color.text_main'))
                Blank()
                Text(this.shopInfo.score.toFixed(1))
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#FFB000')
                Text(' åˆ†').fontSize(12).fontColor('#999999')
              }
              .width('100%')
              .height(60)
              .padding({ left: 15, right: 15 })
              .backgroundColor(Color.White)
            }
          }
          .width('100%')
          .layoutWeight(1)
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor($r('app.color.page_background'))
      .justifyContent(FlexAlign.Center)
    }
    .title('åº—é“ºè®¾ç½®')
    .backgroundColor($r('app.color.page_background'))
  }

  @Builder
  InfoItem(label: string, value: string) {
    ListItem() {
      Row() {
        Text(label).fontSize(16).fontColor($r('app.color.text_main'))
        Blank()
        Text(value)
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .layoutWeight(1)
          .textAlign(TextAlign.End)
          .margin({ left: 20 })
        Image($r('app.media.startIcon')) // ç®­å¤´
          .width(16).height(16).opacity(0.3).margin({ left: 10 })
      }
      .width('100%')
      .height(60)
      .padding({ left: 15, right: 15 })
      .backgroundColor(Color.White)
      .onClick(() => {
        promptAction.showToast({ message: `ä¿®æ”¹${ label }åŠŸèƒ½å»ºè®¾ä¸­å–µ~` });
      })
    }.margin({ bottom: 1 })
  }
}
