import { abilityAccessCtrl, common, Permissions } from '@kit.AbilityKit';
import { promptAction } from '@kit.ArkUI';
import { BusinessError } from '@kit.BasicServicesKit';
import { geoLocationManager } from '@kit.LocationKit';
import { RegisterDTO, ShopTypeVO } from '../model/ShopModel';
import { ShopService } from '../service/ShopService';

@Component
export struct RegisterPage {
  @Consume('pageStack') pageStack: NavPathStack;
  @State name: string = '';
  @State address: string = '';
  @State phone: string = '';
  @State shopTypeId: number = 0;
  @State isLoading: boolean = false;
  @State shopTypes: ShopTypeVO[] = [];
  @State selectedTypeIndex: number = -1;
  @State longitude: number = 121.5;
  @State latitude: number = 31.2;

  async aboutToAppear() {
    this.loadShopTypes();
  }

  async loadShopTypes() {
    try {
      this.shopTypes = await ShopService.getShopTypes();
      if ( this.shopTypes.length > 0 ) {
        this.shopTypeId = this.shopTypes[0].id;
        this.selectedTypeIndex = 0;
      }
    } catch ( e ) {
      console.error('åŠ è½½åº—é“ºç±»åž‹å¤±è´¥', e);
      this.shopTypes = [ {
        id: 1,
        name: 'ç¾Žé£Ÿ',
        icon: '',
        sort: 1
      } ];
      this.selectedTypeIndex = 0;
      this.shopTypeId = 1;
    }
  }

  async getLocation() {
    const context = getContext(this) as common.UIAbilityContext;
    const atManager = abilityAccessCtrl.createAtManager();
    const permissions: Permissions[] = [ 'ohos.permission.LOCATION', 'ohos.permission.APPROXIMATELY_LOCATION' ];

    try {
      const grantStatus = await atManager.requestPermissionsFromUser(context, permissions);
      const isGranted = grantStatus.authResults.every(result => result === 0);

      if ( isGranted ) {
        promptAction.showToast({ message: 'æ­£åœ¨å®šä½ä¸­...' });

        const request: geoLocationManager.CurrentLocationRequest = {
          'priority': geoLocationManager.LocationRequestPriority.FIRST_FIX,
          'scenario': geoLocationManager.LocationRequestScenario.UNSET,
          'maxAccuracy': 0
        };

        const location = await geoLocationManager.getCurrentLocation(request);
        this.latitude = location.latitude;
        this.longitude = location.longitude;
        promptAction.showToast({ message: `å®šä½æˆåŠŸ: ${ this.latitude.toFixed(2) }, ${ this.longitude.toFixed(2) }` });
      } else {
        promptAction.showToast({ message: 'è¯·æŽˆäºˆå®šä½æƒé™ä»¥èŽ·å–ä½ç½®å–µ' });
      }
    } catch ( err ) {
      const error = err as BusinessError;
      console.error(`å®šä½å¤±è´¥: code=${ error.code }, message=${ error.message }`);
      promptAction.showToast({ message: 'å®šä½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤åæ ‡å–µ' });
    }
  }

  async handleRegister() {
    if (!this.name || !this.address || !this.phone ) {
      promptAction.showToast({ message: 'è¯·å¡«å†™å®Œæ•´ä¿¡æ¯å–µï¼' });
      return;
    }

    this.isLoading = true;
    try {
      // ðŸ¾ ä½¿ç”¨å…·ä½“çš„ RegisterDTO ç±»å®žä¾‹åŒ–æ•°æ®å–µ
      const data = new RegisterDTO(
        this.name,
        this.address,
        this.phone,
        this.shopTypeId,
        '', // avatar
        this.longitude,
        this.latitude
      );

      await ShopService.register(data);

      AlertDialog.show({
        title: 'æäº¤æˆåŠŸ',
        message: 'æ‚¨çš„å…¥é©»ç”³è¯·å·²æäº¤ï¼åˆå§‹è´¦å·ä¸ºæ‰‹æœºå·ï¼Œå¯†ç ä¸º123456å–µã€‚',
        confirm: {
          value: 'åŽ»ç™»å½•',
          action: () => {
            this.pageStack.pop();
          }
        }
      });
    } catch ( e ) {
    } finally {
      this.isLoading = false;
    }
  }

  build() {
    NavDestination() {
      Column() {
        Text('å•†å®¶å…¥é©»')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .margin({ top: 30, bottom: 30 })
          .alignSelf(ItemAlign.Start)
          .padding({ left: 20 })

        List() {
          ListItem() {
            this.InputItem('åº—é“ºåç§°', 'è¯·è¾“å…¥åº—é“ºåç§°', this.name, (val) => this.name = val)
          }

          ListItem() {
            this.InputItem('åº—é“ºåœ°å€', 'è¯·è¾“å…¥è¯¦ç»†åœ°å€', this.address, (val) => this.address = val)
          }

          ListItem() {
            Column() {
              Text('åº—é“ºä½ç½®')
                .fontSize(14)
                .fontColor($r('app.color.text_secondary'))
                .margin({ bottom: 8 })
                .width('100%')

              Row() {
                Text(`ç»åº¦:${ this.longitude.toFixed(2) } çº¬åº¦:${ this.latitude.toFixed(2) }`)
                  .fontSize(14)
                  .fontColor('#333333')
                  .layoutWeight(1)

                Button('èŽ·å–å®šä½')
                  .height(30)
                  .fontSize(12)
                  .backgroundColor($r('app.color.theme_color'))
                  .fontColor(Color.Black)
                  .onClick(() => {
                    this.getLocation();
                  })
              }
              .width('100%')
              .height(50)
              .padding({ left: 10, right: 10 })
              .backgroundColor(Color.White)
              .borderRadius(8)
            }
            .padding({ left: 20, right: 20, bottom: 20 })
          }

          ListItem() {
            this.InputItem('è”ç³»ç”µè¯', 'è¯·è¾“å…¥æ‰‹æœºå·', this.phone, (val) => this.phone = val, InputType.PhoneNumber)
          }

          ListItem() {
            Column() {
              Text('åº—é“ºç±»åž‹')
                .fontSize(14)
                .fontColor($r('app.color.text_secondary'))
                .margin({ bottom: 8 })
                .width('100%')

              if ( this.shopTypes.length > 0 ) {
                // ðŸ¾ ä½¿ç”¨ as SelectOption è§£å†³ç±»åž‹æ£€æŸ¥é—®é¢˜å–µ
                Select(this.shopTypes.map((item: ShopTypeVO) => {
                  return { value: item.name } as SelectOption;
                }))
                  .selected(this.selectedTypeIndex)
                  .value(this.shopTypes[this.selectedTypeIndex]?.name || 'è¯·é€‰æ‹©')
                  .font({ size: 16 })
                  .fontColor($r('app.color.text_main'))
                  .selectedOptionFont({ size: 16 })
                  .optionFont({ size: 16 })
                  .onSelect((index: number) => {
                    this.selectedTypeIndex = index;
                    this.shopTypeId = this.shopTypes[index].id;
                  })
                  .width('100%')
                  .height(50)
                  .backgroundColor(Color.White)
                  .borderRadius(8)
              } else {
                Text('åŠ è½½ç±»åž‹ä¸­...')
                  .fontSize(14)
                  .fontColor('#999999')
              }
            }
            .padding({ left: 20, right: 20, bottom: 20 })
          }
        }
        .width('100%')
        .layoutWeight(1)

        Button(this.isLoading ? 'æäº¤ä¸­...' : 'æäº¤ç”³è¯·')
          .width('90%')
          .height(50)
          .backgroundColor($r('app.color.theme_color'))
          .fontColor(Color.Black)
          .fontSize(18)
          .margin({ bottom: 30 })
          .enabled(!this.isLoading)
          .onClick(() => this.handleRegister())
      }
      .width('100%')
      .height('100%')
      .backgroundColor($r('app.color.page_background'))
    }
    .title('å…¥é©»ç”³è¯·')
  }

  @Builder
  InputItem(label: string, placeholder: string, value: string, onChange: (val: string) => void,
    type: InputType = InputType.Normal) {
    Column() {
      Text(label)
        .fontSize(14)
        .fontColor($r('app.color.text_secondary'))
        .margin({ bottom: 8 })
        .width('100%')

      TextInput({ placeholder: placeholder, text: value })
        .type(type)
        .height(50)
        .backgroundColor(Color.White)
        .borderRadius(8)
        .onChange(onChange)
    }
    .padding({ left: 20, right: 20, bottom: 20 })
  }
}
