import { promptAction } from '@kit.ArkUI';
import { DishVO, SetMealVO } from '../../../model/entity/ShopModel';
import { CartService } from '../../../service/CartService';

/**
 * èœå“å¡ç‰‡ç»„ä»¶
 */
@Component
export struct DishCard {
  dish: DishVO | undefined;
  @Prop isShopOpen: boolean; // æ–°å¢ï¼šæ¥æ”¶åº—é“ºè¥ä¸šçŠ¶æ€
  @Prop isSetmeal: boolean = false; // âœ¨ æ–°å¢ï¼šæ˜¯å¦ä¸ºå¥—é¤
  public onOpenFlavorDialog: (dish: DishVO) => void = () => {
  };
  // ğŸ“¡ ç›‘å¬å¹¿æ’­ï¼šåªè¦ AppStorage é‡Œçš„ 'CartUpdateSignal' å˜äº†ï¼Œå°±æ‰§è¡Œ onUpdate
  @StorageProp('CartUpdateSignal') @Watch('updateQuantity') cartSignal: number = 0;
  // ğŸ”¢ æœ¬åœ°çŠ¶æ€ï¼šå½“å‰èœå“çš„æ•°é‡
  @State quantity: number = 0;
  // è·å– Service å®ä¾‹ (ä»…ç”¨äºè°ƒç”¨æ–¹æ³•ï¼Œä¸ç”¨äºç›‘å¬)
  private cartService = CartService.getInstance();

  aboutToAppear(): void {
    // åˆå§‹åŒ–æ—¶å…ˆç®—ä¸€æ¬¡
    this.updateQuantity();
  }

  // âš¡ å½“ä¿¡å·å˜åŒ–æ—¶ï¼Œé‡æ–°è®¡ç®—æ•°é‡
  updateQuantity() {
    if (!this.dish ) {
      return;
    }

    // åˆ¤æ–­é€»è¾‘ï¼šå¦‚æœæœ‰è§„æ ¼ï¼Œæˆ‘ä»¬æ˜¾ç¤ºæ€»æ•°ï¼›æ²¡è§„æ ¼ï¼Œæ˜¾ç¤ºå•å“æ•°é‡
    // (é€šå¸¸åˆ—è¡¨é¡µæ˜¾ç¤ºçš„æ˜¯è¯¥èœå“æ‰€æœ‰è§„æ ¼çš„æ€»æ•°ï¼Œæˆ–è€…åªæ“ä½œé»˜è®¤è§„æ ¼)
    // è¿™é‡Œæˆ‘ä»¬ç»Ÿä¸€é€»è¾‘ï¼šDishCard æ˜¾ç¤ºè¯¥ DishID ä¸‹çš„æ‰€æœ‰æ•°é‡
    this.quantity = this.cartService.getTotalQuantityForDish(this.dish.id);

    // å¦‚æœéœ€è¦ç²¾ç¡®åŒ¹é…æ— è§„æ ¼çš„ï¼š
    // this.quantity = this.cartService.getDishQuantity(this.dish.id, '');
  }

  build() {
    // âœ¨ å®‰å…¨å®ˆå«ï¼šåœ¨ dish æ•°æ®ç¡®è®¤å­˜åœ¨ä¹‹å‰ï¼Œä»€ä¹ˆéƒ½ä¸æ¸²æŸ“ï¼Œé˜²æ­¢å´©æºƒï¼
    if (!this.dish ) {
      Column()
    } else {
      // âœ¨ build() æ–¹æ³•ç°åœ¨éå¸¸çº¯ç²¹ï¼Œåªè´Ÿè´£UIæè¿°ï¼
      Row({ space: 10 }) {
        Image(this.dish.image)
          .width(80)
          .height(80)
          .borderRadius(5)
          .objectFit(ImageFit.Cover)
          .backgroundColor('#EEEEEE')

        Column({ space: 5 }) {
          Text(this.dish.name).fontSize(16).fontWeight(FontWeight.Bold)
            .maxLines(1).textOverflow({ overflow: TextOverflow.Ellipsis })
          Text(this.dish.description).fontSize(10).fontColor('#999999')
            .maxLines(1).textOverflow({ overflow: TextOverflow.Ellipsis })

          Blank().layoutWeight(1)

          Row() {
            Text('Â¥').fontSize(12).fontColor('#E94E20').baselineOffset(-2)
            Text(this.dish.price.toFixed(2)).fontSize(18).fontColor('#E94E20').fontWeight(FontWeight.Bold)

            Blank()

            if ( this.dish.flavors && this.dish.flavors.length > 0 ) {
              Stack({ alignContent: Alignment.TopEnd }) {
                Button('é€‰è§„æ ¼')
                  .type(ButtonType.Capsule)
                  .backgroundColor('#FFCC00')
                  .fontColor('#333333')
                  .height(28)
                  .padding({ left: 12, right: 12 })
                  .fontSize(12)
                  .enabled(this.isShopOpen) // Disable if shop is closed
                  .onClick(() => {
                    this.onOpenFlavorDialog(this.dish!);
                  })

                // ğŸ”´ æ•°é‡å¾½ç«  (ç›‘å¬ this.quantity)
                if ( this.quantity > 0 ) {
                  Text(this.quantity.toString())
                    .fontSize(10)
                    .fontColor(Color.White)
                    .backgroundColor('#FF3B30')
                    .borderRadius(8)
                    .padding({ left: 4, right: 4 })
                    .height(16)
                    .textAlign(TextAlign.Center)
                    .offset({ x: 8, y: -8 })
                }
              }
            } else {
              // âœ¨ é€»è¾‘ä¿®æ­£ï¼šæ— è§„æ ¼çš„èœå“ï¼Œåº”è¯¥ç”¨ quantity
              if ( this.quantity > 0 ) {
                Row({ space: 8 }) {
                  // â– å‡å·
                  Button() {
                    Image($r('app.media.ic_decrease'))
                      .width(24)
                      .height(24)
                      .fillColor('#AAAAAA') // å‡è®¾æ‚¨æœ‰å‡å·å›¾ï¼Œæˆ–è€…ç”¨ Text('-')
                  }
                  .width(28)
                  .height(28)
                  .type(ButtonType.Circle)
                  .backgroundColor('transparent')
                  .border({ width: 1, color: '#DDDDDD' }) // å‡å·é€šå¸¸æ˜¯ç©ºå¿ƒæˆ–ç°åº•
                  .enabled(this.isShopOpen) // Disable if shop is closed
                  .onClick(() => {
                    this.cartService.decreaseItemByDish(this.dish!.id, '');
                  })

                  // ğŸ”¢ æ•°é‡
                  Text(this.quantity.toString()).fontSize(16).fontWeight(FontWeight.Medium)

                  // â• åŠ å·
                  Button() {
                    Image($r('app.media.ic_increase')).width(24).height(24) // å‡è®¾æ‚¨æœ‰åŠ å·å›¾ï¼Œæˆ–è€…ç”¨ Text('+')
                  }
                  .width(28)
                  .height(28)
                  .type(ButtonType.Circle)
                  .backgroundColor('#FFCC00')
                  .enabled(this.isShopOpen) // Disable if shop is closed
                  .onClick(() => {
                    this.addToCart();
                  })
                }
                .alignItems(VerticalAlign.Center)
              } else {
                Button() {
                  Image($r('app.media.ic_increase')).width(24).height(24)
                }
                .width(28)
                .height(28)
                .type(ButtonType.Circle)
                .backgroundColor('#FFCC00')
                .enabled(this.isShopOpen) // Disable if shop is closed
                .onClick(() => {
                  this.addToCart();
                  promptAction.showToast({ message: 'åŠ è´­æˆåŠŸ' }); // å¯é€‰ï¼šè¦ä¸è¦æç¤ºçœ‹ä½“éªŒ
                })
              }
            }
          }
          .width('100%')
        }
        .layoutWeight(1)
        .height(80)
        .alignItems(HorizontalAlign.Start)
      }
      .width('100%')
      .padding(10)
    }
  }
  addToCart() {
    if (!this.dish) return;
    if (this.isSetmeal) {
      // æ„é€  SetMealVO (è™½ç„¶æœ‰ç‚¹ç¬¨æ‹™ï¼Œä½†ç±»å‹å®‰å…¨)
      const setmeal = new SetMealVO(
        this.dish.id, 
        this.dish.categoryId, 
        this.dish.name, 
        this.dish.price, 
        this.dish.status, 
        this.dish.description, 
        this.dish.image
      );
      this.cartService.addSetmeal(setmeal);
    } else {
      this.cartService.addItem(this.dish, '');
    }
  }
}