import { CartService } from '../../../service/CartService';
import { CartDialog } from './CartDialog';

/**
 * è´­ç‰©è½¦æ¡
 */
@Component
export struct CartBar {
  @Prop isShopOpen: boolean;
  // å¢åŠ ä¸€ä¸ªç‚¹å‡»å»ç»“ç®—çš„å›è°ƒï¼Œé€šçŸ¥çˆ¶ç»„ä»¶å¼¹çª—
  onCheckout: () => void = () => {};
  
  @StorageProp('CartUpdateSignal') @Watch('onUpdate') cartSignal: number = 0;
  @State totalCount: number = 0;
  @State totalPrice: number = 0;
  // âœ¨ ä¿®æ­£1ï¼šå‡çº§ä¸º @Stateï¼Œä½¿å…¶èƒ½ä¸ºå­ç»„ä»¶çš„ @ObjectLink æä¾›æ•°æ®æº
  @State cartService: CartService = CartService.getInstance();
  // èµ·é€è´¹å¯ä»¥ä½œä¸ºå¸¸é‡æˆ–ä»é…ç½®ä¸­è¯»å–
  private minOrderPrice: number = 20;
  // å¼¹çª—æ§åˆ¶å™¨
  private cartDialogController: CustomDialogController = new CustomDialogController({
    builder: CartDialog({
      cartService: this.cartService
    }),
    alignment: DialogAlignment.Bottom,
    customStyle: true,
    autoCancel: true
  });

  aboutToAppear() {
    this.onUpdate();
  }

  onUpdate() {
    // æ¯æ¬¡ä¿¡å·å˜äº†ï¼Œé‡æ–°ä» Service æ‹‰å–æœ€æ–°æ•°æ®
    this.totalCount = this.cartService.totalCount;
    this.totalPrice = this.cartService.totalPrice;
  }

  build() {
    // å¤–å±‚ Stack ç”¨äºè®©å›¾æ ‡æ‚¬æµ®åœ¨ Bar ä¹‹ä¸Š
    Stack({ alignContent: Alignment.BottomStart }) {
      if (this.isShopOpen) {
        // --- 1. è´­ç‰©è½¦æ¡ä¸»ä½“ (é»‘è‰²çš„èƒŒæ™¯æ¡) ---
        Row() {
          // å·¦ä¾§ç•™ç™½ (ç»™å¤§å›¾æ ‡è…¾ä½ç½®)
          Blank().width(110)

          // ä¸­é—´ï¼šä»·æ ¼ä¿¡æ¯
          Column() {
            if ( this.totalCount > 0 ) {
              Text(`Â¥ ${ this.totalPrice.toFixed(2) }`)
                .fontSize(18).fontColor(Color.White).fontWeight(FontWeight.Bold)
              Text('é¢„ä¼°é…é€è´¹ Â¥6').fontSize(10).fontColor('#999999')
            } else {
              Text('æœªé€‰è´­å•†å“').fontSize(14).fontColor('#999999')
            }
          }
          .layoutWeight(1).alignItems(HorizontalAlign.Start)

          // å³ä¾§ï¼šæŒ‰é’®
          Row() {
            if ( this.totalPrice >= this.minOrderPrice ) {
              Button('å»ç»“ç®—')
                .type(ButtonType.Normal)
                .backgroundColor('#FFCC00')
                .fontColor('#333333')
                .borderRadius({ topRight: 25, bottomRight: 25 })
                .width(100)
                .height('100%')
                .onClick(() => {
                  console.info('å–µï¼å»ä»˜é’±ï¼');
                  if (this.onCheckout) {
                    this.onCheckout();
                  }
                  // âœ¨ ä¿®æ­£2ï¼šè¿”å› true æ¥é˜»æ­¢äº‹ä»¶å†’æ³¡
                  return true;
                })
            } else {
              Text(`Â¥${ this.minOrderPrice }èµ·é€`)
                .fontColor('#999999').fontSize(14).fontWeight(FontWeight.Bold).padding({ right: 20 })
            }
          }.height('100%')
        }
        .onClick(() => {
          if ( this.cartService.totalCount > 0 ) {
            this.cartDialogController.open();
          }
        })
        .width('94%')
        .height(50)
        .backgroundColor('#222222')
        .borderRadius(25)
        .shadow({ radius: 10, color: '#40000000', offsetY: 5 })
        .margin({ bottom: 10 }) // è·ç¦»å±å¹•åº•éƒ¨ä¸€ç‚¹è·ç¦»

        // --- 2. æ‚¬æµ®çš„å¤§å›¾æ ‡ (å¤–å–å°å“¥) ---
        Stack({ alignContent: Alignment.TopEnd }) {
          // ğŸ›µ å¤–å–å°å“¥å¤§å›¾
          Image($r('app.media.cart_logo')) // ğŸ‘ˆ è®°å¾—ç¡®è®¤æ–‡ä»¶åå“¦ï¼
            .width(110) // è¶³å¤Ÿå¤§ï¼Œæ‰èƒ½çªå‡º
            .height(110)
            .objectFit(ImageFit.Contain)

          // ğŸ”´ æ•°å­—å¾½ç« 
          if ( this.cartService.totalCount > 0 ) {
            Text(this.cartService.totalCount.toString())
              .fontSize(10)
              .fontColor(Color.White)
              .backgroundColor('#FF3B30')
              .borderRadius(10)
              .padding({ left: 5, right: 5 })
              .height(16)
              .textAlign(TextAlign.Center)
              // å¾®è°ƒå¾½ç« ä½ç½®ï¼ŒæŒ‚åœ¨å°å“¥å¤´ç›”æ—è¾¹
              .position({ x: 70, y: 20 })
          }
        }
        .width(110).height(110)
        .zIndex(2) // å±‚çº§æœ€é«˜ï¼Œç›–ä½ Bar
      } else {
        // --- 1. è´­ç‰©è½¦æ¡ä¸»ä½“ (æ‰“çƒŠçŠ¶æ€) ---
        Row() {
          Text('æœ¬åº—å·²æ‰“çƒŠ').fontSize(16).fontColor(Color.White).fontWeight(FontWeight.Bold)
        }
        .width('94%')
        .height(50)
        .backgroundColor('#AAAAAA') // ç°è‰²èƒŒæ™¯
        .borderRadius(25)
        .shadow({ radius: 10, color: '#40000000', offsetY: 5 })
        .margin({ bottom: 10 })
        .justifyContent(FlexAlign.Center) // æ–‡å­—å±…ä¸­

        // æ‚¬æµ®å›¾æ ‡ (å¯ä»¥éšè—æˆ–æ˜¾ç¤ºç°è‰²ç‰ˆæœ¬)
        Image($r('app.media.cart_logo'))
          .width(110)
          .height(110)
          .objectFit(ImageFit.Contain)
          .grayscale(1) // ç½®ç°
          .opacity(0.5) // åŠé€æ˜
          .zIndex(2)
          .alignSelf(ItemAlign.Start) // ä¿æŒå·¦ä¸‹è§’å¯¹é½
          .offset({ x: 0, y: 0 }) // è°ƒæ•´ä½ç½®
      }
    }
    .width('100%')
  }
}