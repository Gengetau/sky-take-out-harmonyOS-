import { promptAction } from '@kit.ArkUI';
import { ShopVO } from '../../../model/entity/ShopModel';
import { ShopService } from '../../../service/ShopService';

/**
 * å•†åº—å¤´éƒ¨é‡æž„ç‰ˆ - å±•çŽ°çœŸå®žå•†æˆ·é£Žé‡‡å–µ âœ¨
 */
@Component
export struct ShopHeader {
  @Prop isShopOpen: boolean;
  @Prop shopInfo: ShopVO | null;
  @State isFollowed: boolean = false; // âœ¨ å…³æ³¨çŠ¶æ€

  // ç›‘å¬ shopInfo å˜åŒ–ï¼Œé‡æ–°æ£€æŸ¥å…³æ³¨çŠ¶æ€
  @Watch('checkFollowStatus') @Prop shopId: number = 0; 

  async aboutToAppear() {
    this.checkFollowStatus();
  }

  async checkFollowStatus() {
    // ä¼˜å…ˆä½¿ç”¨ shopIdï¼Œå³ä½¿ shopInfo è¿˜æ²¡åŠ è½½ä¹Ÿèƒ½æŸ¥çŠ¶æ€å–µï¼
    const targetId = this.shopId || this.shopInfo?.id;
    if (targetId) {
      this.isFollowed = await ShopService.isShopFollowed(targetId);
    }
  }

  async toggleFollow() {
    if (!this.shopInfo) return;

    if (this.isFollowed) {
      // å–æ¶ˆå…³æ³¨
      const success = await ShopService.unfollowShop(this.shopInfo.id);
      if (success) {
        this.isFollowed = false;
        promptAction.showToast({ message: 'å·²å–æ¶ˆå…³æ³¨å–µ ðŸ’”' });
      } else {
        promptAction.showToast({ message: 'æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•å–µ' });
      }
    } else {
      // å…³æ³¨
      const success = await ShopService.followShop(this.shopInfo);
      if (success) {
        this.isFollowed = true;
        promptAction.showToast({ message: 'å…³æ³¨æˆåŠŸå–µï¼ðŸ’–' });
      } else {
        promptAction.showToast({ message: 'å…³æ³¨å¤±è´¥ï¼Œè¯·é‡è¯•å–µ' });
      }
    }
  }

  build() {
    Stack({ alignContent: Alignment.Bottom }) {

      // 1. èƒŒæ™¯å¤§å›¾ (å¸¦æ¨¡ç³Šæ•ˆæžœ)
      Image(this.shopInfo?.avatar || $r('app.media.shop_header'))
        .width('100%')
        .height(100)
        .objectFit(ImageFit.Cover)
        .blur(15)

      // 2. å†…å®¹å¡ç‰‡ (ç™½è‰²æ‚¬æµ®å¡ç‰‡)
      Row() {
        // (1) å·¦ä¾§ Logo
        Image(this.shopInfo?.avatar || $r('app.media.shop_logo'))
          .width(60)
          .height(60)
          .borderRadius(4)
          .margin({ right: 10 })
          .shadow({ radius: 5, color: '#33000000', offsetY: 2 })
          .objectFit(ImageFit.Cover)

        // (2) ä¸­é—´ä¿¡æ¯
        Column({ space: 5 }) {
          // åº—å + æ ‡ç­¾
          Row() {
            Text(this.shopInfo?.name || 'å•†å®¶åŠ è½½ä¸­...')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333333')
              .layoutWeight(1)
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })

            // æ ¹æ®çŠ¶æ€æ˜¾ç¤º
            if ( this.isShopOpen ) {
              Text('è¥ä¸šä¸­')
                .fontSize(10)
                .fontColor(Color.White)
                .backgroundColor('#4CD964')
                .padding({
                  left: 4,
                  right: 4,
                  top: 2,
                  bottom: 2
                })
                .borderRadius(2)
                .margin({ left: 8 })
            } else {
              Text('ä¼‘æ¯ä¸­')
                .fontSize(10)
                .fontColor(Color.White)
                .backgroundColor('#AAAAAA')
                .padding({
                  left: 4,
                  right: 4,
                  top: 2,
                  bottom: 2
                })
                .borderRadius(2)
                .margin({ left: 8 })
            }
          }.width('100%')

          // é…é€ä¿¡æ¯ Row
          Row() {
            // ðŸ“ è·ç¦» (å¦‚æžœæœ‰çš„è¯)
            if ( this.shopInfo?.distance ) {
              SymbolGlyph($r('sys.symbol.local'))
                .fontSize(12)
                .fontColor([ '#0D9FFB' ])
                .margin({ right: 2 })
              Text(this.shopInfo.distance).fontSize(10).fontColor('#0D9FFB')
              Text(' | ').fontSize(10).fontColor('#DDDDDD').margin({ left: 5, right: 5 })
            }

            // ðŸ’° é…é€è´¹
            Text(`é…é€ ï¿¥${ this.shopInfo?.shippingFee ?? 0 }`).fontSize(10).fontColor('#666666')

            // åˆ†å‰²çº¿
            Text(' | ').fontSize(10).fontColor('#DDDDDD').margin({ left: 5, right: 5 })

            // ðŸ•’ æ—¶é—´
            Text(`çº¦ ${ this.shopInfo?.averageDeliveryTime ?? 0 } min`).fontSize(10).fontColor('#666666')
          }

          // å…¬å‘Š (å•è¡Œçœç•¥)
          Text(this.shopInfo?.description || 'æ¬¢è¿Žå…‰ä¸´æœ¬å°åº—å–µ~')
            .fontSize(10)
            .fontColor('#999999')
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .width('100%')
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)

        // (3) å³ä¾§æ”¶è—/ç”µè¯æŒ‰é’®
        Column() {
          // âœ¨ æ ¹æ®å…³æ³¨çŠ¶æ€åˆ‡æ¢å›¾æ ‡å’Œé¢œè‰²
          SymbolGlyph(this.isFollowed ? $r('sys.symbol.heart_fill') : $r('sys.symbol.heart'))
            .fontSize(20)
            .fontColor([ this.isFollowed ? '#FF3B30' : '#333333' ]) // å·²å…³æ³¨æ˜¾ç¤ºçº¢è‰²
            .margin({ bottom: 4 })
            
          Text(this.isFollowed ? 'å·²å…³æ³¨' : 'å…³æ³¨')
            .fontSize(10)
            .fontColor(this.isFollowed ? '#FF3B30' : '#333')
        }
        .justifyContent(FlexAlign.Center)
        .width(40)
        .onClick(() => this.toggleFollow())

      }
      .width('94%')
      .height(80)
      .backgroundColor(Color.White)
      .borderRadius(8)
      .padding(10)
      .margin({ bottom: 10 })
      .shadow({ radius: 10, color: '#10000000', offsetY: 5 })

    }
    .width('100%')
    .height(120)
    .backgroundColor('#F5F5F5')
  }
}