import { promptAction } from '@kit.ArkUI';
import { ShopVO } from '../../../model/entity/ShopModel';
import { ShopService } from '../../../service/ShopService';
import { ChatPageParam } from '../../message/ChatPage';

/**
 * ÂïÜÂ∫óÂ§¥ÈÉ®ÈáçÊûÑÁâà - Â±ïÁé∞ÁúüÂÆûÂïÜÊà∑È£éÈááÂñµ ‚ú®
 */
@Component
export struct ShopHeader {
  @Consume('pageStack') pageStack: NavPathStack;
  @Prop isShopOpen: boolean;
  @Prop shopInfo: ShopVO | null;
  @State isFollowed: boolean = false; // ÂÖ≥Ê≥®Áä∂ÊÄÅ

  // ÁõëÂê¨ shopId ÂèòÂåñÔºåÈáçÊñ∞Ê£ÄÊü•ÂÖ≥Ê≥®Áä∂ÊÄÅ
  @Watch('checkFollowStatus') @Prop shopId: number = 0; 

  async aboutToAppear() {
    this.checkFollowStatus();
  }

  async checkFollowStatus() {
    // ‰ºòÂÖà‰ΩøÁî® shopIdÔºåÂç≥‰Ωø shopInfo ËøòÊ≤°Âä†ËΩΩ‰πüËÉΩÊü•Áä∂ÊÄÅÂñµÔºÅ
    const targetId = this.shopId || this.shopInfo?.id;
    if (targetId) {
      this.isFollowed = await ShopService.isShopFollowed(targetId);
    }
  }

  async toggleFollow() {
    if (!this.shopInfo) return;

    if (this.isFollowed) {
      // ÂèñÊ∂àÂÖ≥Ê≥®
      const success = await ShopService.unfollowShop(this.shopInfo.id);
      if (success) {
        this.isFollowed = false;
        promptAction.showToast({ message: 'Â∑≤ÂèñÊ∂àÂÖ≥Ê≥®Âñµ üíî' });
      } else {
        promptAction.showToast({ message: 'Êìç‰ΩúÂ§±Ë¥•ÔºåËØ∑ÈáçËØïÂñµ' });
      }
    } else {
      // ÂÖ≥Ê≥®
      const success = await ShopService.followShop(this.shopInfo);
      if (success) {
        this.isFollowed = true;
        promptAction.showToast({ message: 'ÂÖ≥Ê≥®ÊàêÂäüÂñµÔºÅüíñ' });
      } else {
        promptAction.showToast({ message: 'ÂÖ≥Ê≥®Â§±Ë¥•ÔºåËØ∑ÈáçËØïÂñµ' });
      }
    }
  }

  build() {
    Stack({ alignContent: Alignment.Bottom }) {

      // 1. ËÉåÊôØÂ§ßÂõæ (Â∏¶Ê®°Á≥äÊïàÊûú)
      Image(this.shopInfo?.avatar || $r('app.media.shop_header'))
        .width('100%')
        .height(100)
        .objectFit(ImageFit.Cover)
        .blur(15)

      // 2. ÂÜÖÂÆπÂç°Áâá (ÁôΩËâ≤ÊÇ¨ÊµÆÂç°Áâá)
      Row() {
        // (1) Â∑¶‰æß Logo
        Image(this.shopInfo?.avatar || $r('app.media.shop_logo'))
          .width(60)
          .height(60)
          .borderRadius(4)
          .margin({ right: 10 })
          .shadow({ radius: 5, color: '#33000000', offsetY: 2 })
          .objectFit(ImageFit.Cover)

        // (2) ‰∏≠Èó¥‰ø°ÊÅØ
        Column({ space: 5 }) {
          // Â∫óÂêç + Ê†áÁ≠æ
          Row() {
            Text(this.shopInfo?.name || 'ÂïÜÂÆ∂Âä†ËΩΩ‰∏≠...')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333333')
              .layoutWeight(1)
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })

            // Ê†πÊçÆÁä∂ÊÄÅÊòæÁ§∫
            if ( this.isShopOpen ) {
              Text('Ëê•‰∏ö‰∏≠')
                .fontSize(10)
                .fontColor(Color.White)
                .backgroundColor('#4CD964')
                .padding({ left: 4, right: 4, top: 2, bottom: 2 })
                .borderRadius(2)
                .margin({ left: 8 })
            } else {
              Text('‰ºëÊÅØ‰∏≠')
                .fontSize(10)
                .fontColor(Color.White)
                .backgroundColor('#AAAAAA')
                .padding({ left: 4, right: 4, top: 2, bottom: 2 })
                .borderRadius(2)
                .margin({ left: 8 })
            }
          }.width('100%')

          // ÈÖçÈÄÅ‰ø°ÊÅØ Row
          Row() {
            // üìç Ë∑ùÁ¶ª (Â¶ÇÊûúÊúâÁöÑËØù)
            if ( this.shopInfo?.distance ) {
              SymbolGlyph($r('sys.symbol.local'))
                .fontSize(12)
                .fontColor([ '#0D9FFB' ])
                .margin({ right: 2 })
              Text(this.shopInfo.distance).fontSize(10).fontColor('#0D9FFB')
              Text(' | ').fontSize(10).fontColor('#DDDDDD').margin({ left: 5, right: 5 })
            }

            // üí∞ ÈÖçÈÄÅË¥π
            Text(`ÈÖçÈÄÅ Ôø•${ this.shopInfo?.shippingFee ?? 0 }`).fontSize(10).fontColor('#666666')

            // ÂàÜÂâ≤Á∫ø
            Text(' | ').fontSize(10).fontColor('#DDDDDD').margin({ left: 5, right: 5 })

            // üïí Êó∂Èó¥
            Text(`Á∫¶ ${ this.shopInfo?.averageDeliveryTime ?? 0 } min`).fontSize(10).fontColor('#666666')
          }

          // ÂÖ¨Âëä (ÂçïË°åÁúÅÁï•)
          Text(this.shopInfo?.description || 'Ê¨¢ËøéÂÖâ‰∏¥Êú¨Â∞èÂ∫óÂñµ~')
            .fontSize(10)
            .fontColor('#999999')
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .width('100%')
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)

        // (3) Âè≥‰æßÊìç‰ΩúÂå∫ (ÂÖ≥Ê≥® + ËÅîÁ≥ª)
        Row({ space: 12 }) { 
          // ÂÖ≥Ê≥®ÊåâÈíÆ
          Column() {
            SymbolGlyph(this.isFollowed ? $r('sys.symbol.heart_fill') : $r('sys.symbol.heart'))
              .fontSize(20)
              .fontColor([ this.isFollowed ? '#FF3B30' : '#333333' ]) // Â∑≤ÂÖ≥Ê≥®ÊòæÁ§∫Á∫¢Ëâ≤
              .margin({ bottom: 4 })
            
            Text(this.isFollowed ? 'Â∑≤ÂÖ≥Ê≥®' : 'ÂÖ≥Ê≥®')
              .fontSize(10)
              .fontColor(this.isFollowed ? '#FF3B30' : '#333')
          }
          .justifyContent(FlexAlign.Center)
          .onClick(() => this.toggleFollow())

          // ËÅîÁ≥ªÂïÜÂÆ∂ÊåâÈíÆ
          Column() {
            SymbolGlyph($r('sys.symbol.message'))
              .fontSize(20)
              .fontColor(['#007DFF'])
              .margin({ bottom: 4 })
            Text('ËÅîÁ≥ª')
              .fontSize(10)
              .fontColor('#333')
          }
          .justifyContent(FlexAlign.Center)
          .onClick(() => {
            if (this.shopInfo) {
              const sessionId = `shop_${this.shopInfo.id}`;
              const title = this.shopInfo.name;
              const avatar = this.shopInfo.avatar || '';
              // Ë∑≥ËΩ¨Âà∞ËÅäÂ§©È°µ
              this.pageStack.pushPath({ name: 'ChatPage', param: new ChatPageParam(sessionId, title, avatar) });
            }
          })

        }
        .padding({ left: 5 })
      }
      .width('94%')
      .height(80)
      .backgroundColor(Color.White)
      .borderRadius(8)
      .padding(10)
      .margin({ bottom: 10 })
      .shadow({ radius: 10, color: '#10000000', offsetY: 5 })

    }
    .width('100%')
    .height(120)
    .backgroundColor('#F5F5F5')
  }
}
