import { common } from '@kit.AbilityKit';
import { HttpUtil } from '../common/utils/HttpUtil';
import { PreferencesUtil } from '../common/utils/PreferencesUtil';
import { AuthService } from '../service/AuthService';
import { CartService } from '../service/CartService';
import { WebSocketService } from '../service/WebSocketService';
import { AddressBookPage } from './address/AddressBookPage';
import { AddressEditPage } from './address/AddressEditPage';
import { AddressEditRoutePage } from './address/AddressEditRoutePage';
import { AddressMapPage } from './address/AddressMapPage';
import { Login } from './Login';
import { AccountSecurityPage } from './main/AccountSecurityPage';
import { ConfirmOrderView } from './main/ConfirmOrderPage';
import { MyFollowPage } from './main/MyFollowPage';
import { OrderDetailPage } from './main/OrderDetailPage';
import { OrderHistoryPage } from './main/OrderHistoryPage';

import { PaymentPage } from './main/PaymentPage';
import { PaySuccessPage } from './main/PaySuccessPage';
import { RemarkPage } from './main/RemarkPage';
import { SettingsPage } from './main/SettingsPage';
import { UserProfilePage } from './main/UserProfilePage';
import { MainTabs } from './MainTabs';

import { ChatPage } from './message/ChatPage'; // âœ¨ å¼•å…¥ ChatPage
import { SystemNotifyPage } from './message/SystemNotifyPage'; // âœ¨ å¼•å…¥ SystemNotifyPage
import { ShopPage } from './shop/ShopPage';

@Entry
@Component
struct Index {
  @Provide('pageStack') pageStack: NavPathStack = new NavPathStack();
  @State isShowSplash: boolean = true; // æ§åˆ¶å¯åŠ¨å±æ˜¾ç¤º

  @Builder
  PagesMap(name: string) {
    if ( name === 'Login' ) {
      Login()
    } else if ( name === 'MainTabs' ) {
      MainTabs();
    } else if ( name === 'ShopPage' ) {
      ShopPage()
    } else if ( name === 'ConfirmOrderPage' ) {
      ConfirmOrderView()
    } else if ( name === 'AddressEditPage' ) {
      AddressEditPage()
    } else if ( name === 'AddressMapPage' ) {
      AddressMapPage()
    } else if ( name === 'RemarkPage' ) {
      RemarkPage()
    } else if ( name === 'PaymentPage' ) {
      PaymentPage()
    } else if ( name === 'PaySuccessPage' ) {
      PaySuccessPage()
    } else if ( name === 'SettingsPage' ) {
      SettingsPage()
    } else if ( name === 'AddressBookPage' ) {
      AddressBookPage()
    } else if ( name === 'AddressEditRoutePage' ) {
      AddressEditRoutePage()
    } else if ( name === 'UserProfilePage' ) {
      UserProfilePage()
    } else if ( name === 'AccountSecurityPage' ) {
      AccountSecurityPage()
    } else if ( name === 'OrderHistoryPage' ) {
      OrderHistoryPage()
    } else if ( name === 'OrderDetailPage' ) {
      OrderDetailPage()
    } else if ( name === 'MyFollowPage' ) {
      MyFollowPage()
    } else if ( name === 'ChatPage' ) { // âœ¨ æ³¨å†ŒèŠå¤©é¡µ
      ChatPage()
    } else if ( name === 'SystemNotifyPage' ) { // âœ¨ æ³¨å†Œç³»ç»Ÿé€šçŸ¥é¡µ
      SystemNotifyPage()
    }
  }

  /**
   * åº”ç”¨åˆå§‹åŒ–
   */
  async initializeApp() {
    console.info('å–µï¼[Index] å¼€å§‹åˆå§‹åŒ–åº”ç”¨...');
    const uiContext = this.getUIContext();
    HttpUtil.setContext(uiContext);

    const context = uiContext.getHostContext() as common.UIAbilityContext;
    await PreferencesUtil.loadPreference(context);

    // ğŸ›’ åˆå§‹åŒ–è´­ç‰©è½¦æ•°æ®åº“å–µ
    const cartService: CartService = CartService.getInstance();
    await cartService.initRdb(context);

    // ä»æŒä¹…åŒ–å­˜å‚¨åŠ è½½ Token å’Œ UserId
    const persistentToken = await PreferencesUtil.getToken();
    const persistentUserId = await PreferencesUtil.getUserId();

    console.info(`å–µï¼[Index] è¯»å–æŒä¹…åŒ–æ•°æ®: Token=${ persistentToken ? 'Yes' : 'No' }, UserId=${ persistentUserId }`);

    if ( persistentToken && persistentToken.length > 0 ) {
      AppStorage.setOrCreate('token', persistentToken);
      AppStorage.setOrCreate('userId', persistentUserId);
    }

    this.checkLoginAndJump();
  }

  async checkLoginAndJump() {
    await new Promise<void>((r) => {
      setTimeout(r, 1000);
    });

    const token = AppStorage.get<string>('token');
    let targetName = 'Login';

    if ( token && token.length > 0 ) {
      console.info('å–µï¼[Index] æ­£åœ¨éªŒè¯ Token æœ‰æ•ˆæ€§...');
      try {
        await HttpUtil.get<string>('/client/type/list');

        const userId = AppStorage.get<number>('userId') || 0;
        console.info(`å–µï¼[Index] Tokenæœ‰æ•ˆï¼ŒUserId=${ userId }`);

        if ( userId > 0 ) {
          // âœ… 1. æ•°æ®å®Œæ•´ï¼Œè¿æ¥ WS
          WebSocketService.getInstance().connect(userId, '192.168.0.210:8080');

          // âœ… 2. è·å–å¹¶ç¼“å­˜ç”¨æˆ·ä¿¡æ¯ (ä¸»è¦æ˜¯å¤´åƒ)
          try {
            const userInfo = await AuthService.getUserInfo();
            if ( userInfo && userInfo.avatar ) {
              AppStorage.setOrCreate('userAvatar', userInfo.avatar);
              console.info('å–µï¼ç”¨æˆ·å¤´åƒå·²ç¼“å­˜:', userInfo.avatar);
            }
          } catch ( e ) {
            console.warn('å–µï¼è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ');
          }

          targetName = 'MainTabs';
        } else {
          console.warn('å–µï¼ï¼ï¼[Index] å‘ç°è„æ•°æ®ï¼šæœ‰Tokenä½†UserIdä¸º0ã€‚æ­£åœ¨æ¸…é™¤æ•°æ®...');
          await this.clearLoginData();
          targetName = 'Login';
        }

      } catch ( error ) {
        console.error('å–µï¼[Index] Tokenå¤±æ•ˆæˆ–ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œå‡†å¤‡å» Login:', error);
        await this.clearLoginData();
        targetName = 'Login';
      }
    } else {
      console.info('å–µï¼[Index] æ²¡æœ‰Tokenï¼Œç›´æ¥å» Login');
    }

    console.info(`å–µï¼[Index] æœ€ç»ˆè·³è½¬ç›®æ ‡: ${ targetName }`);
    this.pageStack.pushPath({ name: targetName }, false);
    this.isShowSplash = false;
  }

  async clearLoginData() {
    AppStorage.delete('token');
    AppStorage.delete('userId');
    await PreferencesUtil.deleteToken();
  }

  build() {
    Navigation(this.pageStack) {
      Stack() {
        Column() {
          Image($r('app.media.logo'))
            .width(100)
            .height(100)
            .objectFit(ImageFit.Contain)
            .margin({ bottom: 20 })

          Text('Meowå¤–å–')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
            .letterSpacing(4)

          Text('Powered by HarmonyOS')
            .fontSize(12)
            .fontColor('#999999')
            .margin({ top: 200 })
        }
        .justifyContent(FlexAlign.Center)
        .height('100%')
        .width('100%')
      }
      .backgroundColor('#FFFFFF')
      .onAppear(() => {
        this.initializeApp();
      })
    }
    .navDestination(this.PagesMap)
    .mode(NavigationMode.Stack)
    .hideTitleBar(true)
    .height('100%')
    .width('100%')
  }
}