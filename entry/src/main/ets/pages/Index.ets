import { common } from '@kit.AbilityKit';
import { HttpUtil } from '../common/utils/HttpUtil';
import { PreferencesUtil } from '../common/utils/PreferencesUtil';
import { Login } from './Login';
import { MainTabs } from './MainTabs';
import { ShopPage } from './shop/ShopPage';


@Entry
@Component
struct Index {
  @Provide('pageStack') pageStack: NavPathStack = new NavPathStack();
  @State isShowSplash: boolean = true; // æ§åˆ¶å¯åŠ¨å±æ˜¾ç¤º

  @Builder
  PagesMap(name: string) {
    if ( name === 'Login' ) {
      Login() // ç›´æ¥è°ƒç”¨ï¼ä¸è¦ä¸­é—´å•†èµšå·®ä»·ï¼
    } else if ( name === 'MainTabs' ) {
      MainTabs();
    } else if ( name === 'ShopPage' ) { // ğŸ‘ˆ æ–°å¢è¿™ä¸€è¡Œï¼
      ShopPage() // ç›´æ¥è°ƒç”¨ç»„ä»¶ï¼Œä¸éœ€è¦ Builder åŒ…è£…å‡½æ•°
    }
  }

  /**
   * åº”ç”¨åˆå§‹åŒ–
   */
  async initializeApp() {
    // 1. è·å–å¹¶è®¾ç½®UIä¸Šä¸‹æ–‡
    const uiContext = this.getUIContext();
    HttpUtil.setContext(uiContext);

    // 2. åˆå§‹åŒ–æŒä¹…åŒ–å­˜å‚¨å·¥å…· (å¿…é¡»ç­‰å¾…å®ƒå®Œæˆ)
    const context = uiContext.getHostContext() as common.UIAbilityContext;
    await PreferencesUtil.loadPreference(context);

    // 3. æ ¸å¿ƒï¼šä»æŒä¹…åŒ–å­˜å‚¨åŠ è½½Tokenåˆ°å†…å­˜(AppStorage)ï¼Œå®ç°çŠ¶æ€æ¢å¤
    const persistentToken = await PreferencesUtil.getToken();
    if ( persistentToken && persistentToken.length > 0 ) {
      AppStorage.setOrCreate('token', persistentToken);
      console.info('å–µï¼[Index] å·²ä»é¦–é€‰é¡¹åŠ è½½æŒä¹…åŒ–Tokenåˆ°AppStorageã€‚');
    } else {
      console.info('å–µï¼[Index] é¦–é€‰é¡¹ä¸­æ²¡æœ‰æ‰¾åˆ°Tokenã€‚');
    }

    // 4. åœ¨æ‰€æœ‰åˆå§‹åŒ–å®Œæˆåï¼Œå†æ£€æŸ¥ç™»å½•å¹¶è·³è½¬
    this.checkLoginAndJump();
  }

  async checkLoginAndJump() {
    // æ¨¡æ‹Ÿå¯åŠ¨å±å±•ç¤ºæ—¶é—´
    await new Promise<void>((r) => {
      setTimeout(r, 1000);
    });

    // HttpUtilçš„æ‹¦æˆªå™¨ä¼šè‡ªåŠ¨æºå¸¦AppStorageä¸­çš„token
    const token = AppStorage.get<string>('token'); // ç›´æ¥ä» AppStorage è¯»
    let targetName = 'Login'; // é»˜è®¤å»ç™»å½•é¡µ

    if ( token && token.length > 0 ) {
      console.info('å–µï¼[Index] æ£€æµ‹åˆ°å†…å­˜ä¸­å­˜åœ¨Tokenï¼Œæ­£åœ¨é€šè¿‡ HttpUtil éªŒè¯æœ‰æ•ˆæ€§...');
      try {
        // HttpUtil.get ä¼šè‡ªåŠ¨å¤„ç† base_url å’Œ token æ‹¦æˆªå™¨
        await HttpUtil.get<string>('/client/type/list');
        console.info('å–µï¼[Index] Tokenæœ‰æ•ˆï¼Œå‡†å¤‡å» MainTabs');
        targetName = 'MainTabs';
      } catch ( error ) {
        // æ•è·åˆ°é”™è¯¯ï¼Œè¯´æ˜ token å¤±æ•ˆ (NOT_LOGIN) æˆ–ç½‘ç»œå¼‚å¸¸
        console.error('å–µï¼[Index] TokenéªŒè¯å¤±è´¥æˆ–ç½‘ç»œå¼‚å¸¸ï¼Œå‡†å¤‡å» Loginã€‚é”™è¯¯:', error);
        targetName = 'Login';
        // æ¸…ç†ä¸€ä¸‹ AppStorage å’ŒæŒä¹…åŒ–å­˜å‚¨ä¸­å·²å¤±æ•ˆçš„ token
        AppStorage.delete('token');
        await PreferencesUtil.deleteToken();
        console.info('å–µï¼[Index] å·²æ¸…é™¤æ‰€æœ‰å¤±æ•ˆçš„Token');
      }
    } else {
      console.info('å–µï¼[Index] AppStorage ä¸­æ²¡æœ‰Tokenï¼Œå‡†å¤‡å» Login');
      targetName = 'Login';
    }


    // ğŸš€ æ‰§è¡Œè·³è½¬
    this.pageStack.pushPath({ name: targetName }, false);

    // ğŸ•µï¸â€â™€ï¸ æ¢é’ˆæ—¥å¿—ï¼šçœ‹çœ‹æ ˆé‡Œåˆ°åº•æœ‰æ²¡æœ‰ä¸œè¥¿ï¼Ÿ
    setTimeout(() => {
      const size = this.pageStack.size();
      console.info(`å–µï¼[Index] è·³è½¬æŒ‡ä»¤å·²å‘å‡ºã€‚å½“å‰è·¯ç”±æ ˆå¤§å°: ${ size }`);
      console.info(`å–µï¼[Index] æ ˆé¡¶é¡µé¢åå­—: ${ JSON.stringify(this.pageStack.getAllPathName()) }`);

      // å¦‚æœ size è¿˜æ˜¯ 0ï¼Œè¯´æ˜ router_map é…ç½®ç»å¯¹æœ‰é”™ï¼
      if ( size === 0 ) {
        console.error('å–µï¼ï¼ï¼è·³è½¬å¤±è´¥äº†ï¼ç³»ç»Ÿæ‰¾ä¸åˆ°åä¸º ' + targetName + ' çš„è·¯ç”±é…ç½®ï¼è¯·æ£€æŸ¥ router_map.jsonï¼');
      }
    }, 100);

    // å…³æ‰å¯åŠ¨å±ï¼ˆå¯é€‰ï¼Œå¦‚æœ pushPath æ²¡åŠ¨ç”»ï¼Œè¿™æ­¥å…¶å®ä¼šè¢«æ–°é¡µé¢è¦†ç›–ï¼‰
    this.isShowSplash = false;
  }

  build() {
    Navigation(this.pageStack) {

      // --- å¯åŠ¨å± UI (Splash) ---
      Stack() {
        Column() {
          Image($r('app.media.logo')) // æ‚¨çš„ Logo
            .width(100)
            .height(100)
            .objectFit(ImageFit.Contain)
            .margin({ bottom: 20 })

          Text('è‹ç©¹å¤–å–')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
            .letterSpacing(4)

          Text('Powered by HarmonyOS')
            .fontSize(12)
            .fontColor('#999999')
            .margin({ top: 200 })
        }
        .justifyContent(FlexAlign.Center)
        .height('100%')
        .width('100%')
      }
      .backgroundColor('#FFFFFF')
      .onAppear(() => {
        // åœ¨é¡µé¢å‡ºç°æ—¶ï¼Œå¼€å§‹æ‰§è¡Œåˆå§‹åŒ–æµç¨‹
        this.initializeApp();
      })
    }
    .navDestination(this.PagesMap)
    .mode(NavigationMode.Stack)
    .hideTitleBar(true)
    .height('100%')
    .width('100%')
  }
}