import { AuthService } from '../service/AuthService';
import { EmployeeLoginDTO } from '../model/EmployeeLoginModel';
import { promptAction } from '@kit.ArkUI';

@Component
export struct Login {
  @Consume('pageStack') pageStack: NavPathStack;
  @State username: string = ''; // ðŸ¾ å·²æ¸…ç©ºé»˜è®¤å€¼
  @State password: string = ''; // ðŸ¾ å·²æ¸…ç©ºé»˜è®¤å€¼
  @State isLoading: boolean = false;
  @State isLoginMode: boolean = false; // æŽ§åˆ¶æ˜¾ç¤ºæ¬¢è¿Žé¡µè¿˜æ˜¯ç™»å½•é¡µ

  build() {
    NavDestination() {
      Column() {
        // 1. Logo åŒºåŸŸ (å…±äº«)
        Image($r('app.media.app_logo'))
          .width(100)
          .height(100)
          .margin({ top: 100, bottom: 20 })
          .objectFit(ImageFit.Contain)

        Text('Meowå¤–å– Â· å•†å®¶ç‰ˆ')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.text_main'))
          .margin({ bottom: 50 })

        if (this.isLoginMode) {
          // === ç™»å½•æ¨¡å¼ ===
          Column({ space: 15 }) {
            TextInput({ placeholder: 'è¯·è¾“å…¥è´¦å·', text: this.username })
              .height(50)
              .backgroundColor(Color.White)
              .borderRadius(8)
              .onChange((value) => {
                this.username = value;
              })

            TextInput({ placeholder: 'è¯·è¾“å…¥å¯†ç ', text: this.password })
              .type(InputType.Password)
              .height(50)
              .backgroundColor(Color.White)
              .borderRadius(8)
              .onChange((value) => {
                this.password = value;
              })
          }
          .width('80%')

          Button(this.isLoading ? 'ç™»å½•ä¸­...' : 'ç™» å½•')
            .width('80%')
            .height(45)
            .backgroundColor($r('app.color.theme_color'))
            .fontColor(Color.Black)
            .fontSize(18)
            .margin({ top: 40 })
            .enabled(!this.isLoading)
            .onClick(async () => {
              if (this.username === '' || this.password === '') {
                promptAction.showToast({ message: 'è´¦å·æˆ–å¯†ç ä¸èƒ½ä¸ºç©ºå–µï¼' });
                return;
              }

              this.isLoading = true;
              try {
                const dto = new EmployeeLoginDTO(this.username, this.password);
                await AuthService.login(dto);
                promptAction.showToast({ message: 'ç™»å½•æˆåŠŸå–µï¼' });
                this.pageStack.clear();
                this.pageStack.pushPath({ name: 'MainTabs' });
              } catch (err) {
              } finally {
                this.isLoading = false;
              }
            })
            
          Text('è¿”å›žé€‰æ‹©')
            .fontSize(14)
            .fontColor($r('app.color.text_secondary'))
            .margin({ top: 20 })
            .onClick(() => {
              this.isLoginMode = false;
            })

        } else {
          // === æ¬¢è¿Žæ¨¡å¼ ===
          Column({ space: 20 }) {
            Button('å·²ç»å…¥é©»ï¼ŸåŽ»ç™»å½•')
              .width('80%')
              .height(50)
              .backgroundColor($r('app.color.theme_color'))
              .fontColor(Color.Black)
              .fontSize(18)
              .onClick(() => {
                this.isLoginMode = true;
              })

            Button('æˆ‘è¦å…¥é©» Meow')
              .width('80%')
              .height(50)
              .backgroundColor(Color.White)
              .fontColor($r('app.color.theme_color'))
              .border({ width: 1, color: $r('app.color.theme_color') })
              .fontSize(18)
              .onClick(() => {
                this.pageStack.pushPath({ name: 'RegisterPage' });
              })
          }
          .width('100%')
          .margin({ top: 20 })
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor($r('app.color.page_background'))
    }
    .hideTitleBar(true)
  }
}
