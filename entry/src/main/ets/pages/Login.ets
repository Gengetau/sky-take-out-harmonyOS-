import { promptAction } from '@kit.ArkUI';
import { UserLoginDTO } from '../model/entity/LoginModel';
import { AuthService } from '../service/AuthService';

@Builder
export function LoginBuilder(): void {
  Login()
    .onAppear(() => { // ðŸ‘ˆ æŠŠæ—¥å¿—è—åœ¨è¿™é‡Œï¼
      console.info('å–µï¼LoginBuilder æˆåŠŸæ‰§è¡Œï¼ŒLogin ç»„ä»¶å·²æŒ‚è½½ï¼');
    });
}

/**
 * ç™»é™†é¡µé¢
 */
@Component
struct Login {
  @Consume('pageStack') pageStack: NavPathStack; //  æŽ¥æ”¶è·¯ç”±æ ˆï¼Œä»¥ä¾¿è·³è½¬
  @State phone: string = '';
  @State code: string = '';
  @State countDown: number = 0;
  private timer: number = -1;
  @State isLoading: boolean = false; //ç™»é™†åŠ è½½çŠ¶æ€

  // â±ï¸ å€’è®¡æ—¶é€»è¾‘
  startCountDown() {
    this.countDown = 60;
    this.timer = setInterval(() => {
      this.countDown--;
      if ( this.countDown <= 0 ) {
        clearInterval(this.timer);
      }
    }, 1000);
  }

  // ðŸ“¨ å‘é€éªŒè¯ç é€»è¾‘
  async handleSendCode() {
    if ( this.phone.length !== 11 ) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥11ä½æ‰‹æœºå·å–µï¼' });
      return;
    }

    // 1. å¼€å§‹å€’è®¡æ—¶
    this.startCountDown();

    // 2. è°ƒç”¨ Service å‘é€
    const verifyCode = await AuthService.sendVerifyCode(this.phone);

    if ( verifyCode ) {
      // ðŸŽ­ 3. æ¨¡æ‹ŸçŸ­ä¿¡å¼¹çª— (è¿™ä¼šè®©ä½“éªŒè¶…çº§æ£’ï¼)
      // å»¶è¿Ÿä¸€ç‚¹ç‚¹ï¼Œæ¨¡æ‹Ÿç½‘ç»œä¼ è¾“
      setTimeout(() => {
        promptAction.showDialog({
          title: 'ðŸ“¨ æ–°æ¶ˆæ¯',
          message: `ã€Meowå¤–å–ã€‘æ‚¨çš„éªŒè¯ç æ˜¯ï¼š${ verifyCode }ã€‚æ‚¨æ­£åœ¨ç™»å½•ï¼Œè‹¥éžæœ¬äººæ“ä½œè¯·å¿½ç•¥ã€‚`,
          buttons: [
            { text: 'å…³é—­', color: '#999999' },
            { text: 'è‡ªåŠ¨å¡«å†™', color: '#0D9FFB' }// è´´å¿ƒçš„åŠŸèƒ½
          ]
        }).then((res) => {
          if ( res.index === 1 ) {
            this.code = verifyCode; // è‡ªåŠ¨å›žå¡«
          }
        });
      }, 500);
    } else {
      // å‘é€å¤±è´¥ï¼Œé‡ç½®å€’è®¡æ—¶
      clearInterval(this.timer);
      this.countDown = 0;
    }
  }

  // ðŸ” ç™»å½•é€»è¾‘
  async handleLogin() {
    if (!this.phone || !this.code ) {
      promptAction.showToast({ message: 'è¯·å¡«å†™å®Œæ•´å–µï¼' });
      return;
    }

    this.isLoading = true;

    // 1. ç»„è£… DTO
    const dto = new UserLoginDTO(this.phone, this.code);

    // 2. è°ƒç”¨ç™»å½•
    const success = await AuthService.login(dto);

    console.info("æ˜¯å¦ç™»å½•æˆåŠŸ:", { success })

    this.isLoading = false;

    if ( success ) {
      promptAction.showToast({ message: 'ç™»å½•æˆåŠŸï¼Œå‡†å¤‡ç‚¹é¤ï¼ðŸ”' });
      // 3. è·³è½¬ä¸»é¡µ
      this.pageStack.replacePath({ name: 'MainTabs' }, true);
    }
  }

  build() {
    NavDestination() {
      Column() {
        // logoå±•ç¤º
        Column({ space: 15 }) {
          Image($r('app.media.logo'))
            .height(150)
            .width('80%')
            .objectFit(ImageFit.Contain)
          Text($r('app.string.slogan'))
            .fontSize(27)
            .fontColor('#333333')
            .fontStyle(FontStyle.Italic)
        }
        .margin({ bottom: 50 })

        // è¾“å…¥åŒºåŸŸ
        Column({ space: 15 }) {
          TextInput({ placeholder: 'æ‰‹æœºå·' })
            .height(50)
            .type(InputType.PhoneNumber)
            .backgroundColor(Color.White)
            .onChange((val) => {
              this.phone = val;
            })
          Row() {
            TextInput({ placeholder: 'éªŒè¯ç ', text: this.code })
              .height(50)
              .type(InputType.Number)
              .backgroundColor(Color.White)
              .width('70%')
              .onChange((val) => {
                this.code = val;
              })
            Button(this.countDown > 0 ? `${ this.countDown }s` : 'å‘é€éªŒè¯ç ')
              .fontSize(12)
              .type(ButtonType.Capsule)
              // ðŸ’¡ ä½“éªŒä¼˜åŒ–ï¼šå€’è®¡æ—¶æœŸé—´ç¦ç”¨æŒ‰é’®ï¼Œé¢œè‰²å˜ç°
              .backgroundColor(this.countDown > 0 ? '#CCCCCC' : '#0D9FFB')
              .enabled(this.countDown === 0) // åªæœ‰å€’è®¡æ—¶ä¸º 0 æ—¶æ‰èƒ½ç‚¹
              .onClick(() => {
                this.handleSendCode();
              })
          }
          .justifyContent(FlexAlign.SpaceBetween)
          .width('100%')
        }
        .width('95%')

        // ç™»å½•æŒ‰é’®
        Row() {
          Button() {
            Row() {
              if ( this.isLoading ) {
                LoadingProgress().width(20).height(20).color(Color.White).margin({ right: 5 })
              }
              Text(this.isLoading ? 'ç™» å½• ä¸­...' : 'ç™» å½•')
                .fontColor(Color.White)
                .fontSize(18)
            }
          }
          .type(ButtonType.Capsule)
          .width('80%')
          .height(50)
          .backgroundColor('#ffcc00') // è‹ç©¹å¤–å–çš„ä¸»é¢˜é»„
          .onClick(() => {
            this.handleLogin() // è°ƒç”¨ä¸‹é¢çš„é€»è¾‘
          })
          // åŠ è½½ä¸­ç¦æ­¢ç‚¹å‡»
          .enabled(!this.isLoading)
        }
        .margin({ top: 50 })

        Blank()
          .layoutWeight(1)

        Row() {
          Text('å…¶ä»–æ–¹å¼ç™»å½•')
            .fontSize(16)
            .fontColor('#999999')
            .margin({ bottom: 10 })
        }

        Row() {
          this.ThirdPartyIcon($r('app.media.wechat'))
          this.ThirdPartyIcon($r('app.media.qq'))
          this.ThirdPartyIcon($r('app.media.alipay'))
        }
        .justifyContent(FlexAlign.SpaceEvenly)
        .width('100%')
        .margin({ bottom: 30 }) // ç¦»åº•éƒ¨æœ‰ç‚¹è·ç¦»
      }
      .width('100%')
      .height('100%')
      .backgroundColor("#f5f5f5") // èƒŒæ™¯è‰²ç¨å¾®æ·¡ä¸€ç‚¹ï¼Œçœ¼ç›èˆ’æœå–µ
    }
    .hideTitleBar(true)
  }

  @Builder
  ThirdPartyIcon(icon: Resource) {
    Button() {
      Image(icon).width(40).height(40).objectFit(ImageFit.Contain)
    }
    .type(ButtonType.Circle)
    .width(50)
    .height(50)
    .backgroundColor(Color.White) // ç»™ä¸ªç™½è‰²åº•ï¼Œå›¾æ ‡æ›´æ¸…æ™°
    .onClick(() => {
      promptAction.showToast({ message: 'æš‚æœªå¼€æ”¾' })
    })
  }
}

export { Login };
