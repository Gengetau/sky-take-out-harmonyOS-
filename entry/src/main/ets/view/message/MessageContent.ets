import { SessionModel } from '../../model/MessageModel';
import { MessageRdb } from '../../common/MessageRdb';
import { ChatPageParam } from '../../pages/message/ChatPage';

@Component
export struct MessageContent {
  @Consume('pageStack') pageStack: NavPathStack;
  @State sessionList: SessionModel[] = [];
  @StorageLink('NewMessageSignal') @Watch('onMessageSignal') signal: number = 0;

  async aboutToAppear() {
    this.refreshList();
  }

  // ç›‘å¬åˆ°æ–°æ¶ˆæ¯ä¿¡å·ï¼Œåˆ·æ–°åˆ—è¡¨å–µ
  async onMessageSignal() {
    console.info('å–µï¼æ”¶åˆ°æ–°æ¶ˆæ¯ä¿¡å·ï¼Œåˆ·æ–°ä¼šè¯åˆ—è¡¨ ğŸ”„');
    this.refreshList();
  }

  async refreshList() {
    this.sessionList = await MessageRdb.getSessionList();
  }

  // æ ¼å¼åŒ–æ—¶é—´æˆ³
  formatTime(timestamp: number): string {
    const date = new Date(timestamp);
    const now = new Date();
    // ç®€å•å¤„ç†ï¼šå¦‚æœæ˜¯ä»Šå¤©æ˜¾ç¤º HH:mmï¼Œå¦åˆ™æ˜¾ç¤º MM-dd
    if (date.getDate() === now.getDate() && date.getMonth() === now.getMonth()) {
      return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
    }
    return `${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
  }

  // ä¾§æ»‘åˆ é™¤æŒ‰é’®
  @Builder itemEnd(sessionId: string) {
    Row() {
      Button("åˆ é™¤")
        .type(ButtonType.Normal)
        .backgroundColor(Color.Red)
        .fontColor(Color.White)
        .height('100%')
        .width(80)
        .onClick(async () => {
          await MessageRdb.deleteSession(sessionId);
          this.refreshList();
        })
    }
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('æ¶ˆæ¯ä¸­å¿ƒ')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.text_main'))
      }
      .width('100%')
      .padding({ left: 16, top: 16, bottom: 16 })
      .backgroundColor(Color.White)

      // åˆ—è¡¨å†…å®¹
      if (this.sessionList.length === 0) {
        Column() {
          Image($r('app.media.startIcon')) // æš‚æ—¶ç”¨å¯åŠ¨å›¾æ ‡
            .width(80)
            .height(80)
            .opacity(0.3)
            .grayscale(1)
          Text('æš‚æ— æ¶ˆæ¯å–µ~')
            .fontSize(16)
            .fontColor($r('app.color.text_secondary'))
            .margin({ top: 15 })
        }
        .width('100%').layoutWeight(1).justifyContent(FlexAlign.Center)
      } else {
        List() {
          ForEach(this.sessionList, (item: SessionModel) => {
            ListItem() {
              Row() {
                // å¤´åƒå¤„ç†å–µ
                if (item.sessionId === 'system_notify') {
                  // ç³»ç»Ÿé€šçŸ¥ç»Ÿä¸€ç”¨ App Logo å–µ
                  Image($r('app.media.app_logo'))
                    .width(50).height(50)
                    .borderRadius(25)
                    .margin({ right: 12 })
                    .objectFit(ImageFit.Cover)
                    .backgroundColor('#F0F0F0')
                } else if (typeof item.avatar === 'string' && item.avatar.length > 0) {
                  // ç§èŠç”¨ç”¨æˆ·å¤´åƒå–µ
                  Image(item.avatar)
                    .width(50).height(50)
                    .borderRadius(25)
                    .margin({ right: 12 })
                    .objectFit(ImageFit.Cover)
                    .backgroundColor('#F0F0F0')
                } else {
                  // é»˜è®¤å¤´åƒå–µ
                  Image($r('app.media.startIcon'))
                    .width(50).height(50)
                    .borderRadius(25)
                    .margin({ right: 12 })
                    .objectFit(ImageFit.Cover)
                    .backgroundColor('#F0F0F0')
                }
                
                // å†…å®¹åŒºåŸŸ
                Column() {
                  Row() {
                    // æ ‡é¢˜
                    Text(item.title)
                      .fontSize(16)
                      .fontWeight(FontWeight.Medium)
                      .fontColor($r('app.color.text_main'))
                      .layoutWeight(1)
                    // æ—¶é—´
                    Text(this.formatTime(item.lastTime))
                      .fontSize(12)
                      .fontColor($r('app.color.text_secondary'))
                  }
                  .width('100%')
                  
                  Row() {
                    // æ¶ˆæ¯é¢„è§ˆ
                    Text(item.lastMsg)
                      .fontSize(14)
                      .fontColor($r('app.color.text_secondary'))
                      .maxLines(1)
                      .textOverflow({ overflow: TextOverflow.Ellipsis })
                      .layoutWeight(1)
                      .margin({ top: 4 })
                    
                    // æœªè¯»çº¢ç‚¹
                    if (item.unreadCount > 0) {
                      Text(item.unreadCount > 99 ? '99+' : item.unreadCount.toString())
                        .fontSize(10)
                        .fontColor(Color.White)
                        .backgroundColor(Color.Red)
                        .borderRadius(10)
                        .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                        .margin({ left: 8 })
                    }
                  }
                  .width('100%')
                }
                .layoutWeight(1)
              }
              .width('100%')
              .padding({ left: 16, right: 16, top: 12, bottom: 12 })
              .backgroundColor(Color.White)
              .onClick(() => {
                // è·³è½¬åˆ°èŠå¤©è¯¦æƒ…é¡µå–µ
                const avatarStr = typeof item.avatar === 'string' ? item.avatar : '';
                const params = new ChatPageParam(item.sessionId, item.title, avatarStr);
                this.pageStack.pushPath({ name: 'ChatPage', param: params });
              })
            }
            .swipeAction({ end: this.itemEnd(item.sessionId) }) // ç»‘å®šä¾§æ»‘åˆ é™¤
          })
        }
        .width('100%')
        .layoutWeight(1)
        .divider({ strokeWidth: 0.5, color: '#EEEEEE', startMargin: 78, endMargin: 0 }) // åˆ—è¡¨åˆ†å‰²çº¿
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}
