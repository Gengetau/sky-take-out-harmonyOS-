import { promptAction } from '@kit.ArkUI';
import { ShopInfoVO } from '../../model/ShopModel';
import { ShopService } from '../../service/ShopService';

@Component
export struct ManageContent {
  @Consume('pageStack') pageStack: NavPathStack;
  @State shopStatus: number = 0; // 1:è¥ä¸šä¸­, 0:æ‰“çƒŠä¸­
  @State shopInfo: ShopInfoVO | null = null;
  @State isLoading: boolean = true;

  aboutToAppear() {
    this.loadShopInfo();
  }

  async loadShopInfo() {
    this.isLoading = true;
    try {
      this.shopInfo = await ShopService.getShopInfo();
      if ( this.shopInfo ) {
        this.shopStatus = this.shopInfo.status;
      }
    } catch ( e ) {
      // é”™è¯¯å·²å¤„ç†
    } finally {
      this.isLoading = false;
    }
  }

  async updateStatus(targetStatus: number) {
    // ðŸ›‘ å…³é”®é˜²çº¿ï¼šå¦‚æžœç›®æ ‡çŠ¶æ€å’Œå½“å‰ä¸€è‡´ï¼Œè¯´æ˜Žæ˜¯æ•°æ®åŠ è½½å¼•èµ·çš„å˜æ›´ï¼Œæˆ–è€…æ˜¯é‡å¤ç‚¹å‡»ï¼Œç›´æŽ¥å¿½ç•¥ï¼
    if (targetStatus === this.shopStatus) return;

    // ðŸ›‘ å¼¹çª—ç¡®è®¤
    const isOpening = targetStatus === 1;
    AlertDialog.show({
      title: isOpening ? 'å¼€å§‹è¥ä¸š' : 'æš‚åœè¥ä¸š',
      message: isOpening ? 'ç¡®è®¤è¦å¼€å§‹è¥ä¸šå—ï¼Ÿæ–°çš„ä¸€å¤©è¦å¼€å§‹æŽ¥å•å•¦å–µï¼' : 'ç¡®è®¤è¦å…³é—­åº—é“ºå—ï¼Ÿæ‰“çƒŠåŽé¡¾å®¢å°†æ— æ³•ä¸‹å•å–µã€‚',
      primaryButton: {
        value: 'å–æ¶ˆ',
        action: () => {
          // å–æ¶ˆæ“ä½œï¼Œéœ€è¦æŠŠ Toggle çš„çŠ¶æ€åœ¨ UI ä¸Šæ”¹å›žåŽ» (å› ä¸º Toggle ç‚¹å‡»åŽè§†è§‰ä¸Šå·²ç»å˜äº†)
          // é€šè¿‡é‡æ–°èµ‹å€¼è§¦å‘çŠ¶æ€åˆ·æ–°
          const originalStatus = this.shopStatus;
          this.shopStatus = -1; // å…ˆæ”¹æˆä¸€ä¸ªæ— æ•ˆå€¼
          setTimeout(() => {
            this.shopStatus = originalStatus; // å†æ”¹å›žæ¥ï¼Œå¼ºåˆ¶ UI åˆ·æ–°
          }, 10);
        }
      },
      secondaryButton: {
        value: 'ç¡®è®¤',
        fontColor: isOpening ? $r('app.color.theme_color') : Color.Red,
        action: async () => {
          try {
            await ShopService.setStatus(targetStatus);
            this.shopStatus = targetStatus;
            promptAction.showToast({ message: targetStatus === 1 ? 'åº—é“ºå·²å¼€å§‹è¥ä¸šå–µï¼' : 'åº—é“ºå·²æ‰“çƒŠå–µ~' });
          } catch (e) {
            this.loadShopInfo(); 
          }
        }
      }
    });
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜
      Row() {
        Text('åº—é“ºç®¡ç†')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.text_main'))
      }
      .width('100%')
      .padding(20)
      .backgroundColor(Color.White)

      // è¥ä¸šçŠ¶æ€å¡ç‰‡
      Column() {
        Row() {
          Image(this.shopInfo?.avatar || $r('app.media.app_logo'))
            .width(50)
            .height(50)
            .borderRadius(25) // åœ†å½¢å¤´åƒ
            .margin({ right: 15 })

          Column() {
            Text(this.shopInfo?.name || 'æˆ‘çš„åº—é“º')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_main'))
              .margin({ bottom: 4 })
            Text(this.shopStatus === 1 ? 'è¥ä¸šä¸­ Â· é¡¾å®¢å¯ä¸‹å•' : 'æ‰“çƒŠä¸­ Â· æš‚åœæŽ¥å•')
              .fontSize(14)
              .fontColor(this.shopStatus === 1 ? '#4CAF50' : $r('app.color.text_secondary')) // è¥ä¸šç»¿è‰²ï¼Œæ‰“çƒŠç°è‰²
          }
          .alignItems(HorizontalAlign.Start)
          .layoutWeight(1)

          Toggle({ type: ToggleType.Switch, isOn: this.shopStatus === 1 })
            .selectedColor($r('app.color.theme_color'))
            .onChange((isOn: boolean) => {
              this.updateStatus(isOn ? 1 : 0);
            })
        }
        .width('100%')
        .padding(20)
        .backgroundColor(Color.White)
        .borderRadius(12)
      }
      .padding({ left: 15, right: 15, top: 10 })

            // å…¶ä»–åŠŸèƒ½èœå• (å ä½)

            List() {

              ListItem() {

                this.MenuItem('èœå“ç®¡ç†', 'ç®¡ç†æ‚¨çš„ç¾Žå‘³ä½³è‚´', 'DishManagePage')

              }

              ListItem() {

                this.MenuItem('å¥—é¤ç®¡ç†', 'ç»„åˆä¼˜æƒ æ›´å¥½å–å–µ', 'SetmealManagePage')

              }

              ListItem() {

                this.MenuItem('åˆ†ç±»ç®¡ç†', 'è®©èœå•äº•äº•æœ‰æ¡', 'CategoryManagePage')

              }

            }
      .margin({ top: 20 })
      .padding({ left: 15, right: 15 })
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.page_background'))
  }

    @Builder
    MenuItem(title: string, subTitle: string, targetPage: string) {
      Row() {
        Column() {
          Text(title).fontSize(16).fontColor($r('app.color.text_main')).fontWeight(FontWeight.Medium)
          Text(subTitle).fontSize(12).fontColor($r('app.color.text_secondary')).margin({ top: 2 })
        }.alignItems(HorizontalAlign.Start)
        
        Blank()
        
        Image($r('app.media.startIcon')) // è¿™é‡Œç”¨å‰è¿›ç®­å¤´å›¾æ ‡å–µ
          .width(16)
          .height(16)
          .opacity(0.3)
      }
      .width('100%')
      .padding(15)
      .backgroundColor(Color.White)
      .borderRadius(8)
      .margin({ bottom: 10 })
      .onClick(() => {
        this.pageStack.pushPath({ name: targetPage });
      })
    }}
