import { AuthService } from '../../service/AuthService';
import { EmployeeLoginVO } from '../../model/EmployeeLoginModel';
import { PreferencesUtil } from '../../common/PreferencesUtil';
import { promptAction } from '@kit.ArkUI';
import { ShopInfoVO } from '../../model/ShopModel';

@Component
export struct MineContent {
  @Consume('pageStack') pageStack: NavPathStack;
  @State employeeInfo: EmployeeLoginVO | null = null;
  @StorageLink('shopInfo') shopInfo: ShopInfoVO | null = null;

  async aboutToAppear() {
    this.employeeInfo = AppStorage.get<EmployeeLoginVO>('employeeInfo') || null;
  }

  async handleLogout() {
    try {
      await AuthService.logout();
      promptAction.showToast({ message: 'å·²é€€å‡ºç™»å½•å–µï¼' });
      this.pageStack.clear();
      this.pageStack.pushPath({ name: 'Login' });
    } catch (e) {
      promptAction.showToast({ message: 'é€€å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•å–µ' });
    }
  }

  build() {
    Column() {
      // 1. å¤´éƒ¨èƒŒæ™¯
      Column() {
        Row() {
          // ä¼˜å…ˆæ˜¾ç¤ºåº—é“ºLogoï¼Œå¦åˆ™æ˜¾ç¤ºå¯åŠ¨å›¾æ ‡å–µ
          Image(this.shopInfo?.avatar || $r('app.media.startIcon'))
            .width(60)
            .height(60)
            .borderRadius(30)
            .margin({ right: 15 })
            .backgroundColor(Color.White)
            .objectFit(ImageFit.Cover)
            .padding(2)
          
          Column() {
            Text(this.employeeInfo?.name || 'å•†å®¶å‘˜å·¥')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333333')
            Text(this.shopInfo?.name || 'æœªç»‘å®šåº—é“º')
              .fontSize(14)
              .fontColor('#666666')
              .margin({ top: 5 })
          }
          .alignItems(HorizontalAlign.Start)
        }
        .width('100%')
        .padding({ top: 60, bottom: 40, left: 20, right: 20 })
      }
      .width('100%')
      .backgroundColor($r('app.color.theme_color')) 
      
      // 2. èœå•åˆ—è¡¨
      List() {
        // âœ¨ æ–°å¢žåº—é“ºè®¾ç½®å…¥å£
        ListItem() {
          this.MenuItem('åº—é“ºè®¾ç½®', this.shopInfo?.status === 1 ? 'è¥ä¸šä¸­' : 'å·²æ‰“çƒŠ', () => {
            this.pageStack.pushPath({ name: 'ShopInfoPage' });
          })
        }

        ListItem() {
          this.MenuItem('è´¦å·è®¾ç½®', 'ä¿®æ”¹å¯†ç ç­‰', () => {
            promptAction.showToast({ message: 'åŠŸèƒ½å»ºè®¾ä¸­å–µ~' });
          })
        }
        
        ListItem() {
          this.MenuItem('å…³äºŽæˆ‘ä»¬', 'ç‰ˆæœ¬ v1.0.0', () => {
            promptAction.showToast({ message: 'å¦®å¨…ä¸€ç›´åœ¨é™ªç€æ‚¨å–µï¼ðŸ¾' });
          })
        }
        
        ListItem() {
          Button('é€€å‡ºç™»å½•')
            .width('100%')
            .height(50)
            .backgroundColor(Color.White)
            .fontColor(Color.Red)
            .fontSize(16)
            .margin({ top: 30 })
            .onClick(() => {
              AlertDialog.show({
                title: 'æç¤º',
                message: 'ç¡®å®šè¦é€€å‡ºç™»å½•å—å–µï¼Ÿ',
                primaryButton: { value: 'å–æ¶ˆ', action: () => {} },
                secondaryButton: {
                  value: 'é€€å‡º',
                  fontColor: Color.Red,
                  action: () => { this.handleLogout(); }
                }
              })
            })
        }
      }
      .width('100%')
      .layoutWeight(1)
      .padding(15)
      .margin({ top: -20 }) 
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.page_background'))
  }

  @Builder
  MenuItem(title: string, subTitle: string, onClick: () => void) {
    Row() {
      Text(title).fontSize(16).fontColor($r('app.color.text_main'))
      Blank()
      Text(subTitle).fontSize(12).fontColor($r('app.color.text_secondary')).margin({ right: 10 })
      Image($r('app.media.startIcon')) // ç®­å¤´
        .width(16)
        .height(16)
        .opacity(0.3)
    }
    .width('100%')
    .height(55)
    .padding({ left: 15, right: 15 })
    .backgroundColor(Color.White)
    .borderRadius(8)
    .margin({ bottom: 10 })
    .onClick(onClick)
  }
}