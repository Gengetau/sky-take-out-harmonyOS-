/**
 * ç”¨æˆ·é¦–é€‰é¡¹å·¥å…·
 */
import { preferences } from '@kit.ArkData';
import { Context } from '@kit.AbilityKit';
import { BusinessError } from '@kit.BasicServicesKit';

/**
 * ğŸ‘œ å…¨å±€ç”¨æˆ·é¦–é€‰é¡¹å·¥å…·ç±» (å•ä¾‹æ¨¡å¼)
 */
export class PreferencesUtil {
  // 1. å®šä¹‰é™æ€å˜é‡ï¼ŒæŒæœ‰ preferences å®ä¾‹
  private static pref: preferences.Preferences | null = null;

  // å®šä¹‰æ•°æ®åº“çš„åå­— (ç±»ä¼¼äºé’±åŒ…çš„åå­—)
  private static readonly STORE_NAME: string = 'SkyTakeout_Pref';
  // å®šä¹‰ Token çš„ Key
  private static readonly KEY_TOKEN: string = 'user_token';
  private static readonly KEY_USER_ID: string = 'user_id';

  /**
   * ğŸš€ åˆå§‹åŒ–æ–¹æ³• (å¿…é¡»åœ¨ EntryAbility é‡Œè°ƒç”¨ä¸€æ¬¡)
   */
  static async loadPreference(context: Context) {
    try {
      // è·å–å®ä¾‹
      PreferencesUtil.pref = await preferences.getPreferences(context, PreferencesUtil.STORE_NAME);
      console.info('[PreferencesUtil] é’±åŒ…åˆå§‹åŒ–æˆåŠŸå–µï¼');
    } catch (err) {
      let e = err as BusinessError;
      console.error(`[PreferencesUtil] åˆå§‹åŒ–å¤±è´¥: ${e.code}, ${e.message}`);
    }
  }

  /**
   * ğŸ’¾ ä¿å­˜ Token
   */
  static async saveToken(token: string) {
    if (!PreferencesUtil.pref) return;
    try {
      await PreferencesUtil.pref.put(PreferencesUtil.KEY_TOKEN, token);
      await PreferencesUtil.pref.flush();
      console.info('[PreferencesUtil] Token ä¿å­˜æˆåŠŸå–µï¼');
    } catch (err) {
      console.error('[PreferencesUtil] ä¿å­˜ Token å¤±è´¥å–µ');
    }
  }

  /**
   * ğŸ’¾ ä¿å­˜ç”¨æˆ·ID
   */
  static async saveUserId(userId: number) {
    if (!PreferencesUtil.pref) return;
    try {
      await PreferencesUtil.pref.put(PreferencesUtil.KEY_USER_ID, userId);
      await PreferencesUtil.pref.flush();
      console.info('[PreferencesUtil] UserId ä¿å­˜æˆåŠŸå–µï¼');
    } catch (err) {
      console.error('[PreferencesUtil] ä¿å­˜ UserId å¤±è´¥å–µ');
    }
  }

  /**
   * ğŸ” è·å– Token
   */
  static async getToken(): Promise<string> {
    if (!PreferencesUtil.pref) return '';
    try {
      const token = await PreferencesUtil.pref.get(PreferencesUtil.KEY_TOKEN, '');
      return token as string;
    } catch (err) {
      return '';
    }
  }

  /**
   * ğŸ” è·å–ç”¨æˆ·ID
   */
  static async getUserId(): Promise<number> {
    if (!PreferencesUtil.pref) return 0;
    try {
      const userId = await PreferencesUtil.pref.get(PreferencesUtil.KEY_USER_ID, 0);
      return userId as number;
    } catch (err) {
      return 0;
    }
  }

  /**
   * ğŸ—‘ï¸ åˆ é™¤ Token å’Œ UserID
   */
  static async deleteToken() {
    if (!PreferencesUtil.pref) return;
    try {
      await PreferencesUtil.pref.delete(PreferencesUtil.KEY_TOKEN);
      await PreferencesUtil.pref.delete(PreferencesUtil.KEY_USER_ID);
      await PreferencesUtil.pref.flush();
      console.info('[PreferencesUtil] ç™»å½•æ•°æ®å·²é”€æ¯å–µï¼');
    } catch (err) {
      console.error('[PreferencesUtil] åˆ é™¤æ•°æ®å¤±è´¥å–µ');
    }
  }
}
