/**
 * ç”¨æˆ·é¦–é€‰é¡¹å·¥å…·
 */
import { preferences } from '@kit.ArkData';
import { Context } from '@kit.AbilityKit';
import { BusinessError } from '@kit.BasicServicesKit';

/**
 * ğŸ‘œ å…¨å±€ç”¨æˆ·é¦–é€‰é¡¹å·¥å…·ç±» (å•ä¾‹æ¨¡å¼)
 */
export class PreferencesUtil {
  // 1. å®šä¹‰é™æ€å˜é‡ï¼ŒæŒæœ‰ preferences å®ä¾‹
  private static pref: preferences.Preferences | null = null;

  // å®šä¹‰æ•°æ®åº“çš„åå­— (ç±»ä¼¼äºé’±åŒ…çš„åå­—)
  private static readonly STORE_NAME: string = 'SkyTakeout_Pref';
  // å®šä¹‰ Token çš„ Key
  private static readonly KEY_TOKEN: string = 'user_token';

  /**
   * ğŸš€ åˆå§‹åŒ–æ–¹æ³• (å¿…é¡»åœ¨ EntryAbility é‡Œè°ƒç”¨ä¸€æ¬¡)
   */
  static async loadPreference(context: Context) {
    try {
      // è·å–å®ä¾‹
      PreferencesUtil.pref = await preferences.getPreferences(context, PreferencesUtil.STORE_NAME);
      console.info('[PreferencesUtil] é’±åŒ…åˆå§‹åŒ–æˆåŠŸå–µï¼');
    } catch (err) {
      let e = err as BusinessError;
      console.error(`[PreferencesUtil] åˆå§‹åŒ–å¤±è´¥: ${e.code}, ${e.message}`);
    }
  }

  /**
   * ğŸ’¾ ä¿å­˜ Token
   */
  static async saveToken(token: string) {
    if (!PreferencesUtil.pref) return;
    try {
      // 1. å†™å…¥å†…å­˜
      await PreferencesUtil.pref.put(PreferencesUtil.KEY_TOKEN, token);
      // 2. åˆ·å…¥ç£ç›˜ (è¿™ä¸€æ­¥åƒä¸‡ä¸èƒ½å¿˜ï¼å¦åˆ™æ€åå°å°±ä¸¢äº†)
      await PreferencesUtil.pref.flush();
      console.info('[PreferencesUtil] Token ä¿å­˜æˆåŠŸå–µï¼');
    } catch (err) {
      console.error('[PreferencesUtil] ä¿å­˜ Token å¤±è´¥å–µ');
    }
  }

  /**
   * ğŸ” è·å– Token
   * @returns token å­—ç¬¦ä¸²ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›ç©ºå­—ç¬¦ä¸² ''
   */
  static async getToken(): Promise<string> {
    if (!PreferencesUtil.pref) return '';
    try {
      // get çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯é»˜è®¤å€¼
      const token = await PreferencesUtil.pref.get(PreferencesUtil.KEY_TOKEN, '');
      return token as string;
    } catch (err) {
      return '';
    }
  }

  /**
   * ğŸ—‘ï¸ åˆ é™¤ Token (é€€å‡ºç™»å½•ç”¨)
   */
  static async deleteToken() {
    if (!PreferencesUtil.pref) return;
    try {
      await PreferencesUtil.pref.delete(PreferencesUtil.KEY_TOKEN);
      await PreferencesUtil.pref.flush(); // åˆ é™¤ä¹Ÿè¦ flush å“¦
      console.info('[PreferencesUtil] Token å·²é”€æ¯å–µï¼');
    } catch (err) {
      console.error('[PreferencesUtil] åˆ é™¤ Token å¤±è´¥å–µ');
    }
  }
}