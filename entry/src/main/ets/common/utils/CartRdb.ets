import { common } from '@kit.AbilityKit';
import { relationalStore, ValuesBucket } from '@kit.ArkData';
import { CartItem } from '../../model/entity/ShopModel';

/**
 * ğŸ›’ è´­ç‰©è½¦æ•°æ®åº“å·¥å…·ç±» (RDB)
 */
export class CartRdb {
  private static readonly DB_NAME = 'SkyDelivery.db';
  private static readonly TABLE_NAME = 'cart_item';
  private static rdbStore: relationalStore.RdbStore | null = null;
  // å»ºè¡¨è¯­å¥
  private static readonly SQL_CREATE_TABLE = `
    CREATE TABLE IF NOT EXISTS cart_item (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      shop_id INTEGER NOT NULL,
      dish_id INTEGER,
      setmeal_id INTEGER,
      name TEXT NOT NULL,
      image TEXT,
      price REAL NOT NULL,
      count INTEGER NOT NULL,
      flavors TEXT
    )
  `;

  /**
   * åˆå§‹åŒ–æ•°æ®åº“
   */
  static async init(context: common.UIAbilityContext) {
    if ( CartRdb.rdbStore ) {
      return;
    }

    const config: relationalStore.StoreConfig = {
      name: CartRdb.DB_NAME,
      securityLevel: relationalStore.SecurityLevel.S1
    };

    try {
      CartRdb.rdbStore = await relationalStore.getRdbStore(context, config);
      await CartRdb.rdbStore.executeSql(CartRdb.SQL_CREATE_TABLE);
      console.info('å–µï¼RDBæ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ ğŸ›’');
    } catch ( err ) {
      console.error('RDBåˆå§‹åŒ–å¤±è´¥', err);
    }
  }

  /**
   * è·å–æŒ‡å®šåº—é“ºçš„è´­ç‰©è½¦
   */
  static async getCartByShopId(shopId: number): Promise<CartItem[]> {
    if (!CartRdb.rdbStore ) {
      return [];
    }

    const predicates = new relationalStore.RdbPredicates(CartRdb.TABLE_NAME);
    predicates.equalTo('shop_id', shopId);

    const resultSet = await CartRdb.rdbStore.query(predicates);
    const items: CartItem[] = [];

    while ( resultSet.goToNextRow() ) {
      const item = new CartItem(
        resultSet.getLong(resultSet.getColumnIndex('dish_id')) || undefined,
        resultSet.getLong(resultSet.getColumnIndex('setmeal_id')) || undefined,
        resultSet.getString(resultSet.getColumnIndex('name')),
        resultSet.getString(resultSet.getColumnIndex('image')),
        resultSet.getDouble(resultSet.getColumnIndex('price')),
        resultSet.getLong(resultSet.getColumnIndex('count')),
        resultSet.getString(resultSet.getColumnIndex('flavors'))
      );
      items.push(item);
    }
    resultSet.close();
    return items;
  }

  /**
   * è·å–æ‰€æœ‰æœ‰å•†å“çš„åº—é“ºIDåŠå…¶å•†å“
   * ç”¨äº CartPage å±•ç¤ºå¤šåº—åˆ—è¡¨
   */
  static async getAllCarts(): Promise<Record<number, CartItem[]>> {
    if (!CartRdb.rdbStore ) {
      return {};
    }

    const predicates = new relationalStore.RdbPredicates(CartRdb.TABLE_NAME);
    // æŒ‰åº—é“ºæ’åºï¼Œæ–¹ä¾¿å¤„ç†
    predicates.orderByAsc('shop_id');

    const resultSet = await CartRdb.rdbStore.query(predicates);
    const result: Record<number, CartItem[]> = {};

    while ( resultSet.goToNextRow() ) {
      const shopId = resultSet.getLong(resultSet.getColumnIndex('shop_id'));

      const item = new CartItem(
        resultSet.getLong(resultSet.getColumnIndex('dish_id')) || undefined,
        resultSet.getLong(resultSet.getColumnIndex('setmeal_id')) || undefined,
        resultSet.getString(resultSet.getColumnIndex('name')),
        resultSet.getString(resultSet.getColumnIndex('image')),
        resultSet.getDouble(resultSet.getColumnIndex('price')),
        resultSet.getLong(resultSet.getColumnIndex('count')),
        resultSet.getString(resultSet.getColumnIndex('flavors'))
      );

      if (!result[shopId] ) {
        result[shopId] = [];
      }
      result[shopId].push(item);
    }
    resultSet.close();
    return result;
  }

  /**
   * æ·»åŠ æˆ–æ›´æ–°å•†å“
   */
  static async saveItem(shopId: number, item: CartItem): Promise<boolean> {
    if (!CartRdb.rdbStore ) {
      return false;
    }

    // 1. å…ˆæŸ¥è¯¢æ˜¯å¦å­˜åœ¨ (æ ¹æ® uniqueKey çš„é€»è¾‘ï¼šdishId/setmealId + flavors)
    const predicates = new relationalStore.RdbPredicates(CartRdb.TABLE_NAME);
    predicates.equalTo('shop_id', shopId);

    if ( item.dishId ) {
      predicates.equalTo('dish_id', item.dishId);
    } else {
      predicates.isNull('dish_id');
    }

    if ( item.setmealId ) {
      predicates.equalTo('setmeal_id', item.setmealId);
    } else {
      predicates.isNull('setmeal_id');
    }

    // flavors ä¸ºç©ºæ—¶ä¹Ÿè¦åŒ¹é…ç©ºå­—ç¬¦ä¸²æˆ–null
    predicates.equalTo('flavors', item.flavors || '');

    const resultSet = await CartRdb.rdbStore.query(predicates);

    const valueBucket: ValuesBucket = {
      'shop_id': shopId,
      'dish_id': item.dishId || null,
      'setmeal_id': item.setmealId || null,
      'name': item.name,
      'image': item.image,
      'price': item.price,
      'count': item.count,
      'flavors': item.flavors || ''
    };

    try {
      if ( resultSet.rowCount > 0 ) {
        // æ›´æ–°æ•°é‡
        await CartRdb.rdbStore.update(valueBucket, predicates);
      } else {
        // æ’å…¥æ–°è®°å½•
        await CartRdb.rdbStore.insert(CartRdb.TABLE_NAME, valueBucket);
      }
      return true;
    } catch ( e ) {
      console.error('ä¿å­˜è´­ç‰©è½¦å¤±è´¥', e);
      return false;
    } finally {
      resultSet.close();
    }
  }

  /**
   * åˆ é™¤å•†å“
   */
  static async deleteItem(shopId: number, item: CartItem): Promise<boolean> {
    if (!CartRdb.rdbStore ) {
      return false;
    }

    const predicates = new relationalStore.RdbPredicates(CartRdb.TABLE_NAME);
    predicates.equalTo('shop_id', shopId);

    if ( item.dishId ) {
      predicates.equalTo('dish_id', item.dishId);
    } else {
      predicates.isNull('dish_id');
    }

    if ( item.setmealId ) {
      predicates.equalTo('setmeal_id', item.setmealId);
    } else {
      predicates.isNull('setmeal_id');
    }

    predicates.equalTo('flavors', item.flavors || '');

    try {
      await CartRdb.rdbStore.delete(predicates);
      return true;
    } catch ( e ) {
      console.error('åˆ é™¤å•†å“å¤±è´¥', e);
      return false;
    }
  }

  /**
   * æ¸…ç©ºæŒ‡å®šåº—é“ºçš„è´­ç‰©è½¦
   */
  static async clearShopCart(shopId: number): Promise<boolean> {
    if (!CartRdb.rdbStore ) {
      return false;
    }
    const predicates = new relationalStore.RdbPredicates(CartRdb.TABLE_NAME);
    predicates.equalTo('shop_id', shopId);
    await CartRdb.rdbStore.delete(predicates);
    return true;
  }

  /**
   * æ¸…ç©ºæ‰€æœ‰è´­ç‰©è½¦
   */
  static async clearAll(): Promise<boolean> {
    if (!CartRdb.rdbStore ) {
      return false;
    }
    const predicates = new relationalStore.RdbPredicates(CartRdb.TABLE_NAME);
    await CartRdb.rdbStore.delete(predicates);
    return true;
  }
}
