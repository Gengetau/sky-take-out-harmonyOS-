# Meow外卖 - 商家端消息中心通信规范

## 1. 概述
本规范定义了商家端 App（SkyDelivery Admin）与后端服务器之间的消息通信标准。
消息系统主要用于：
1.  **订单提醒**：新订单、退单、催单等实时通知。
2.  **系统通知**：平台公告、审核结果等。
3.  **IM 私聊**：商家与用户、骑手之间的即时通讯。

---

## 2. WebSocket 实时通信

### 2.1 连接地址
*   **Protocol**: `ws` (测试环境) / `wss` (生产环境)
*   **URL Pattern**: `/ws/{sid}`
*   **Example**: `ws://localhost:8080/ws/S_1`

### 2.2 连接参数说明 (SID)
为了区分商家和普通用户，商家端连接时，**必须**在 `sid` 前添加 `S_` 前缀。

| 参数 | 说明 | 示例 | 备注 |
| :--- | :--- | :--- | :--- |
| `sid` | 会话标识 | `S_101` | 格式：`S_{shopId}`，例如店铺ID为101，则 sid 为 `S_101` |

> **注意**：连接建立时，建议在 HTTP Header 中携带 `token` 用于鉴权（虽然当前 WebSocket 握手拦截器主要依赖 SID，但带上 Token 是安全最佳实践）。

### 2.3 心跳机制 (Heartbeat)
为了防止连接因网络波动或 NAT 超时断开，客户端需维护心跳。
*   **机制**：客户端每隔 **30秒** 发送一次心跳包。
*   **心跳包内容**：`"PING"` (纯文本) 或 `{"type": 0}` (JSON，如果后端强制JSON格式)。
*   **后端响应**：忽略或返回 `"PONG"`。

---

## 3. 消息数据格式 (Packet Structure)

所有上下行消息均采用 JSON 格式。

### 3.1 基础数据模型 (MessageDTO)

```json
{
  "msgId": "uuid-string-123456",       // 消息唯一ID (用于去重/回执)
  "type": 2,                           // 消息类型 (见下表)
  "content": "您有新的订单，请及时处理", // 消息文本内容
  "orderId": 114514,                   // 关联订单ID (可选，用于跳转)
  "senderId": 0,                       // 发送者ID (系统=0, 用户=userId)
  "senderRole": 2,                     // 发送者角色 (0:用户, 1:商家, 2:系统)
  "senderName": "系统通知",             // 发送者显示名称
  "senderAvatar": "http://...",        // 发送者头像URL
  "receiverId": 1,                     // 接收店铺ID
  "receiverRole": 1,                   // 接收者角色 (商家=1)
  "timestamp": 1704240000000           // 发送时间戳 (毫秒)
}
```

### 3.2 消息类型枚举 (MessageConstant)

| 类型值 (type) | 常量名 | 说明 | 触发场景 |
| :--- | :--- | :--- | :--- |
| `1` | `SYSTEM_NOTIFICATION` | 系统通知 | 平台活动、违规提醒、结算通知 |
| `2` | `ORDER_NOTIFICATION` | 订单提醒 | **新订单**(语音播报)、用户退款、用户催单 |
| `3` | `PRIVATE_MESSAGE` | 私聊消息 | 用户咨询菜品、骑手联系商家 |

---

## 4. 业务场景示例

### 4.1 场景一：接收新订单提醒 (语音播报)
商家端收到此类消息时，应触发 "您有新的外卖订单" 语音播报，并弹出通知栏。

**Payload:**
```json
{
  "msgId": "gen-123-xyz",
  "type": 2, 
  "content": "您有新的订单，请及时处理",
  "orderId": 888,
  "senderId": 0,
  "senderRole": 2,
  "senderName": "Meow外卖系统",
  "timestamp": 1704241000000
}
```

### 4.2 场景二：回复用户私聊
商家在消息中心回复用户咨询。

**前端发送 (Client -> Server):**
*目标用户ID: 50*

```json
{
  "type": 3,
  "content": "亲，这个菜微辣的，如果不吃辣可以备注做免辣哦喵~",
  "receiverId": 50,
  "receiverRole": 0,  // 0 代表接收者是用户
  "orderId": null     // 如果是针对特定订单的咨询，可带上 orderId
}
```

**后端转发 (Server -> User):**
后端会自动补全 `senderId` (当前店铺ID) 和 `senderRole` (1)。

---

## 5. 离线消息与历史记录 (HTTP API)
*注：此部分依赖后端存储改造，App 端需预留接口调用位置。*

### 5.1 获取消息列表
*   **URL**: `GET /admin/app/message/list`
*   **Query Param**:
    *   `page`: 页码
    *   `pageSize`: 每页条数
    *   `type`: 消息类型 (可选，不传则查所有)
*   **Response**:
    ```json
    {
      "code": 1,
      "data": {
        "total": 100,
        "records": [ ...MessageDTO list... ]
      }
    }
    ```

### 5.2 标记消息已读
*   **URL**: `PUT /admin/app/message/read`
*   **Body**: `{ "ids": ["msg-id-1", "msg-id-2"] }`

---

## 6. 异常处理规范

1.  **连接断开**：
    *   App 进入后台超过一定时间，Socket 可能会被系统挂起或断开。
    *   **策略**：App 回到前台 (`onForeground`) 时，检查 Socket 状态，如果已断开则立即重连 (`reconnect`)。
    *   **指数退避**：重连失败时，采用 1s, 2s, 4s, 8s... 的间隔重试，避免风暴。

2.  **消息丢失兜底**：
    *   由于 WebSocket 是即时投递，断连期间的消息会丢失。
    *   **策略**：App 每次**重连成功后**，应主动调用 `GET /admin/app/message/list` 拉取最近的未读消息（需后端支持）。

---
*Generated by Nia (妮娅) - 2026-01-03*
