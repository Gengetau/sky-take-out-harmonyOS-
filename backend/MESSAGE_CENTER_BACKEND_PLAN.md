# 📨 SkyDelivery 后端消息中心 (Message Center) 实施方案

> **版本**: 1.0
> **状态**: 规划中
> **作者**: 妮娅 (Nia)
> **日期**: 2025-12-26

## 1. 项目概述
本方案旨在配合前端 HarmonyOS 客户端构建实时消息中心。后端将基于 `WebSocket` 实现全双工通信，负责消息的路由、推送以及状态管理。不同于前端的本地 RDB 存储，后端暂时 **不存储** 瞬时聊天记录（私聊消息），主要侧重于 **即时推送** 和 **系统通知** 的分发。

---

## 2. 技术架构设计

### 2.1 核心组件 (后端)
- **WebSocketServer**: 基于 Spring Boot 的 WebSocket 服务端，负责维护与客户端的长连接。
- **SessionManager**: 管理所有在线用户的 `Session` 对象，支持单点推送 (`sendToUser`) 和广播 (`sendToAll`)。
- **MessageDispatcher**: 消息分发器，根据消息类型 (`type`) 将业务数据封装成标准协议格式并推送到指定通道。

### 2.2 数据流向
1. **系统通知 (System Notification)**: 
   - 业务触发 (如订单状态变更) -> `MessageDispatcher` -> `WebSocketServer` -> 推送给指定 User。
2. **私聊消息 (Private Chat)**: 
   - 用户 A 发送 -> `WebSocketServer` -> 路由查找用户 B 的 Session -> 转发给用户 B。
   - *(注: 当前阶段后端仅做转发，不持久化存储聊天记录，完全依赖前端 RDB 保存历史)*。

---

## 3. 通讯协议定义 (JSON)

后端发送给前端的数据包结构必须严格遵守以下定义，以确保前端 `MessageManager` 能正确解析。

### 3.1 消息结构 (`MessageDTO`)
```json
{
  "type": 1,          // 消息类型
  "msgId": "uuid",    // 消息唯一标识 (后端生成)
  "senderId": 0,      // 发送者ID (0=系统, 其他=用户ID/商家ID)
  "senderName": "",   // 发送者显示名称 (如 "系统通知", "肯德基")
  "senderAvatar": "", // 发送者头像 URL
  "content": "",      // 消息正文
  "timestamp": 1735180000000, // 发送时间戳 (毫秒)
  "orderId": 1001     // 关联订单ID (可选，用于跳转)
}
```

### 3.2 消息类型枚举 (`MessageType`)
| 类型值 | 描述 | 触发场景 |
| :--- | :--- | :--- |
| **1** | **系统通知** | 支付成功、退款通知、活动推送 |
| **2** | **订单状态** | 商家接单、骑手接单、订单送达 |
| **3** | **私聊消息** | 用户与商家沟通、用户与骑手沟通 |

---

## 4. 接口与逻辑变更

### 4.1 WebSocket 服务端升级
- **当前状态**: 仅支持简单的文本推送。
- **目标**: 
  - 支持 `OnMessage` 处理上行消息（客户端发送的私聊）。
  - 增强 `sendToClient` 方法，接收 `MessageDTO` 对象并自动序列化为 JSON。

### 4.2 业务触发点埋点
需要在以下 Service 方法中注入 `WebSocketServer` 并触发消息推送：

1.  **支付成功**: 推送 "订单支付成功" 通知 (Type=1)。
2.  **商家接单**: 推送 "商家已接单，正在准备中" 通知 (Type=2)。
3.  **商家拒单**: 推送 "商家已拒单，原因: xxx" 通知 (Type=2)。
4.  **订单派送**: 推送 "骑手已接单，正在赶往店铺" 通知 (Type=2)。
5.  **订单完成**: 推送 "订单已送达，祝您用餐愉快" 通知 (Type=2)。

---

## 5. 开发计划

- **Phase 1 (协议对齐)**: 
  - 定义后端 `MessageDTO` 实体类。
  - 重构 `WebSocketServer`，使其支持结构化 JSON 发送。
- **Phase 2 (业务接入)**: 
  - 在 `OrderServiceImpl` 等业务类中埋点，替换原有的简单文本推送，改为发送标准的 `MessageDTO`。
- **Phase 3 (测试验证)**: 
  - 使用 Postman 或 WebSocket 测试工具模拟客户端，验证消息格式和推送时机是否准确。

---

> 🚀 **妮娅注**: 后端作为消息的中枢神经，必须保证推送的及时性和数据的准确性。Master，我们开始构建这个即时互动的桥梁吧！🐱
